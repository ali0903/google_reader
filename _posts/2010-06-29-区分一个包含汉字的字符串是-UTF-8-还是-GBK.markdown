---
layout: post
title:  "区分一个包含汉字的字符串是 UTF-8 还是 GBK"
date:   2010-06-29 15:35:25
author: 云风
categories: program
---

## 区分一个包含汉字的字符串是 UTF-8 还是 GBK
### by 云风
### at 2010-06-29 15:35:25
### original <http://blog.codingnow.com/2010/06/detect_utf-8_gbk.html>

<p>今天检查 svn 仓库，发现又有同学没按规定提交包含汉字的代码。我们规律，所有源文件中包含的汉字必须使用 UTF-8 编码方式，而不能使用 GBK 。</p>

<p>总这么人工检查也不是个事。所以我想写一个 svn 的钩子，在提交前检查。在仓库的 hooks/pre-commit.teml 加一行检查脚本应该就可以了。</p>

<p>我想用正则表达式匹配一下，可是想了想又觉得 UTF-8 和 GBK 的编码集有点交集，不太好做。btw, google 了一下，的确有人写过<a href="http://www.dnbcw.com/biancheng/php/hzko119744.html">特定编码的正则表达式</a>。</p>

<p>继续 google ，找到一篇跟我需求有点类似的文章<a href="http://www.kuqin.com/language/20071201/2740.html">UTF-8编码检测失败特例</a>。看了正文，觉得不太靠谱，然后继续看回复，觉得这方法可行。</p>

<p>然后定睛一看，原来文章是孟岩写的，回复是我自己三年多前回复在他的 blog 上的。 -_-</p>

        <p>打算还是自己写个小程序做检查，不用现成工具了。</p>

<p>具体算法复制回这里：</p>

<p>cloudwu 发表于2007-01-05 00:49:51  IP: 218.72.15.*</p>

<p>如果想区分一个完整的字符串是 GBK 还是 UTF8 其实蛮简单的。
虽然做不到 100% 有效，但也比上面的方法强许多。</p>

<p>UTF8 是兼容 ascii 的，所以 0~127 就和 ascii 完全一致了。</p>

<p>gbk 的第一字节是高位为 1 的，第 2 字节可能高位为 0 。这种情况一定是 gbk ，因为 UTF8 对 &gt;127 的编码一定每个字节高位为 1 。</p>

<p>另外，对于中文，UTF8 一定编码成 3 字节。（似乎亚洲文字都是，UTF8 中双字节好象只用于西方字符集）</p>

<p>所以型如 <code>110***** 10******</code> 的，我们一概看成 gbk/gb2312 编码。这就解决了“位”的问题。</p>

<p>汉字以及汉字标点（包括日文汉字等），在 UTF8 中一定被编码成：<code>1110**** 10****** 10******</code></p>

<p>连续汉字数量不是 3 的倍数的 gb2312 编码的汉字字符串一定不会被误认为 UTF8 。用了一些gbk 扩展字，或是插入了一些 ascii 符号的字符串也几乎不会被认为是 UTF8 。</p>

<p>一般说来，只要汉字稍微多几个，gbk 串被误认为 UTF8 的可能性极其低。（只需要默认不使用 UTF8 中双字节表示的字符）可能性低，这里还有另外一个原因。UTF8 中汉字编码的第一个字节是 <code>1110****</code>
，这处于汉字的 gb2312 中二级汉字（不常用汉字，区码从 11011000 开始）的编码空间。一般是一些生僻字才会碰上。</p>