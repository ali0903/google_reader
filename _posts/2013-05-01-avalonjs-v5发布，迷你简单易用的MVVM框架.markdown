---
layout: post
title:  "avalonjs v5发布，迷你简单易用的MVVM框架"
date:   2013-05-01 20:30:00
author: 司徒正美
categories: program
---

## avalonjs v5发布，迷你简单易用的MVVM框架
### by 司徒正美
### at 2013-05-01 20:30:00
### original <http://www.cnblogs.com/rubylouvre/archive/2013/05/01/3053469.html>

<p title="avalonjs">为了方便编写控件，本次升级就是整合了一个迷你的三百行的迷你jQuery进去。主要更新如下：</p><ul>   <li>添加强大的UI绑定与自定扫描功能，让你一行JS也不用写生成UI。UI绑定的格式为ms-ui-opts?=uiName。 opts为VM中的对象名，uiName为控件名，UI会自动寻找data-id的值作为ViewModel的ID，然后你就可以在avalon.models[id]得到它。UI控件会优先使用data-*的值来作为UI的配置项，设计基本同bootstrap。 </li>   <li>ms-controller绑定，功能同angular的ng-controller，指定某个区域由某个ViewModel负责，没有找就定义在它上方的ViewModel。可以参见该文。</li>   <li>ms-important绑定，指定某个区域<strong>只由某个ViewModel负责</strong>，没有就停止扫描。</li>   <li>ms-options功能大幅增强。</li>   <li>迷你版jQuery。</li></ul><p>现在应某些人的要求，列举一下API</p><hr><h3>静态方法与属性</h3><ul><li>mix(a,b)， 相当于jQuery.extend</li><li>models， 用于放置生成的ViewModel</li><li>log(s)， 打印日志</li> <li>error(s)，抛出异常</li> <li>ui， 用于放置组件</li> <li>ready(fn), domReady，将回调延迟到DOM树后才执行</li> <li>oneObject(str|array, val?)， 如果传入一个字符串则将它以逗号转换为一个字符串数组，否则一定要传字符串数组，第二个参数可选，为生成的对象的值。此方法是用于生成一个键名不一样，但键值都一样的对象。如{a:1,b:1,c:1,d:1}</li><li>type(obj), 返回传参的数据类型，值可能为Array, Date, Object, JSON, Number,String, Null, Undefined</li><li>range(start, end, step)，生成一个整数数组，功能与underscorejs或python的同名函数一致。</li><li>bind(el, type, fn, phase)，绑定事件，返回一个回调给你行卸载</li><li>unbind(el, type, fn, phase)，卸载事件</li><li>forEach，功能同jQuery.each， 都是索引值或键名在前，值或元素在后</li><li>define(id?, deps?, factory)，定义一个ViewModel</li><li>scan(element?, ViewModel?)，开始扫描DOM树，抽取绑定。</li></ul><h3>迷你jQuery对象</h3><p>要求传入一个元素节点或文档对象或window，你可以通过$().element, $()[0]再次访问到你传入的东西。它有以下原型方法。</p><ul><li>hasClass(cls)，判定有没有此类名</li><li>addClass(cls)，只有元素不存在时才添加此类名</li><li>remvoeClass(cls)，移除类名</li> <li>toggleClass(cls, state?),切换类名，如果第2个参数为布名，则根据它强行添加或删除类名 </li> <li>attr(name,value?)， 读写特性（此方法非常弱，直接使用setAttribute, getAttribute实现，没有做任何兼容性处理）</li> <li>data(name, value?)， 读写数据，使用HTML5的data-*特性实现。它会parse一下，让数据更为实现，思路同jQuery。</li> <li>removeData(name)， 移除数据</li><li>css(name,value?)，读写样式，这个兼容性做得很好，因为长达一百行，连HTML5的私有前缀都能你补上。</li><li>width(val?), 读写宽度，注意对隐藏元素没有处理。</li><li>height(val?), 读写高度，注意对隐藏元素没有处理。</li><li>bind(type, fn, phase)，绑定事件，这个没有做链式操作，目的是为了返回回调给你卸载。</li><li>unbind(type,fn, phase)，卸载事件。</li><li>val，读取表单元素的value值，功能同jQuery。</li><li>offset，取得元素在文档中的坐标，功能只实现了jQuery的一半，只能读不能写。</li></ul><h3>各种绑定</h3><ul><li>ms-html="str", 添加HTML</li><li>ms-class-xxx="boolean", 切换类名</li><li>ms-hover="className", 移上去时添加这类名，移出去掉。</li><li>ms-visible="boolean", 操作元素的style.display实现显示隐藏</li><li>ms-if="boolean", 决定是将此元素放出到DOM树还是移出</li><li>ms-each-el?="array", el用于下面的引用，不写默认为$data。在它的作用范围，你还可以访问$index得到其索引值，$first判定是否第一个元素，$last是否最后一个，$remove为一个方法，你执行它就会从数组中删除它，并将它作用的那一片元素都移出DOM树。</li><li>ms-model="property"，只能用于表单元素，与ViewModel中的某些字段双向绑定，它会偷偷绑定一些事件进行同步。情况与angular的ng-model相同。</li><li>ms-controller="ViewModelName"，指定一个ViewModel的作用范围</li><li>ms-important="ViewModelName"，指定这个区域只能由这个ViewModel来渲染</li><li>ms-skip，不对此元素及后代进行扫描绑定，保证原样输出。</li><li>ms-on-type="callback"，绑定一个事件，type为事件名，如ms-on-click="tick"。</li><li>ms-click="callback",ms-keypress="callback",ms-keydown="callback",ms-keyup="callback",ms-mousedown="callback"……等常用事件都做了一个快捷方式。</li><li>ms-disabled,ms-readyonly,ms-selected，ms-checked等布尔属性，根据属性值的情况决定添加与移除</li><li>ms-enabled="boolean"，与ms-disabled相反。</li><li>{{ expr }}, 插值表达式，与angular相同，可以使用“|filter(args1, args2)”的形式添加多个过滤器。 </li><li>ms-ui-opts?="name"，生成一个UI控件。opts为ViewModel中的一个对象属性，name为控件名。</li></ul><h3>ViewModel</h3><ul title="avalonjs"><li>与angular的要求一致，$开头的为框架所保留，由于在IE6-8中然后VBS实现，无法区分大小写，不要同一个ViewModel定义两个近似的方法名。</li><li>$id为ViewModle的名字</li><li>$events为一个对象，用于保存$watch方法的回调</li><li>$watch(prop, callback)，ViewModel只能通知它的视图进行更新，不能通知他在ViewModel的其他属性，对于监控属性，我们可能通过这方法实现兄弟间的通信。</li><li>$watch(prop,callback?)，停止通知</li><li>以$开头的属性，框架都不会将它转换为监控属性</li><li>放在$skipArray中的属性名，也不会转换为监控属性</li><li title="avalonjs">一个包含get与set的对象被认为是一个计算属性。</li><li>数组会转换为监控数组，只监控长短与排序引发的变化。</li></ul><p>大家可以到<a href="http://rubylouvre.github.io/mvvm/">这里</a>下载它或观看例子</p><p>新增的两个控件都是从jQuery插件改过来，一个由250行改到130行，一个由800行改到200行，MVVM的威力突显！</p><hr><p style="color:red">注意，v5中要求必须指定ms-controller或ms-important!</p><img src="http://www.cnblogs.com/rubylouvre/aggbug/3053469.html?type=1" width="1" height="1" alt=""><p><a href="http://www.cnblogs.com/rubylouvre/archive/2013/05/01/3053469.html">本文链接</a></p>