<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>码农干货系列【15】--Promise库Version6 - 【当耐特】</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/">Your New Jekyll Site</a></h1>
              <a class="extra" href="/">home</a>
            </div>

                <h2>码农干货系列【15】--Promise库Version6 - 【当耐特】</h2>
<p class="meta">29 Apr 2013</p>

<div class="post">
<h2>码农干货系列【15】--Promise库Version6 - 【当耐特】</h2>

<h3>by 【当耐特】</h3>

<h3>at 2013-04-28 17:58:00</h3>

<h3>original <a href="http://www.cnblogs.com/iamzhanglei/archive/2013/04/28/3049739.html">http://www.cnblogs.com/iamzhanglei/archive/2013/04/28/3049739.html</a></h3>

<p><strong>代码</strong></p>


<p>  <div>           (<span>function</span> (window) {              <span>var</span> Promise = <span>function</span> () {                  <span>this</span>.thens = [];              };              Promise.prototype = {                  resolve: <span>function</span> () {                      <span>if</span> (<span>this</span>.promiseArr) {                          <span>for</span> (<span>var</span> i = 0, j = <span>this</span>.promiseArr.length; i &lt; j; i++) {                              <span>this</span>.promiseArr[i].resolveCount++;                          }                          <span>if</span> (<span>this</span>.promiseArr[0].action !== <span>&quot;any&quot;</span>) {                              <span>if</span> (<span>this</span>.resolveCount !== <span>this</span>.promiseArr.length) {                                  <span>return</span>;                              }                          } <span>else</span> {                              <span>if</span> (<span>this</span>.resolveCount &gt; 1) {                                  <span>return</span>;                              }                          }                      }                         <span>var</span> t, n;                      <span>while</span> (t = <span>this</span>.thens.shift()) {                          <span>var</span> doneFn = t.done, action = t.action;                          <span>if</span> (t.alwaysCB &amp;&amp; !doneFn) {                              n = t.alwaysCB.apply(<span>null</span>, arguments);                              <span>if</span> (n instanceof Promise) {                                  n.thens = <span>this</span>.thens;                                  <span>break</span>;                              }                              <span>continue</span>;                          }                          <span>if</span> (doneFn.length &gt; 0) {                              <span>var</span> arr = [];                              <span>for</span> (<span>var</span> i = 0, j = doneFn.length; i &lt; j; i++) {                                  <span>var</span> m = doneFn[i].apply(<span>null</span>, arguments);                                  <span>if</span> (m instanceof Promise) {                                      m.thens = <span>this</span>.thens;                                      arr.push(m);                                  }                              }                                 <span>var</span> l = arr.length;                              <span>if</span> (l === 0) {                                  <span>continue</span>;                              } <span>else</span> {                                  <span>for</span> (<span>var</span> i = 0; i &lt; l; i++) {                                      arr[i].promiseArr = arr;                                      arr[i].action = action;                                      arr[i].resolveCount = 0;                                  }                                  <span>break</span>;                              }                          } <span>else</span> {                              n = doneFn.apply(<span>null</span>, arguments);                              <span>if</span> (n instanceof Promise) {                                  n.thens = <span>this</span>.thens;                                  <span>break</span>;                              }                              <span>continue</span>;                          }                         }                  },                     reject: <span>function</span> () {                      <span>if</span> (<span>this</span>.promiseArr &amp;&amp; <span>this</span>.promiseArr[0].action === <span>&quot;any&quot;</span>) {                          <span>if</span> (<span>this</span>.promiseArr[<span>this</span>.promiseArr.length - 1] !== <span>this</span>) {                              <span>return</span>;                          }                      }                      <span>var</span> t, n;                      <span>while</span> (t = <span>this</span>.thens.shift()) {                          <span>if</span> (t.fail) {                              n = t.fail.apply(<span>null</span>, arguments);                              <span>if</span> (n instanceof Promise) {                                  n.thens = <span>this</span>.thens;                                  <span>break</span>;                              }                              <span>continue</span>;                          } <span>else</span> {                              <span>if</span> (t.alwaysCB) {                                  n = t.alwaysCB.apply(<span>null</span>, arguments);                                  <span>if</span> (n instanceof Promise) {                                      n.thens = <span>this</span>.thens;                                      <span>break</span>;                                  }                                  <span>continue</span>;                              }                          }                          <span>break</span>;                      }                  },                     notify: <span>function</span> () {                      <span>var</span> t = <span>this</span>.thens[0];                      t.progress.apply(<span>null</span>, arguments);                  },                     then: <span>function</span> (done, fail, progress) {                      <span>this</span>.thens.push({ done: done, fail: fail, progress: progress });                      <span>return</span> <span>this</span>;                  },                     any: <span>function</span> (done, fail, progress) {                      <span>this</span>.thens.push({ done: done, fail: fail, progress: progress, action: <span>&quot;any&quot;</span> });                      <span>return</span> <span>this</span>;                  },                     done: <span>function</span> (done) {                      <span>if</span> (<span>this</span>.thens.length === 0 || <span>this</span>.thens[<span>this</span>.thens.length - 1].done || <span>this</span>.thens[<span>this</span>.thens.length - 1].alwaysCB) {                          <span>this</span>.thens.push({ done: done });                      } <span>else</span> {                          <span>this</span>.thens[<span>this</span>.thens.length - 1].done = done;                      }                      <span>return</span> <span>this</span>;                  },                     fail: <span>function</span> (fail) {                      <span>if</span> (<span>this</span>.thens.length === 0 || <span>this</span>.thens[<span>this</span>.thens.length - 1].fail || <span>this</span>.thens[<span>this</span>.thens.length - 1].alwaysCB) {                          <span>this</span>.thens.push({ fail: fail });                      } <span>else</span> {                          <span>this</span>.thens[<span>this</span>.thens.length - 1].fail = fail;                      }                      <span>return</span> <span>this</span>;                  },                     progress: <span>function</span> (progress) {                      <span>if</span> (<span>this</span>.thens.length === 0 || <span>this</span>.thens[<span>this</span>.thens.length - 1].progress) {                          <span>this</span>.thens.push({ progress: progress });                      } <span>else</span> {                          <span>this</span>.thens[<span>this</span>.thens.length - 1].progress = progress;                      }                      <span>return</span> <span>this</span>;                  },                     always: <span>function</span> (alwaysCB) {                      <span>if</span> (<span>this</span>.thens.length === 0 || <span>this</span>.thens[<span>this</span>.thens.length - 1].alwaysCB || <span>this</span>.thens[<span>this</span>.thens.length - 1].done || <span>this</span>.thens[<span>this</span>.thens.length - 1].fail) {                          <span>this</span>.thens.push({ alwaysCB: alwaysCB });                      } <span>else</span> {                          <span>this</span>.thens[<span>this</span>.thens.length - 1].alwaysCB = alwaysCB;                      }                      <span>return</span> <span>this</span>;                  }                 }                    window.Promise = <span>function</span> (prmsFn) {                        <span>if</span> (prmsFn) {                      <span>if</span> (prmsFn === <span>true</span>) {                          <span>var</span> prms = <span>new</span> Promise();                             setTimeout(<span>function</span> () {                              prms.resolve();                          }, 1)                             <span>return</span> prms;                      } <span>else</span> {                          <span>var</span> prms = prmsFn();                          <span>if</span> (prms instanceof Promise) <span>return</span> prms;                      }                  }                  <span>return</span> <span>new</span> Promise();                 };             }(window));</div><p></p><p><strong>更新</strong></p><blockquote>  <p>新增notify方法</p>  <p>新增progress方法</p>  <p>新增Promise()自动new、自动resolve、自动构造promise</p></blockquote><p><strong>使用</strong></p><div>          function asyncTask() {              var promise = Promise(), itv;              setTimeout(function () {                  clearInterval(itv);                  promise.resolve();              }, 3500)                 itv = setInterval(function () {                  promise.notify();              }, 100)              <span>return</span> promise;          }          function asyncTask2(aa) {              alert(aa)          }             Promise(asyncTask)              .then(function () {                  console.log(<span>&quot;finish&quot;</span>);              }, <span>null</span>, function () {                  console.log(<span>&quot;hanlding&quot;</span>);              }).then(function () {                  <span>return</span> asyncTask2(111);              });             <span>//Promise(true).then(asyncTask).done(function () {</span>          <span>//    console.log(&quot;finish&quot;);</span>          <span>//}).progress(function () {</span>          <span>//    console.log(&quot;hanlding&quot;);</span>          <span>//})</span>             <span>//Promise(true).then(asyncTask).then(function () {</span>          <span>//    console.log(&quot;finish&quot;);</span>          <span>//}, null, function () {</span>          <span>//    console.log(&quot;hanlding&quot;);</span>          //});</div><img src="http://www.cnblogs.com/iamzhanglei/aggbug/3049739.html?type=1" width="1" height="1" alt=""><br><p>本文链接：<a href="http://www.cnblogs.com/iamzhanglei/archive/2013/04/28/3049739.html">http://www.cnblogs.com/iamzhanglei/archive/2013/04/28/3049739.html</a>，转载请注明。</p></p>

</div>


            <div class="footer">
              <div class="contact">
                <p>
                  Your Name<br />
                  What You Are<br />
                  your@email.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/yourusername/">github.com/yourusername</a><br />
                  <a href="http://twitter.com/yourusername/">twitter.com/yourusername</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

    </body>
</html>
