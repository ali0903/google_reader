<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Erlang集群全联通问题及解决方案</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/google_reader/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/google_reader/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/google_reader/">Google Reader</a></h1>
              <a class="extra" href="/google_reader/">home</a>
            </div>

                <h2>Erlang集群全联通问题及解决方案</h2>
<p class="meta">2013-05-03 01:32</p>

<div class="post">
<h2>Erlang集群全联通问题及解决方案</h2>

<h3>by Yu Feng</h3>

<h3>at 2013-05-02 17:32:11</h3>

<h3>original <a href="http://www.udpwork.com/item/9756.html">http://www.udpwork.com/item/9756.html</a></h3>

<div><p><strong>原创文章，转载请注明：</strong>
转载自<a href="http://blog.yufeng.info/">系统技术非业余研究</a></p>
<p><strong>本文链接地址:</strong>
<a href="http://blog.yufeng.info/archives/2650">Erlang集群全联通问题及解决方案</a></p>
</div>


<p>Erlang的集群默认情况下是全联通的，也就是当一个节点加入集群的时候，介绍人会推荐集群里面所有的节点主动来和新加入的节点建立联系，
<br>
效果如下图：</p>


<p><a href="http://blog.yufeng.info/wp-content/uploads/2013/05/erlang_connect.jpg"><img src="http://blog.yufeng.info/wp-content/uploads/2013/05/erlang_connect.jpg" alt="erlang_connect"></a></p>


<p>具体点讲那就是net_kernel模块负责节点间的通道的建立、检查、断开并提供monitor_node语义。
<br>
摘抄 http://www.erlang.org/doc/man/erlang.html 如下：</p>


<blockquote><p>monitor_node(Node, Flag) -&gt; true
<br>
Types:
<br>
Node = node()
<br>
Flag = boolean()
<br>
Monitors the status of the node Node. If Flag is true, monitoring is turned on; if Flag is false, monitoring is turned off.</p>
<p>Making several calls to monitor_node(Node, true) for the same Node is not an error; it results in as many, completely independent, monitorings.</p>
<p>If Node fails or does not exist, the message {nodedown, Node} is delivered to the process. If a process has made two calls to monitor_node(Node, true) and Node terminates, two nodedown messages are delivered to the process. If there is no connection to Node, there will be an attempt to create one. If this fails, a nodedown message is delivered.</p>
<p>Nodes connected through hidden connections can be monitored as any other node.</p>
<p>Failure: badargif the local node is not alive.</p>
</blockquote>


<p>其他模块如global, pg2, mnesia都利用这个monitor_node提供的语义来实现更上层的逻辑。那么上面提到的引荐机制正是global模块实现的，它的目的是提供集群层面的名称和进程的映射关系，所以它需要全联通。</p>


<p>学过中学数学的同学都知道系统总的通道的数目是N*(N-1)/2, 随着N的增长，这个数目会急速上升，见下图。</p>


<p><a href="http://blog.yufeng.info/wp-content/uploads/2013/05/hidden_visible.jpg"><img src="http://blog.yufeng.info/wp-content/uploads/2013/05/hidden_visible.jpg" alt="hidden_visible"></a></p>


<p>这个对集群的规模有致命的破坏作用。 这么多链接需要耗用很多资源，更坏的是，erlang为了检测节点的存活，需要定期发心跳包来检查，一分钟一个tick, 这会造成大量的网络风暴。</p>


<p>那么我们如何来避免这个事情呢？
<br>

<br>
很简单，避免全联通，摘抄 http://www.erlang.org/doc/man/erl.html 如下：</p>


<blockquote><p>hidden
<br>
Starts the Erlang runtime system as a hidden node, if it is run as a distributed node. Hidden nodes always establish hidden connections to all other nodes except for nodes in the same global group. Hidden connections are not published on either of the connected nodes, i.e. neither of the connected nodes are part of the result from nodes/0 on the other node. See also hidden global groups, global_group(3).</p>
</blockquote>


<p>哈哈，一个参数就解决这个问题了。</p>


<p>但是且慢，这个参数的行为需要注意下。 hidden是or语义，也就是说当参与方只要有一个是hidden, 那么global模块就不会介绍别人来认识新加入的节点。 只要2个都不是hidden, 才会有正常的社交。</p>


<p>从<a href="https://github.com/leo-project/leofs/blob/master/rel/leo_manager/files/vm.args">leofs</a>摘抄一段配置：</p>


<blockquote><p>## set up the node with the -hidden flag
<br>
-hidden</p>
</blockquote>


<p>社区已经开始注意，并回避这个问题了，你呢？</p>


<p>小结：有些问题很小，但是影响很坏！</p>


<p>祝玩得开心！</p>


<div><p>Post Footer automatically generated by<a href="http://easwy.com/blog/wordpress/wp-posturl/">wp-posturl plugin</a>for wordpress.</p>
</div>


<pre><code>        &lt;div style="margin-top:8px;padding:6px 0;border-top:1px solid #3cf"&gt;
            &lt;div style="text-align:center;margin:16px 0;padding:6px;border:0px dashed #999;font-family:arial;font-size:26px;font-weight:bold"&gt;
&lt;a href="http://www.udpwork.com/item/9756.html#review_form" title="不喜欢" style="text-decoration:none"&gt;
    &lt;img src="http://www.udpwork.com//images/thumb_down24.gif" alt=""&gt;
    &lt;span style="color:#f33"&gt;0&lt;/span&gt;
&lt;/a&gt;
   
&lt;a href="http://www.udpwork.com/item/9756.html#review_form" title="喜欢" style="text-decoration:none"&gt;
    &lt;img src="http://www.udpwork.com//images/thumb_up24.gif" alt=""&gt;
    &lt;span style="color:#3c3"&gt;0&lt;/span&gt;
&lt;/a&gt;
</code></pre>

<p></div>              <p>
                    由 <a href="http://www.udpwork.com/">udpwork.com</a> 聚合
                    |
                    <a href="http://www.udpwork.com/item/9756.html#reviews">评论: 0</a>
                    |
                    <a href="http://www.jikenow.com/">要! 要! 即刻! Now!</a>
                </p>
            </div></p>

</div>


            <div class="footer">
              <div class="contact">
                <p>
                  Your Name<br />
                  What You Are<br />
                  your@email.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/lyuehh/">github.com/lyuehh</a><br />
                  <a href="http://twitter.com/lyuehh/">twitter.com/lyuehh</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

    </body>
</html>
