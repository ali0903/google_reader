<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>用node搭建简单smtp服务器</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/">Your New Jekyll Site</a></h1>
              <a class="extra" href="/">home</a>
            </div>

                <h2>用node搭建简单smtp服务器</h2>
<p class="meta">24 Jan 2013</p>

<div class="post">
<h2>用node搭建简单smtp服务器</h2>

<h3>by snoopyxdy</h3>

<h3>at 2013-01-24 13:31:48</h3>

<h3>original <a href="http://snoopyxdy.blog.163.com/blog/static/60117440201302403212169">http://snoopyxdy.blog.163.com/blog/static/60117440201302403212169</a></h3>

<div>最近在公司用node写了一个小程序，搭建一个简单的smtp服务器，用来接收邮件，然后根据邮件的收件人地址，再把内容分发到他rtx、手机短信和外网邮箱上。本来这个功能有个用python写的例子，全部代码不过80行。感叹python这门语言确实精练，而且第三方模块和参考资料比node要多，只需简单的import smtpd模块就可以轻松搞定了，对于MIME解析也只需要import email这个模块。<div><br></div><div>但是python做不到对email流的精准控制（可能是我不懂怎么弄，py高手别喷啊），而且最近一直在搞node，所以打算用node来实现整个工作流程，顺便也测试下1.0版本的rrestjs框架。</div><div><br></div><div>要完成作业，我们面临以下问题：</div><div>1、如何用node建立一个smtp服务器，监听25端口</div><div><span style="line-height:22px">2、如何对MIME流做解析，变成我们想要的subject，text，from，to等我们需要的东西</span></div><div>3、如何把邮件转发外网邮箱</div><div><br></div><div>问题1、</div><div>在谷歌了一阵子之后，我打算使用substack写的node-smtp-protocol模块，这哥们上次在hujs上见过，长头发很腼腆的一个男孩，他写的模块应该挺靠谱，再说万一有什么问题也方便联系的上他。</div><div>github地址：<a style="line-height:22px" rel="nofollow" href="https://github.com/substack/node-smtp-protocol">https://github.com/substack/node-smtp-protocol</a></div><div>例子挺简单：</div><div><pre><p>var smtp = require('smtp-protocol');</p><p>var server = smtp.createServer(function (req) {<br>   req.on('greeting', function (to, ack) {<br>   ack.accept();<br>  });<br>  req.on('from', function (to, ack) {<br>   ack.accept();<br>  });<br>  req.on('to', function (to, ack) {<br>   filter(to, ack);//过滤smtp请求    <br>  });<br>  req.on('message', function (stream, ack) {<br>   serial(stream, ack, req.to);<br>  });<br> });<br> server.listen(25);<br> console.log('starting mail server listen port 25.')</p></pre>这样我们就建立起来了一个smtp服务器了，我们监听了greeting，from，to和message事件，代码中的ack.accept代表返回状态码250，表示成功，而message则表示客户端开发发送email的body流。</div><div>如果在message之前的阶段你想阻拦这次回话，只需要调用 ack.reject()方法拦截掉即可。</div><div><br></div><div>搭建起来之后，我只需要用telnet ip 25命令连接上node smtp服务器，测试截屏如下：</div><div><br></div><div><div><img title="用node搭建简单smtp服务器 - snoopyxdy - snoopyxdy的博客" alt="用node搭建简单smtp服务器 - snoopyxdy - snoopyxdy的博客" style="margin:0 10px 0 0" src="http://img0.ph.126.net/LiR5_sgIflN8v0e190M1hg==/6597780051168523020.jpg"></div> </div><div>当中的^[[A这段无视，打错了，我们成功起来了一个smtp服务器了，当然我们可以在触发 to 或者 from 这些事件时做一下限制，只允许特定来源或者特定目标。</div><div><br></div><div>问题2、启动了mail服务器，但是我们对于mail的内容处理还停留在最原始的MIME格式流上，如何正确处理MIME流成为我们获取mail内容的关键问题了，很幸运，我找到了MailParser这个模块。</div><div>github地址：<a style="line-height:22px" rel="nofollow" href="https://github.com/andris9/mailparser">https://github.com/andris9/mailparser</a></div><div>这个模块使用起来更加简单，因为<span style="line-height:22px">node-smtp-protocol模块提供了stream流，所以我们只需写如下代码就可以解析它：</span></div><div><pre><div>var MailParser = require("mailparser").MailParser;</div><div><div>req.on('message', function (stream, ack) {</div><div><span>   </span><span style="line-height:22px">stream.pipe(mailparser);</span></div><div><span style="line-height:22px"><span>   </span></span>mailparser.on("end", function(mail_object){</div><div><span>    </span>console.log(<span style="line-height:22px">mail_object</span><span style="line-height:22px">);//这里就是解析好的mail格式</span></div><div><span>   </span>})</div><div>   ack.accept();</div><div><span>  </span>});</div></div><p></p></pre></div><div>下面我们做一个简单例子，我们用outlook填写一份测试邮件发往node smtp服务器</div><div><br></div><div><div><img title="用node搭建简单smtp服务器 - snoopyxdy - snoopyxdy的博客" alt="用node搭建简单smtp服务器 - snoopyxdy - snoopyxdy的博客" style="margin:0 10px 0 0" src="http://img7.ph.126.net/6UUwMRbbJTyO7seOQeJWZA==/6597769056052254037.jpg"></div><div><br></div><div>在node smtp服务器端输出如下格式的内容</div><div><img title="用node搭建简单smtp服务器 - snoopyxdy - snoopyxdy的博客" alt="用node搭建简单smtp服务器 - snoopyxdy - snoopyxdy的博客" style="margin:0 10px 0 0" src="http://img0.ph.126.net/qgmJIk9Emzgy-zjvva2LfQ==/6597354540169952960.jpg"></div>  <span style="line-height:22px"> </span></div><div><span style="font-family:monospace;line-height:22px;white-space:pre">MailParser做的相当的不错，还根据信息中的GBK编码，转换成了utf-8，防止了乱码的产生。</span></div><div><span style="font-family:monospace;line-height:22px;white-space:pre">这样问题2我们也圆满解决了，正确解析了MIME流的内容</span></div><div><span style="font-family:monospace;line-height:22px;white-space:pre"><br></span></div><div><font face="monospace"><span style="white-space:pre">问题3、似乎不是问题，就不多介绍了，使用 Nodemailer 可以很轻松的转发一封电子邮件，大家都用的很熟了。</span></font></div><div><font face="monospace"><span style="white-space:pre">github地址：</span></font><a style="line-height:22px" rel="nofollow" href="https://github.com/andris9/Nodemailer">https://github.com/andris9/Nodemailer</a></div><div><span style="line-height:22px"><br></span></div><div>完成作业了，似乎用node搭建一个简单smtp服务器不必python费多少劲，但是代码量比python要多出不少。</div><div>另外需要注意，在node smtp监听了25端口之前，可能需要把sendmail服务器关闭，否则会存在端口inuse错误。</div></div>


</div>


            <div class="footer">
              <div class="contact">
                <p>
                  Your Name<br />
                  What You Are<br />
                  your@email.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/yourusername/">github.com/yourusername</a><br />
                  <a href="http://twitter.com/yourusername/">twitter.com/yourusername</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

    </body>
</html>
