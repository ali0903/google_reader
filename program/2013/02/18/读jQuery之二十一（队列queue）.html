<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>读jQuery之二十一（队列queue）</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/">Your New Jekyll Site</a></h1>
              <a class="extra" href="/">home</a>
            </div>

                <h2>读jQuery之二十一（队列queue）</h2>
<p class="meta">18 Feb 2013</p>

<div class="post">
<h2>读jQuery之二十一（队列queue）</h2>

<h3>by snandy</h3>

<h3>at 2013-02-18 11:08:00</h3>

<h3>original <a href="http://www.cnblogs.com/snandy/archive/2013/02/18/2892749.html">http://www.cnblogs.com/snandy/archive/2013/02/18/2892749.html</a></h3>

<p>queue模块在jQuery中分在Effects中，搜索整个库会发现queue也仅在特效模块effects.js中被使用。jQuery抽取出独立的命名空间给queue，说明除了内部Effects模块使用外，客户端程序员可以充分发挥聪明才智使用queue来构建非动画API。</p>


<p><br><p>queue模块向外开放的API分别是</p><br><ul style="margin:0"><br><li>挂在$上的$.queue、$.dequeue、$.<em>queueHooks(仅内部)</li><br><li>挂在jQuery对象上的有queue、dequeue、delay、clearQueue、promise</li><br></ul><br><p> </p><br><p>按照jQuery的惯例，挂在$上的方法属于低级API，挂在jQuery对象上的才是经常使用的。</p><br><p>一般低级API是为高级API服务的，即 queue内部会使用$.queue， dequeue内部会使用$.dequeue。这里实际是实现为一个队列，$.queue是入列，$.dequeue是出列。</p><br><p> </p><br><p><strong>一、$.queue</strong></p><br><p>这个方法有两个作用，它既是setter，又是getter。第一个参数elem是DOM元素，第二个参数type是字符串，第三个参数data可以是function或数组。</p><br><p>1. 设置指定名字的queue</p><br><div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px"><br><pre>function cb1() {alert(1)}<br>function cb2() {alert(2)}<br>var arr = [cb1, cb2];<br><br>$.queue(el, 'mx', cb1); // 第三个参数为function<br>$.queue(el, 'xm', arr); // 第三个参数为数组<br></pre><br></div><br><p> </p><br><p>2. 这时可以取到存入的callbacks</p><br><div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px"><br><pre>var cbs1 = $.queue(el, 'mx'); // [cb1]<br>var cbs2 = $.queue(el, 'xm'); // [cb1, cb2]<br></pre><br></div><br><p> </p><br><p>$.queue内部使用 $.</em>data方法，将数据保存下来。默认type/queueName使用  &quot;fx&quot; + queue。$.queue的实现很简单，代码不过15行，即取缓存对象queue，如果不存在则初始化为一个空对象，然后将data存入，如果存在则直接将data push到数组中。</p><br><p> </p><br><p><strong>二、$.dequeue </strong></p><br><p>将回调函数出列执行，每调用一次仅出列一个，因此当回调有N个时，需要调用$.dequeue方法N次元素才全部出列。$.dequeue的第一个参数是dom元素，第二个参数是queueName</p><br><div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px"><br><pre>function ff1() {console.log(1)}<br>function ff2() {console.log(2)}<br>function ff3() {console.log(3)}<br><br>var p = $('p')[0];<br>$.queue(p, 'mx1', ff1);<br>$.queue(p, 'mx1', ff2);<br>$.queue(p, 'mx1', ff3);<br><br>// 每2秒调用一次$.dequeue，依次输出1,2,3<br>setInterval(function() {<br>$.dequeue(p, 'mx1') <br>}, 2000);<br></pre><br></div><br><p> 回调函数的上下文是dom元素，参数是next函数和hooks对象</p><br><div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px"><br><pre>var p = $('p')[0];<br>function func(next, hooks) {<br>   console.log(this);<br>   console.log(next);<br>   console.log(hooks);<br>}<br>$.queue(p, 'mx', func);<br>$.dequeue(p, 'mx'); // p, function, [object Object]<br></pre><br></div><br><p> </p><br><p>next内部仍然调用$.dequeue，这样可以接着执行队列中的下一个callback。$.dequeue里的hooks是当队列里所有的callback都执行完后(此时startLength为0)进行最后的一个清理工作，</p><br><div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px"><br><pre>if ( !startLength &amp;&amp; hooks ) {<br>hooks.empty.fire();<br>}<br></pre><br></div><br><p>hooks.empty是一个<a href="http://www.cnblogs.com/snandy/archive/2012/11/15/2770237.html">jQuery.Callbacks</a>对象，而它则是定义在$.<em>queueHooks里</p><br><div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px"><br><pre></em>queueHooks: function( elem, type ) {<br>var key = type + "queueHooks";<br>return jQuery.<em>data( elem, key ) || jQuery.</em>data( elem, key, {<br>empty: jQuery.Callbacks("once memory").add(function() {<br>jQuery.<em>removeData( elem, type + "queue" );<br>jQuery.</em>removeData( elem, key );<br>})<br>});<br>}<br></pre><br></div><br><p> </p><br><p>以上就是queue的全部了，本质是利用Array的push和shift来完成先进先出(First In First Out)，但这里有个缺陷，jQuery的queue从1.1开始就是为effects模块服务的，因此queue里存的都是function。个人觉得如果只存function，应该对data参数做个严格类型判断，如果不是function则抛异常。但目前的版本没有做严格判断，如果我存的不是function，这样dequeue时会报错。如下</p><br><div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px"><br><pre>var p = $('p')[0];<br>$.queue(p, 'mx1', {}); // 注意第三个参数是对象，非function<br>$.dequeue(p, 'mx1'); // fn.call 报错，因为fn不是function</pre><br></div><br><p> </p><br><p><strong>三、queue</strong></p><br><p>知道了$.queue，queue就很好理解了，它无非是内部调用了下$.queue。queue比$.queue 少了第一个参数，内部使用this代替第一个参数。</p><br><div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px"><br><pre>function ff1() {console.log(1)}<br>function ff2() {console.log(2)}<br>function ff3() {console.log(3)}<br><br>var $p = $('p');<br>$p.queue('mx', ff1);<br>$p.queue('mx', ff2);<br>$p.queue('mx', ff3);<br></pre><br></div><br><p>这样，三个function就入列了，列名是"mx"。 取队列元素只需传一个列名如"mx"</p><br><div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px"><br><pre>var queue = $p.queue('mx'); // [ff1, ff2, ff3]<br></pre><br></div><br><p> </p><br><p>还有个技巧就是，如果使用jQuery默认的队列"fx"，可以只传data</p><br><div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px"><br><pre>function ff1() {console.log(1)}<br>function ff2() {console.log(2)}<br>function ff3() {console.log(3)}<br>var $p = $('p');<br>$p.queue(ff1);<br>$p.queue(ff2);<br>$p.queue(ff3);<br></pre><br></div><br><p>另外一点，当使用默认列名"fx"时，它会调用$.dequeue出列执行下，源码如下</p><br><div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px"><br><pre>if ( type === &quot;fx&quot; &amp;&amp; queue[0] !== &quot;inprogress&quot; ) {<br>jQuery.dequeue( this, type );<br>}</pre><br></div><br><p> </p><br><p><strong>四、dequeue</strong></p><br><p>dequeue则更是未添加任何特殊处理，直接调用的$.dequeue，见源码</p><br><div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px"><br><pre>dequeue: function( type ) {<br>return this.each(function() {<br>jQuery.dequeue( this, type );<br>});<br>},<br></pre><br></div><br><p> </p><br><p><strong>五、delay</strong></p><br><p>delay用来延迟后续添加的callback的执行，第一个参数time是延迟时间(另可使用"slow"和"fast")，第二个是队列名。</p><br><div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px"><br><pre>function cb() {<br>    console.log(1);    <br>}<br>var $p = $('p');<br>$p.delay(2000, 'mx').queue('mx', cb); <br><br>$p.dequeue('mx'); // 2秒后输出1<br></pre><br></div><br><p>如果是这样</p><br><div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px"><br><pre>function ff1() {console.log(1)}<br>function ff2() {console.log(2)}<br><br>var $p = $('p');<br>$p.queue('mx', ff1);<br>$p.delay(4000, 'mx');<br>$p.queue('mx', ff2);<br><br>$p.dequeue('mx'); // 立即输出1<br>$p.dequeue('mx'); // 4秒后输出2<br></pre><br></div><br><p> </p><br><p><strong>六、clearQueue</strong></p><br><p>顾名思义，清空所有队列。没什么好说的，源码如下，直接使用一个空数组覆盖之前的数组队列了。</p><br><div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px"><br><pre>clearQueue: function( type ) {<br>return this.queue( type || "fx", [] );<br>},<br></pre><br></div><br><p>　　</p><br><p><strong>七、promise</strong></p><br><p>这个方法返回一个promise对象，promise对象既是前面提到的<a href="http://www.cnblogs.com/snandy/archive/2012/12/19/2812935.html">Deferred对象</a>的阉割版。你可以使用done、fail、progress添加，但不能触发。用在queue模块里有特殊意义，比如done它指queue里所有function都执行后才执行done添加的。如</p><br><div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px"><br><pre>function ff1() {<br>alert(1)<br>}<br>function ff2() {<br>alert(2)<br>}<br>function succ() {<br>alert('done')<br>}<br>$body = $('body')<br>$body.queue('mx', ff1);<br>$body.queue('mx', ff2);<br><br>var promise = $body.promise('mx');<br>promise.done(succ);<br><br>setInterval(function() {<br>$body.dequeue('mx') // 先弹出1,2，最后是"done"<br>}, 1500)<br></pre><br></div><br><p> </p><br><p>注：阅读版本为<a href="http://code.jquery.com/jquery-1.9.1.js">1.9.1</a></p><br><p> </p><img src="http://www.cnblogs.com/snandy/aggbug/2892749.html?type=1" width="1" height="1" alt=""><p><a href="http://www.cnblogs.com/snandy/archive/2013/02/18/2892749.html">本文链接</a></p></p>

</div>


            <div class="footer">
              <div class="contact">
                <p>
                  Your Name<br />
                  What You Are<br />
                  your@email.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/yourusername/">github.com/yourusername</a><br />
                  <a href="http://twitter.com/yourusername/">twitter.com/yourusername</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

    </body>
</html>
