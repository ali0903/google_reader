<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Web Worker多线程的研究</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/">Your New Jekyll Site</a></h1>
              <a class="extra" href="/">home</a>
            </div>

                <h2>Web Worker多线程的研究</h2>
<p class="meta">08 Jun 2013</p>

<div class="post">
<h2>Web Worker多线程的研究</h2>

<h3>by 月影</h3>

<h3>at 2013-06-07 17:04:41</h3>

<h3>original <a href="http://www.silverna.org/blog/?p=271">http://www.silverna.org/blog/?p=271</a></h3>

<p>HTML5支持了Web Worker这样的API，允许网页在安全的情况下执行多线程代码。不过Web Worker实际上受到很多限制，因为它无法真正意义上共享内存数据，只能通过消息来做状态通知，所以甚至不能称之为真正意义上的“多线程”。</p>


<p>Web Worker的接口使用起来很不方便，它基本上自带一个sandbox，在沙箱中跑一个独立的js文件，通过 postMessage和 onMessge来和主线程通信：</p>


<div><ol title="Double click to hide line number."><li><span style="color:Green">var</span><span style="color:Gray"> </span><span style="color:Blue">worker</span><span style="color:Gray"> = </span><span style="color:Green">new</span><span style="color:Gray"> </span><span style="color:Blue">Worker</span><span style="color:Olive">(</span><span style="color:#8b0000">&quot;</span><span style="color:Red">my.js</span><span style="color:#8b0000">&quot;</span><span style="color:Olive">)</span><span style="color:Gray">;</span></li>
<li><span style="color:Green">var</span><span style="color:Gray"> </span><span style="color:Blue">bundle</span><span style="color:Gray"> = </span><span style="color:Olive">{</span><span style="color:Blue">message</span><span style="color:Gray">:</span><span style="color:#8b0000">'</span><span style="color:Red">Hello world</span><span style="color:#8b0000">'</span><span style="color:Gray">, </span><span style="color:Blue">id</span><span style="color:Gray">:</span><span style="color:Maroon">1</span><span style="color:Olive">}</span><span style="color:Gray">;</span></li>
<li><span style="color:Blue">worker</span><span style="color:Gray">.</span><span style="color:Blue">postMessage</span><span style="color:Olive">(</span><span style="color:Blue">bundle</span><span style="color:Olive">)</span><span style="color:Gray">; </span><span style="color:#ffa500">//postMessage可以传一个可序列化的对象过去</span></li>
<li><span style="color:Blue">worker</span><span style="color:Gray">.</span><span style="color:Blue">onmessage</span><span style="color:Gray"> = </span><span style="color:Green">function</span><span style="color:Olive">(</span><span style="color:Blue">evt</span><span style="color:Olive">){</span></li>
<li><span style="color:Gray">    </span><span style="color:Blue">console</span><span style="color:Gray">.</span><span style="color:Blue">log</span><span style="color:Olive">(</span><span style="color:Blue">evt</span><span style="color:Gray">.</span><span style="color:Blue">data</span><span style="color:Olive">)</span><span style="color:Gray">;    </span><span style="color:#ffa500">//比较worker中传回来的对象和主线程中的对象</span></li>
<li><span style="color:Gray">    </span><span style="color:Blue">console</span><span style="color:Gray">.</span><span style="color:Blue">log</span><span style="color:Olive">(</span><span style="color:Blue">bundle</span><span style="color:Olive">)</span><span style="color:Gray">;  </span><span style="color:#ffa500">//{message:'Hello world', id:1}</span></li>
<li><span style="color:Olive">}</span></li></ol></div>


<div><ol title="Double click to hide line number."><li><span style="color:#ffa500">//in my.js</span></li>
<li><span style="color:Blue">onmessage</span><span style="color:Gray"> = </span><span style="color:Green">function</span><span style="color:Olive">(</span><span style="color:Blue">evt</span><span style="color:Olive">){</span></li>
<li><span style="color:Gray">    </span><span style="color:Green">var</span><span style="color:Gray"> </span><span style="color:Blue">data</span><span style="color:Gray"> = </span><span style="color:Blue">evt</span><span style="color:Gray">.</span><span style="color:Blue">data</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">    </span><span style="color:Blue">data</span><span style="color:Gray">.</span><span style="color:Blue">id</span><span style="color:Gray">++;</span></li>
<li><span style="color:Gray">    </span><span style="color:Blue">postMessage</span><span style="color:Olive">(</span><span style="color:Blue">data</span><span style="color:Olive">)</span><span style="color:Gray">; </span><span style="color:#ffa500">//{message:'Hello world', id:2}</span></li>
<li><span style="color:Olive">}</span></li></ol></div>


<p>得到的结果可以发现，线程中得到的data的id增加了，但是传回来之后，并没有改变主线程的bundle中的id，因此，<strong>线程中传递的对象实际上copy了一份</strong>，这样的话，线程并没有共享数据，避免了读写冲突，所以是安全的。保证线程安全的代价就是限制了在线程中操作主线程对象的能力。<br>
这样一个有限的多线程机制使用起来是很不方便的，我们当然希望Worker能够支持让代码看起来具有同时操作多线程的能力，例如，支持看起来像下面这个样子的代码：</p>


<div><ol title="Double click to hide line number."><li><span style="color:Green">var</span><span style="color:Gray"> </span><span style="color:Blue">worker</span><span style="color:Gray"> = </span><span style="color:Green">new</span><span style="color:Gray"> </span><span style="color:Blue">ThreadWorker</span><span style="color:Olive">(</span><span style="color:Blue">bundle</span><span style="color:Gray"> </span><span style="color:#ffa500">/*shared obj*/</span><span style="color:Olive">)</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray"> </span></li>
<li><span style="color:Blue">worker</span><span style="color:Gray">.</span><span style="color:Blue">run</span><span style="color:Olive">(</span><span style="color:Green">function</span><span style="color:Olive">(</span><span style="color:Blue">bundle</span><span style="color:Olive">){</span></li>
<li><span style="color:Gray">    </span><span style="color:#ffa500">//do sth in worker thread...</span></li>
<li><span style="color:Gray">    </span><span style="color:Green">this</span><span style="color:Gray">.</span><span style="color:Blue">runOnUiThread</span><span style="color:Olive">(</span><span style="color:Green">function</span><span style="color:Olive">(</span><span style="color:Blue">bundle</span><span style="color:Gray"> </span><span style="color:#ffa500">/*shared obj*/</span><span style="color:Olive">){</span></li>
<li><span style="color:Gray">        </span><span style="color:#ffa500">//do sth in main ui thread...</span></li>
<li><span style="color:Gray">    </span><span style="color:Olive">})</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">    </span><span style="color:#ffa500">//...</span></li>
<li><span style="color:Olive">})</span><span style="color:Gray">;</span></li></ol></div>


<p>这段代码里面，我们启动一个worker之后，能够让任意代码跑在worker中，并且当需要操作ui线程（比如读写dom）时，可以通过this.runOnUiThread回到主线程执行。<br>
那么如何实现这个机制呢？ 看下面的代码：</p>


<div><ol title="Double click to hide line number."><li><span style="color:Green">function</span><span style="color:Gray"> </span><span style="color:Blue">WorkerThread</span><span style="color:Olive">(</span><span style="color:Blue">sharedObj</span><span style="color:Olive">){</span></li>
<li><span style="color:Gray">    </span><span style="color:Green">this</span><span style="color:Gray">.</span><span style="color:Blue">_worker</span><span style="color:Gray"> = </span><span style="color:Green">new</span><span style="color:Gray"> </span><span style="color:Blue">Worker</span><span style="color:Olive">(</span><span style="color:#8b0000">&quot;</span><span style="color:Red">thread.js</span><span style="color:#8b0000">&quot;</span><span style="color:Olive">)</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">    </span><span style="color:Green">this</span><span style="color:Gray">.</span><span style="color:Blue">_completes</span><span style="color:Gray"> = </span><span style="color:Olive">{}</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">    </span><span style="color:Green">this</span><span style="color:Gray">.</span><span style="color:Blue">_task_id</span><span style="color:Gray"> = </span><span style="color:Maroon">0</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">    </span><span style="color:Green">this</span><span style="color:Gray">.</span><span style="color:Blue">sharedObj</span><span style="color:Gray"> = </span><span style="color:Blue">sharedObj</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray"> </span></li>
<li><span style="color:Gray">    </span><span style="color:Green">var</span><span style="color:Gray"> </span><span style="color:Blue">self</span><span style="color:Gray"> = </span><span style="color:Green">this</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">    </span><span style="color:Green">this</span><span style="color:Gray">.</span><span style="color:Blue">_worker</span><span style="color:Gray">.</span><span style="color:Blue">onmessage</span><span style="color:Gray"> = </span><span style="color:Green">function</span><span style="color:Olive">(</span><span style="color:Blue">evt</span><span style="color:Olive">){</span></li>
<li><span style="color:Gray">        </span><span style="color:Green">var</span><span style="color:Gray"> </span><span style="color:Blue">ret</span><span style="color:Gray"> = </span><span style="color:Blue">evt</span><span style="color:Gray">.</span><span style="color:Blue">data</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">        </span><span style="color:Green">if</span><span style="color:Olive">(</span><span style="color:Blue">ret</span><span style="color:Gray">.</span><span style="color:Blue">__UI_TASK__</span><span style="color:Olive">){</span></li>
<li><span style="color:Gray">            </span><span style="color:#ffa500">//run on ui task</span></li>
<li><span style="color:Gray">            </span><span style="color:Green">var</span><span style="color:Gray"> </span><span style="color:Blue">fn</span><span style="color:Gray"> = </span><span style="color:Olive">(</span><span style="color:Green">new</span><span style="color:Gray"> </span><span style="color:Teal">Function</span><span style="color:Olive">(</span><span style="color:#8b0000">&quot;</span><span style="color:Red">return </span><span style="color:#8b0000">&quot;</span><span style="color:Gray">+</span><span style="color:Blue">ret</span><span style="color:Gray">.</span><span style="color:Blue">__UI_TASK__</span><span style="color:Olive">))()</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">            </span><span style="color:Blue">fn</span><span style="color:Olive">(</span><span style="color:Blue">ret</span><span style="color:Gray">.</span><span style="color:Blue">sharedObj</span><span style="color:Olive">)</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">        </span><span style="color:Olive">}</span><span style="color:Green">else</span><span style="color:Olive">{</span></li>
<li><span style="color:Gray">            </span><span style="color:Blue">self</span><span style="color:Gray">.</span><span style="color:Blue">sharedObj</span><span style="color:Gray"> = </span><span style="color:Blue">ret</span><span style="color:Gray">.</span><span style="color:Blue">sharedObj</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">            </span><span style="color:Blue">self</span><span style="color:Gray">.</span><span style="color:Blue">_completes</span><span style="color:Olive">[</span><span style="color:Blue">ret</span><span style="color:Gray">.</span><span style="color:Blue">taskId</span><span style="color:Olive">](</span><span style="color:Blue">ret</span><span style="color:Olive">)</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">        </span><span style="color:Olive">}</span></li>
<li><span style="color:Gray">    </span><span style="color:Olive">}</span></li>
<li><span style="color:Olive">}</span></li>
<li><span style="color:Gray"> </span></li>
<li><span style="color:Blue">WorkerThread</span><span style="color:Gray">.</span><span style="color:Blue">prototype</span><span style="color:Gray">.</span><span style="color:Blue">run</span><span style="color:Gray"> = </span><span style="color:Green">function</span><span style="color:Olive">(</span><span style="color:Blue">task</span><span style="color:Gray">, </span><span style="color:Blue">complete</span><span style="color:Olive">){</span></li>
<li><span style="color:Gray">    </span><span style="color:Green">var</span><span style="color:Gray"> </span><span style="color:Blue">_task</span><span style="color:Gray"> = </span><span style="color:Olive">{</span><span style="color:Blue">__THREAD_TASK__</span><span style="color:Gray">:</span><span style="color:Blue">task</span><span style="color:Gray">.</span><span style="color:Blue">toString</span><span style="color:Olive">()</span><span style="color:Gray">, </span><span style="color:Blue">sharedObj</span><span style="color:Gray">: </span><span style="color:Green">this</span><span style="color:Gray">.</span><span style="color:Blue">sharedObj</span><span style="color:Gray">, </span><span style="color:Blue">taskId</span><span style="color:Gray">: </span><span style="color:Green">this</span><span style="color:Gray">.</span><span style="color:Blue">_task_id</span><span style="color:Olive">}</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">    </span><span style="color:Green">this</span><span style="color:Gray">.</span><span style="color:Blue">_completes</span><span style="color:Olive">[</span><span style="color:Green">this</span><span style="color:Gray">.</span><span style="color:Blue">_task_id</span><span style="color:Gray">++</span><span style="color:Olive">]</span><span style="color:Gray"> = </span><span style="color:Blue">complete</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">    </span><span style="color:Green">this</span><span style="color:Gray">.</span><span style="color:Blue">_worker</span><span style="color:Gray">.</span><span style="color:Blue">postMessage</span><span style="color:Olive">(</span><span style="color:Blue">_task</span><span style="color:Olive">)</span><span style="color:Gray">;</span></li>
<li><span style="color:Olive">}</span></li></ol></div>


<p>上面这段代码定义了一个ThreadWorker对象，这个对象创建了一个运行thread.js的Web Worker，保存了共享对象SharedObj，并且对thread.js发回的消息进行处理。<br>
如果thread.js中传回了一个__UI_TASK__消息，那么运行这个消息传过来的function，否则执行run的complete回调<br>
我们看看thread.js是怎么写的：</p>


<div><ol title="Double click to hide line number."><li><span style="color:Blue">onmessage</span><span style="color:Gray"> = </span><span style="color:Green">function</span><span style="color:Olive">(</span><span style="color:Blue">evt</span><span style="color:Olive">){</span></li>
<li><span style="color:Gray">    </span><span style="color:Green">var</span><span style="color:Gray"> </span><span style="color:Blue">data</span><span style="color:Gray"> = </span><span style="color:Blue">evt</span><span style="color:Gray">.</span><span style="color:Blue">data</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray"> </span></li>
<li><span style="color:Gray">    </span><span style="color:Green">if</span><span style="color:Olive">(</span><span style="color:Blue">data</span><span style="color:Gray"> &amp;&amp; </span><span style="color:Blue">data</span><span style="color:Gray">.</span><span style="color:Blue">__THREAD_TASK__</span><span style="color:Olive">){</span></li>
<li><span style="color:Gray">        </span><span style="color:Green">var</span><span style="color:Gray"> </span><span style="color:Blue">task</span><span style="color:Gray"> = </span><span style="color:Blue">data</span><span style="color:Gray">.</span><span style="color:Blue">__THREAD_TASK__</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">        </span><span style="color:Green">try</span><span style="color:Olive">{</span></li>
<li><span style="color:Gray">            </span><span style="color:Green">var</span><span style="color:Gray"> </span><span style="color:Blue">fn</span><span style="color:Gray"> = </span><span style="color:Olive">(</span><span style="color:Green">new</span><span style="color:Gray"> </span><span style="color:Teal">Function</span><span style="color:Olive">(</span><span style="color:#8b0000">&quot;</span><span style="color:Red">return </span><span style="color:#8b0000">&quot;</span><span style="color:Gray">+</span><span style="color:Blue">task</span><span style="color:Olive">))()</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray"> </span></li>
<li><span style="color:Gray">            </span><span style="color:Green">var</span><span style="color:Gray"> </span><span style="color:Blue">ctx</span><span style="color:Gray"> = </span><span style="color:Olive">{</span></li>
<li><span style="color:Gray">                </span><span style="color:Blue">threadSignal</span><span style="color:Gray">: </span><span style="color:Green">true</span><span style="color:Gray">,</span></li>
<li><span style="color:Gray">                </span><span style="color:Blue">sleep</span><span style="color:Gray">: </span><span style="color:Green">function</span><span style="color:Olive">(</span><span style="color:Blue">interval</span><span style="color:Olive">){</span></li>
<li><span style="color:Gray">                    </span><span style="color:Blue">ctx</span><span style="color:Gray">.</span><span style="color:Blue">threadSignal</span><span style="color:Gray"> = </span><span style="color:Green">false</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">                    </span><span style="color:Blue">setTimeout</span><span style="color:Olive">(</span><span style="color:Blue">_run</span><span style="color:Gray">, </span><span style="color:Blue">interval</span><span style="color:Olive">)</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">                </span><span style="color:Olive">}</span><span style="color:Gray">,</span></li>
<li><span style="color:Gray">                </span><span style="color:Blue">runOnUiThread</span><span style="color:Gray">: </span><span style="color:Green">function</span><span style="color:Olive">(</span><span style="color:Blue">task</span><span style="color:Olive">){</span></li>
<li><span style="color:Gray">                    </span><span style="color:Blue">postMessage</span><span style="color:Olive">({</span><span style="color:Blue">__UI_TASK__</span><span style="color:Gray">:</span><span style="color:Blue">task</span><span style="color:Gray">.</span><span style="color:Blue">toString</span><span style="color:Olive">()</span><span style="color:Gray">, </span><span style="color:Blue">sharedObj</span><span style="color:Gray">:</span><span style="color:Blue">data</span><span style="color:Gray">.</span><span style="color:Blue">sharedObj</span><span style="color:Olive">})</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">                </span><span style="color:Olive">}</span></li>
<li><span style="color:Gray">            </span><span style="color:Olive">}</span></li>
<li><span style="color:Gray"> </span></li>
<li><span style="color:Gray">            </span><span style="color:Green">function</span><span style="color:Gray"> </span><span style="color:Blue">_run</span><span style="color:Olive">(){</span></li>
<li><span style="color:Gray">                </span><span style="color:Blue">ctx</span><span style="color:Gray">.</span><span style="color:Blue">threadSignal</span><span style="color:Gray"> = </span><span style="color:Green">true</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">                </span><span style="color:Green">var</span><span style="color:Gray"> </span><span style="color:Blue">ret</span><span style="color:Gray"> = </span><span style="color:Blue">fn</span><span style="color:Gray">.</span><span style="color:Blue">call</span><span style="color:Olive">(</span><span style="color:Blue">ctx</span><span style="color:Gray">, </span><span style="color:Blue">data</span><span style="color:Gray">.</span><span style="color:Blue">sharedObj</span><span style="color:Olive">)</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">                </span><span style="color:Blue">postMessage</span><span style="color:Olive">({</span><span style="color:Blue">error</span><span style="color:Gray">:</span><span style="color:Green">null</span><span style="color:Gray">, </span><span style="color:Blue">returnValue</span><span style="color:Gray">:</span><span style="color:Blue">ret</span><span style="color:Gray">, </span><span style="color:Blue">__THREAD_TASK__</span><span style="color:Gray">:</span><span style="color:Blue">task</span><span style="color:Gray">, </span><span style="color:Blue">sharedObj</span><span style="color:Gray">:</span><span style="color:Blue">data</span><span style="color:Gray">.</span><span style="color:Blue">sharedObj</span><span style="color:Gray">, </span><span style="color:Blue">taskId</span><span style="color:Gray">: </span><span style="color:Blue">data</span><span style="color:Gray">.</span><span style="color:Blue">taskId</span><span style="color:Olive">})</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">            </span><span style="color:Olive">}</span></li>
<li><span style="color:Gray"> </span></li>
<li><span style="color:Gray">            </span><span style="color:Blue">_run</span><span style="color:Olive">(</span><span style="color:Maroon">0</span><span style="color:Olive">)</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray"> </span></li>
<li><span style="color:Gray">        </span><span style="color:Olive">}</span><span style="color:Green">catch</span><span style="color:Olive">(</span><span style="color:Blue">ex</span><span style="color:Olive">){</span></li>
<li><span style="color:Gray">            </span><span style="color:Blue">postMessage</span><span style="color:Olive">({</span><span style="color:Blue">error</span><span style="color:Gray">:</span><span style="color:Blue">ex</span><span style="color:Gray">.</span><span style="color:Blue">toString</span><span style="color:Olive">()</span><span style="color:Gray"> , </span><span style="color:Blue">returnValue</span><span style="color:Gray">:</span><span style="color:Green">null</span><span style="color:Gray">, </span><span style="color:Blue">sharedObj</span><span style="color:Gray">: </span><span style="color:Blue">data</span><span style="color:Gray">.</span><span style="color:Blue">sharedObj</span><span style="color:Olive">})</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">        </span><span style="color:Olive">}</span></li>
<li><span style="color:Gray">    </span><span style="color:Olive">}</span></li>
<li><span style="color:Olive">}</span></li></ol></div>


<p>可以看到，thread.js接收ui线程传过来的消息，其中最重要的是__THREAD_TASK__，这是ui线程传过来的需要worker线程执行的“任务”，由于function是不可序列化的，因此传递的是字符串，worker线程通过解析字符串成function来执行主线程提交的任务（注意在任务中将共享对象sharedObj传入），执行完成后将返回结果通过message传给ui线程。我们仔细看一下除了返回值returnValue以外，共享对象sharedObj也会被传回，传回时，由于worker线程和ui线程并不共享对象，因此我们人为通过赋值的方式同步两边的对象（这样是否线程安全？为什么？）<br>
可以看到整个过程其实并不复杂，这么实现之后，这个ThreadWorker可以有以下两种用法：</p>


<div><ol title="Double click to hide line number."><li><span style="color:Green">var</span><span style="color:Gray"> </span><span style="color:Blue">t1</span><span style="color:Gray"> = </span><span style="color:Green">new</span><span style="color:Gray"> </span><span style="color:Blue">WorkerThread</span><span style="color:Olive">({</span><span style="color:Blue">i</span><span style="color:Gray">: </span><span style="color:Maroon">100</span><span style="color:Olive">}</span><span style="color:Gray"> </span><span style="color:#ffa500">/*shared obj*/</span><span style="color:Olive">)</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray"> </span></li>
<li><span style="color:Gray">        </span><span style="color:Blue">setInterval</span><span style="color:Olive">(</span><span style="color:Green">function</span><span style="color:Olive">(){</span></li>
<li><span style="color:Gray">            </span><span style="color:Blue">t1</span><span style="color:Gray">.</span><span style="color:Blue">run</span><span style="color:Olive">(</span><span style="color:Green">function</span><span style="color:Olive">(</span><span style="color:Blue">sharedObj</span><span style="color:Olive">){</span></li>
<li><span style="color:Gray">                    </span><span style="color:Green">return</span><span style="color:Gray"> </span><span style="color:Blue">sharedObj</span><span style="color:Gray">.</span><span style="color:Blue">i</span><span style="color:Gray">++;</span></li>
<li><span style="color:Gray">                </span><span style="color:Olive">}</span><span style="color:Gray">,</span></li>
<li><span style="color:Gray">                </span><span style="color:Green">function</span><span style="color:Olive">(</span><span style="color:Blue">r</span><span style="color:Olive">){</span></li>
<li><span style="color:Gray">                    </span><span style="color:Blue">console</span><span style="color:Gray">.</span><span style="color:Blue">log</span><span style="color:Olive">(</span><span style="color:#8b0000">&quot;</span><span style="color:Red">t1&gt;</span><span style="color:#8b0000">&quot;</span><span style="color:Gray"> + </span><span style="color:Blue">r</span><span style="color:Gray">.</span><span style="color:Blue">returnValue</span><span style="color:Gray"> + </span><span style="color:#8b0000">&quot;</span><span style="color:Red">:</span><span style="color:#8b0000">&quot;</span><span style="color:Gray"> + </span><span style="color:Blue">r</span><span style="color:Gray">.</span><span style="color:Blue">error</span><span style="color:Olive">)</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">                </span><span style="color:Olive">}</span></li>
<li><span style="color:Gray">            </span><span style="color:Olive">)</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">        </span><span style="color:Olive">}</span><span style="color:Gray">, </span><span style="color:Maroon">500</span><span style="color:Olive">)</span><span style="color:Gray">;</span></li></ol></div>


<div><ol title="Double click to hide line number."><li><span style="color:Green">var</span><span style="color:Gray"> </span><span style="color:Blue">t2</span><span style="color:Gray"> = </span><span style="color:Green">new</span><span style="color:Gray"> </span><span style="color:Blue">WorkerThread</span><span style="color:Olive">({</span><span style="color:Blue">i</span><span style="color:Gray">: </span><span style="color:Maroon">50</span><span style="color:Olive">})</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">        </span></li>
<li><span style="color:Gray">        </span><span style="color:Blue">t2</span><span style="color:Gray">.</span><span style="color:Blue">run</span><span style="color:Olive">(</span><span style="color:Green">function</span><span style="color:Olive">(</span><span style="color:Blue">sharedObj</span><span style="color:Olive">){</span><span style="color:Gray">    </span></li>
<li><span style="color:Gray">            </span><span style="color:Green">while</span><span style="color:Olive">(</span><span style="color:Green">this</span><span style="color:Gray">.</span><span style="color:Blue">threadSignal</span><span style="color:Olive">){</span></li>
<li><span style="color:Gray">                </span><span style="color:Blue">sharedObj</span><span style="color:Gray">.</span><span style="color:Blue">i</span><span style="color:Gray">++;</span></li>
<li><span style="color:Gray"> </span></li>
<li><span style="color:Gray">                </span><span style="color:Green">this</span><span style="color:Gray">.</span><span style="color:Blue">runOnUiThread</span><span style="color:Olive">(</span><span style="color:Green">function</span><span style="color:Olive">(</span><span style="color:Blue">sharedObj</span><span style="color:Olive">){</span></li>
<li><span style="color:Gray">                    </span><span style="color:Blue">W</span><span style="color:Olive">(</span><span style="color:#8b0000">&quot;</span><span style="color:Red">body ul</span><span style="color:#8b0000">&quot;</span><span style="color:Olive">)</span><span style="color:Gray">.</span><span style="color:Blue">appendChild</span><span style="color:Olive">(</span><span style="color:#8b0000">&quot;</span><span style="color:Red">&lt;li&gt;</span><span style="color:#8b0000">&quot;</span><span style="color:Gray">+</span><span style="color:Blue">sharedObj</span><span style="color:Gray">.</span><span style="color:Blue">i</span><span style="color:Gray">+</span><span style="color:#8b0000">&quot;</span><span style="color:Red">&lt;/li&gt;</span><span style="color:#8b0000">&quot;</span><span style="color:Olive">)</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">                </span><span style="color:Olive">})</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">                </span></li>
<li><span style="color:Gray">                </span><span style="color:Green">this</span><span style="color:Gray">.</span><span style="color:Blue">sleep</span><span style="color:Olive">(</span><span style="color:Maroon">500</span><span style="color:Olive">)</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">            </span><span style="color:Olive">}</span></li>
<li><span style="color:Gray">            </span><span style="color:Green">return</span><span style="color:Gray"> </span><span style="color:Blue">sharedObj</span><span style="color:Gray">.</span><span style="color:Blue">i</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">        </span><span style="color:Olive">}</span><span style="color:Gray">, </span><span style="color:Green">function</span><span style="color:Olive">(</span><span style="color:Blue">r</span><span style="color:Olive">){</span></li>
<li><span style="color:Gray">            </span><span style="color:Blue">console</span><span style="color:Gray">.</span><span style="color:Blue">log</span><span style="color:Olive">(</span><span style="color:#8b0000">&quot;</span><span style="color:Red">t2&gt;</span><span style="color:#8b0000">&quot;</span><span style="color:Gray"> + </span><span style="color:Blue">r</span><span style="color:Gray">.</span><span style="color:Blue">returnValue</span><span style="color:Gray"> + </span><span style="color:#8b0000">&quot;</span><span style="color:Red">:</span><span style="color:#8b0000">&quot;</span><span style="color:Gray"> + </span><span style="color:Blue">r</span><span style="color:Gray">.</span><span style="color:Blue">error</span><span style="color:Olive">)</span><span style="color:Gray">;</span></li>
<li><span style="color:Gray">        </span><span style="color:Olive">})</span><span style="color:Gray">;</span></li></ol></div>


<p>这样的用法从形式和语义上来说都让代码具有良好的结构，灵活性和可维护性。</p>


<p>好了，关于Web Worker的用法探讨就介绍到这里，有兴趣的同学可以去看一下这个项目：https://github.com/akira-cn/WorkerThread.js (由于Worker需要用服务器测试，我特意在项目中放了一个山寨的httpd.js，是个非常简陋的http服务的js，直接用node就可以跑起来）。</p>


<p><a href="http://www.silverna.org/blog/?p=271">继续阅读 »</a></p>


</div>


            <div class="footer">
              <div class="contact">
                <p>
                  Your Name<br />
                  What You Are<br />
                  your@email.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/yourusername/">github.com/yourusername</a><br />
                  <a href="http://twitter.com/yourusername/">twitter.com/yourusername</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

    </body>
</html>
