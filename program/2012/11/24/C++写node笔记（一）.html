<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>C++写node笔记（一）</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/google_reader/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/google_reader/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/google_reader/">Google Reader</a></h1>
              <a class="extra" href="/google_reader/">home</a>
            </div>

                <h2>C++写node笔记（一）</h2>
<p class="meta">2012-11-24 06:33</p>

<div class="post">
<h2>C++写node笔记（一）</h2>

<h3>by snoopyxdy</h3>

<h3>at 2012-11-23 22:33:33</h3>

<h3>original <a href="http://snoopyxdy.blog.163.com/blog/static/601174402012102391344617">http://snoopyxdy.blog.163.com/blog/static/601174402012102391344617</a></h3>

<div>最近恶补了c++知识，为了给node.js写一些addon插件，提高node.js的运行速度。本笔记主要介绍了如何简单部署生成一个node的c++模块。<div><br></div><div><b>一、安装编译</b></div><div>以下是在linux安装过程</div><div>1、第一步当然是先安装node.jsv0.8+的版本</div><div>2、安装node-gyp模块 npm install -g node-gyp</div><div>3、安装python2.7.3，具体安装python请参阅我的另外篇博客（<a href="http://snoopyxdy.blog.163.com/blog/static/601174402012527112146199/">centOS安装node.js-v0.8.0 </a> ）<a rel="nofollow" href="http://www.python.org/download/releases/2.7.3/#download">python2.7.3下载地址</a></div><div>4、新建一个目录，创建hello.cc文件，然后创建binding.gyp文件：</div><div>hello.cc</div><div><pre><p>#include &lt;node.h&gt;<br>#include &lt;v8.h&gt;<br><br>using namespace v8;<br><br>Handle&lt;Value&gt; Method(const Arguments&amp; args) {<br>  HandleScope scope;<br>  return scope.Close(String::New("world"));<br>}<br><br>void init(Handle&lt;Object&gt; target) {<br>  target-&gt;Set(String::NewSymbol(&quot;hello&quot;),<br>      FunctionTemplate::New(Method)-&gt;GetFunction());<br>}<br>NODE_MODULE(hello, init)</p></pre><span style="line-height:22px">binding.gyp文件：</span></div><div><pre><p>{<br>  "targets": [<br>    {<br>      "target_name": "hello",<br>      "sources": [ "hello.cc" ]<br>    }<br>  ]<br>}</p></pre>接着执行</div><div>node-gyp configure</div><div>然后执行</div><div>node-gyp build</div><div>如果报找不到<span style="line-height:22px">binding.gyp的错误，只要把</span><span style="line-height:22px">binding.gyp拷贝到build文件目录下即可</span></div><div><span style="line-height:22px"><br></span></div><div><span style="line-height:22px">这样我们就成功的生成了hello.node这个2进制文件了。</span></div><div><span style="line-height:22px">我们可以这样调用这个文件：</span></div><div><pre><p>var hello = require('./addon/build/Release/hello.node').hello();<br>console.log(hello); //这里打印world字符串</p></pre><br></div><div><b>二、测试</b></div><div>具体hello.cc的内容我目前还在看v8接口，也是略懂一二不敢再这里详细解说，怕误人子弟啊，我现在做一个简单的测试，看看用C++编译的模块和node哪个执行速度更快一些。</div><div>测试用例：循环执行1千万次，每次把 i 除以2然后再累加起来。</div><div>构建for.js</div><div><pre><p>console.time('for');<br>var j=0;<br>for(var i=0;i&lt;10000000;i++){<br> j += i/2;<br>}<br>console.log(j)<br>console.timeEnd('for');</p></pre>执行结果：node.js用时50毫秒</div><div><pre><p>24999997500000<br>for: 50ms</p></pre></div><div>接着我们依葫芦画瓢，把hello.cc改写下，然后用<span style="line-height:22px">node-gyp build重新生成</span></div><div><pre><p>#include &lt;node.h&gt;<br>#include &lt;v8.h&gt;<br><br>using namespace v8;<br><br>float forfunc(){<br>  float i,j=0;<br>  for(i=0;i&lt;10000000;i++){<br> j += i/2;<br>  };<br>  return j;<br>}<br><br><br>void init(Handle&lt;Object&gt; target) {<br>  float j;<br>  j = forfunc();<br>  target-&gt;Set(String::NewSymbol(&quot;hello&quot;),Number::New(j));<br><br>}<br>NODE_MODULE(hello, init)</p></pre>node代码：</div><div><pre><p>console.time('for');<br>var hello = require('./addon/build/Release/hello.node').hello;<br>console.log(hello)<br>console.timeEnd('for');</p></pre>执行结果：C++模块执行速度26毫秒</div><div><pre><p>24999997500000<br>for: 26ms</p></pre>从测试我们看出，一些耗费CPU的密集型计算，利用C++模块可以把速度提升1倍。</div><div><br></div><div><br></div><div><br></div><div><span style="line-height:22px"><br></span></div></div>


</div>


            <div class="footer">
              <div class="contact">
                <p>
                  Your Name<br />
                  What You Are<br />
                  your@email.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/lyuehh/">github.com/lyuehh</a><br />
                  <a href="http://twitter.com/lyuehh/">twitter.com/lyuehh</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

    </body>
</html>
