<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>node.js-v0.8API解读（1）-domain</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/google_reader/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/google_reader/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/google_reader/">Google Reader</a></h1>
              <a class="extra" href="/google_reader/">home</a>
            </div>

                <h2>node.js-v0.8API解读（1）-domain</h2>
<p class="meta">2012-07-03 00:10</p>

<div class="post">
<h2>node.js-v0.8API解读（1）-domain</h2>

<h3>by snoopyxdy</h3>

<h3>at 2012-07-02 16:10:31</h3>

<h3>original <a href="http://snoopyxdy.blog.163.com/blog/static/601174402012526104329934">http://snoopyxdy.blog.163.com/blog/static/601174402012526104329934</a></h3>

<div>node.js的0.8版本stable版本已经发布了，官方解释性能有大幅提升，而且稳定性也大幅增强。看了官方给出的数据，性能大约有30%-50%的提升，还是很给力的！以下是官方给出的node-v0.8版本的优势<div><pre><p>1、Node got a lot faster.<br>2、Node got more stable.<br>3、You can do stuff with file descriptors again.<br>4、The cluster module is much more awesome.<br>5、The domain module was added.<br>6、The repl is better.<br>7、The build system changed from waf to gyp.<br>8、Some other stuff changed, too.<br>9、Scroll to the bottom for the links to install it.</p></pre></div><div><br></div><div>api新增了一些，我们来看下新增的一个模块domain的作用。<div>官方api对domain模块的定义如下：</div><div><b>domain模块提供一种方式用来将不同的IO操作归总到一个组中。如果任何注册的时间触发器或者回调函数触发了error事件或者throw了error对象，domain对象将会被通知到。</b></div><div><b>domain模块不会自动加载，需要手动的加载它。并且domain模块会在将来的node.js版本中有比较明显的改变和升级。</b></div><div><br></div><div>至此我们基本明白了domain模块的功能，下面我来看下domain模块的各个属性以及方法。</div><div><br></div><div>domain.create()</div><div>创建一个domain对象，将返回一个新的domain对象<br><div><pre><p></p><pre style="line-height:1.5438em;font-family:Monaco,Consolas,&#39;Lucida Console&#39;,monospace;margin-bottom:1.1em;padding-top:1em;padding-right:1.6em;padding-bottom:1em;padding-left:1.2em;vertical-align:top;background-image:initial;background-color:rgb(248,248,248);border-top-style:solid;border-right-style:solid;border-bottom-style:solid;border-left-style:solid;border-top-color:rgb(232,232,232);border-right-color:rgb(232,232,232);border-bottom-color:rgb(232,232,232);border-left-color:rgb(232,232,232);border-top-width:1px;border-right-width:1px;border-bottom-width:1px;border-left-width:6px;overflow-x:auto;text-align:-webkit-auto"><code style="line-height:1.5438em;font-family:Monaco,Consolas,&#39;Lucida Console&#39;,monospace;margin-top:0px;margin-right:0px;margin-bottom:0px;margin-left:0px;padding-top:0px;padding-right:0px;padding-bottom:0px;padding-left:0px"><span style="color:rgb(204,153,102)">var</span> d <span style="color:rgb(51,51,51)">=</span> domain<span style="color:rgb(51,51,51)">.</span><span>create</span><span style="color:rgb(51,51,51)">();</span><br>d<span style="color:rgb(51,51,51)">.</span><span>on</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(102,153,0)">'error'</span><span style="color:rgb(51,51,51)">,</span> <span style="color:rgb(204,153,102)">function</span><span style="color:rgb(51,51,51)">(</span>er<span style="color:rgb(51,51,51)">)</span> <span style="color:rgb(51,51,51)">{</span><br>  console<span style="color:rgb(51,51,51)">.</span><span>error</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(102,153,0)">'Caught error!'</span><span style="color:rgb(51,51,51)">,</span> er<span style="color:rgb(51,51,51)">);</span><br><span style="color:rgb(51,51,51)">}</span><span style="color:rgb(51,51,51)">);</span><br>d<span style="color:rgb(51,51,51)">.</span><span>run</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(204,153,102)">function</span><span style="color:rgb(51,51,51)">()</span> <span style="color:rgb(51,51,51)">{</span><br>  process<span style="color:rgb(51,51,51)">.</span><span>nextTick</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(204,153,102)">function</span><span style="color:rgb(51,51,51)">()</span> <span style="color:rgb(51,51,51)">{</span><br>    <span>setTimeout</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(204,153,102)">function</span><span style="color:rgb(51,51,51)">()</span> <span style="color:rgb(51,51,51)">{</span> <span style="color:rgb(102,102,102)">// simulating some various async stuff</span><br>      fs<span style="color:rgb(51,51,51)">.</span><span>open</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(102,153,0)">'non-existent file'</span><span style="color:rgb(51,51,51)">,</span> <span style="color:rgb(102,153,0)">'r'</span><span style="color:rgb(51,51,51)">,</span> <span style="color:rgb(204,153,102)">function</span><span style="color:rgb(51,51,51)">(</span>er<span style="color:rgb(51,51,51)">,</span> fd<span style="color:rgb(51,51,51)">)</span> <span style="color:rgb(51,51,51)">{</span><br>        <span style="color:rgb(204,153,102)">if</span> <span style="color:rgb(51,51,51)">(</span>er<span style="color:rgb(51,51,51)">)</span> <span style="color:rgb(204,153,102)">throw</span> er<span style="color:rgb(51,51,51)">;</span><br>        <span style="color:rgb(102,102,102)">// proceed...</span><br>      <span style="color:rgb(51,51,51)">}</span><span style="color:rgb(51,51,51)">);</span><br>    <span style="color:rgb(51,51,51)">}</span><span style="color:rgb(51,51,51)">,</span> <span style="color:rgb(102,153,0)">100</span><span style="color:rgb(51,51,51)">);</span><br>  <span style="color:rgb(51,51,51)">}</span><span style="color:rgb(51,51,51)">);</span><br><span style="color:rgb(51,51,51)">}</span><span style="color:rgb(51,51,51)">);</span></code></pre><p></p></pre>以上是官方的一个例子，很明显当匿名函数throw er后，将会被d.on('error',function(er){})捕获，并做处理。</div></div><div>看到这里我们认为我们只需在d.on('error');函数内统一做出错误处理即可，而不必每次都在回调函数中写错误处理了。</div><div>但是我在这里不推荐这个方式，因为domain模块接下来有更好的处理方式</div><div><br></div><div>domain.bind和domain.intercept 方法：</div><div>这2个方法提供了统一处理一类错误机制的可能，而且相当便捷，我们看下官方代码</div><div><pre><p></p><pre style="line-height:1.5438em;font-family:Monaco,Consolas,&#39;Lucida Console&#39;,monospace;margin-bottom:1.1em;padding-top:1em;padding-right:1.6em;padding-bottom:1em;padding-left:1.2em;vertical-align:top;background-image:initial;background-color:rgb(248,248,248);border-top-style:solid;border-right-style:solid;border-bottom-style:solid;border-left-style:solid;border-top-color:rgb(232,232,232);border-right-color:rgb(232,232,232);border-bottom-color:rgb(232,232,232);border-left-color:rgb(232,232,232);border-top-width:1px;border-right-width:1px;border-bottom-width:1px;border-left-width:6px;overflow-x:auto;text-align:-webkit-auto"><code style="line-height:1.5438em;font-family:Monaco,Consolas,&#39;Lucida Console&#39;,monospace;margin-top:0px;margin-right:0px;margin-bottom:0px;margin-left:0px;padding-top:0px;padding-right:0px;padding-bottom:0px;padding-left:0px"><span style="color:rgb(204,153,102)">var</span> d <span style="color:rgb(51,51,51)">=</span> domain<span style="color:rgb(51,51,51)">.</span><span>create</span><span style="color:rgb(51,51,51)">();</span><br><br><span style="color:rgb(204,153,102)">function</span> <span>readSomeFile</span><span style="color:rgb(51,51,51)">(</span>filename<span style="color:rgb(51,51,51)">,</span> cb<span style="color:rgb(51,51,51)">)</span> <span style="color:rgb(51,51,51)">{</span><br>  fs<span style="color:rgb(51,51,51)">.</span><span>readFile</span><span style="color:rgb(51,51,51)">(</span>filename<span style="color:rgb(51,51,51)">,</span> d<span style="color:rgb(51,51,51)">.</span><span>intercept</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(204,153,102)">function</span><span style="color:rgb(51,51,51)">(</span>data<span style="color:rgb(51,51,51)">)</span> <span style="color:rgb(51,51,51)">{</span><br>    <span style="color:rgb(102,102,102)">// note, the first argument is never passed to the</span><br>    <span style="color:rgb(102,102,102)">// callback since it is assumed to be the 'Error' argument</span><br>    <span style="color:rgb(102,102,102)">// and thus intercepted by the domain.</span><br><br>    <span style="color:rgb(102,102,102)">// if this throws, it will also be passed to the domain</span><br>    <span style="color:rgb(102,102,102)">// so the error-handling logic can be moved to the 'error'</span><br>    <span style="color:rgb(102,102,102)">// event on the domain instead of being repeated throughout</span><br>    <span style="color:rgb(102,102,102)">// the program.</span><br>    <span style="color:rgb(204,153,102)">return</span> <span>cb</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(204,153,102)">null</span><span style="color:rgb(51,51,51)">,</span> JSON<span style="color:rgb(51,51,51)">.</span><span>parse</span><span style="color:rgb(51,51,51)">(</span>data<span style="color:rgb(51,51,51)">));</span><br>  <span style="color:rgb(51,51,51)">}</span><span style="color:rgb(51,51,51)">));</span><br><span style="color:rgb(51,51,51)">}</span><br><br>d<span style="color:rgb(51,51,51)">.</span><span>on</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(102,153,0)">'error'</span><span style="color:rgb(51,51,51)">,</span> <span style="color:rgb(204,153,102)">function</span><span style="color:rgb(51,51,51)">(</span>er<span style="color:rgb(51,51,51)">)</span> <span style="color:rgb(51,51,51)">{</span><br>  <span style="color:rgb(102,102,102)">// an error occurred somewhere.</span><br>  <span style="color:rgb(102,102,102)">// if we throw it now, it will crash the program</span><br>  <span style="color:rgb(102,102,102)">// with the normal line number and stack message.</span><br><span style="color:rgb(51,51,51)">}</span><span style="color:rgb(51,51,51)">);</span></code></pre><p></p></pre>一个fs.readFile方法，读取文件功能，如果出错则转交给d.on('error')方法去处理，如果成功则继续我们的流程。</div><div>所以可以这样理解，如果出错了，则cb是不会执行的，而只会执行d.on('error')方法内的回调函数。这样我们省去了很多麻烦，以前我们往往这样写代码：</div><div><pre><p></p><pre style="font-family:Monaco,Consolas,&#39;Lucida Console&#39;,monospace;margin-bottom:1.1em;padding-top:1em;padding-right:1.6em;padding-bottom:1em;padding-left:1.2em;vertical-align:top;background-image:initial;background-color:rgb(248,248,248);border-top-style:solid;border-right-style:solid;border-bottom-style:solid;border-left-style:solid;border-top-color:rgb(232,232,232);border-right-color:rgb(232,232,232);border-bottom-color:rgb(232,232,232);border-left-color:rgb(232,232,232);border-top-width:1px;border-right-width:1px;border-bottom-width:1px;border-left-width:6px;overflow-x:auto;text-align:-webkit-auto"><code style="font-family:Monaco,Consolas,&#39;Lucida Console&#39;,monospace;margin-top:0px;margin-right:0px;margin-bottom:0px;margin-left:0px;padding-top:0px;padding-right:0px;padding-bottom:0px;padding-left:0px"><span style="line-height:1.5438em;color:rgb(204,153,102)">function</span><span style="line-height:1.5438em"> </span><span style="line-height:1.5438em">readSomeFile</span><span style="line-height:1.5438em;color:rgb(51,51,51)">(</span><span style="line-height:1.5438em">filename</span><span style="line-height:1.5438em;color:rgb(51,51,51)">,</span><span style="line-height:1.5438em"> cb</span><span style="line-height:1.5438em;color:rgb(51,51,51)">)</span><span style="line-height:1.5438em"> </span><span style="line-height:1.5438em;color:rgb(51,51,51)">{</span><span style="line-height:1.5438em"><br>  fs</span><span style="line-height:1.5438em;color:rgb(51,51,51)">.</span><span style="line-height:1.5438em">readFile</span><span style="line-height:1.5438em;color:rgb(51,51,51)">(</span><span style="line-height:1.5438em">filename</span><span style="line-height:1.5438em;color:rgb(51,51,51)">,</span><span style="line-height:1.5438em"> </span><span style="line-height:1.5438em;color:rgb(204,153,102)">function</span><span style="line-height:1.5438em;color:rgb(51,51,51)">(err, </span><span style="line-height:1.5438em">data</span><span style="line-height:1.5438em;color:rgb(51,51,51)">)</span><span style="line-height:1.5438em"> </span><span style="line-height:1.5438em;color:rgb(51,51,51)">{</span><span style="line-height:1.5438em"><br>    if(err) return errorHandler(err)&amp;&amp;cb(err);</span><span style="line-height:1.5438em"><br>    else cb(null, data);</span><span style="line-height:1.5438em"><br>  </span><span style="line-height:1.5438em;color:rgb(51,51,51)">}</span><span style="line-height:1.5438em;color:rgb(51,51,51)">);</span><span style="line-height:1.5438em"><br></span><span style="line-height:1.5438em;color:rgb(51,51,51)">}</span><span style="line-height:1.5438em"><br><br></span><font color="#333333"><span style="line-height:21px">function errorHandle(err){    console.error(err); }</span></font></code></pre><p></p></pre>加入了domain模块我们就可以删除这些if判断了，统一由domain模块来管理err情况，让我们代码更清晰，调理更清楚，也省去了不少麻烦。</div><div><br></div><div>为了方便我们管理domain对象，domain对象还提供了一些其他的属性和方法如下：</div><div>domain.run(fn)</div><div>创建一个domain上下文，在上下文中抛出的error或者触发器触发的error事件都将被domain.on('error')接收到，一方面统一管理，另一方面也避免了因为错误将整个node.js进程搞挂掉。</div><div><br></div><div>domain.members</div><div>一个数组用来存放注册到domain模块的定时器和事件触发器</div><div><br></div><div>domain.add(emitter)</div><div>注册一个定时器或者时间触发器，当定时器或者事件触发器抛出异常，则会被domain模块捕获</div><div><br></div><div>domain.remove(emitter)</div><div>删除一个定时器或者事件触发器</div><div><br></div><div>domain.bind(fn)</div><div>和上面的示例domain.intercept一样，只是bind方法将会把err传递进fn</div><div><br></div><div>domain.dispose()</div><div>摧毁一个domain对象，node.js进程将尽最大可能回收这部分资源。注意，当还有bind的定时器没有触发前调用dispose方法，定时器的回调函数将不会执行，而且当有IO操作时，IO操作的回调也不会执行。</div><div><br></div><div>总结一下</div><div>node.js的新domain模块确实解决了很多重复代码的工作，在开发过程中我建议将domain模块进行封装，单独写一个模块用来管理各种不同的错误处理，减少domain.create()，尽量使用1个或几个domain对象来处理整个应用的错误，便于管理</div><br></div></div>


</div>


            <div class="footer">
              <div class="contact">
                <p>
                  Your Name<br />
                  What You Are<br />
                  your@email.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/lyuehh/">github.com/lyuehh</a><br />
                  <a href="http://twitter.com/lyuehh/">twitter.com/lyuehh</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

    </body>
</html>
