<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>6天通吃树结构—— 第三天 Treap树</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/">Your New Jekyll Site</a></h1>
              <a class="extra" href="/">home</a>
            </div>

                <h2>6天通吃树结构—— 第三天 Treap树</h2>
<p class="meta">30 Jul 2012</p>

<div class="post">
<h2>6天通吃树结构—— 第三天 Treap树</h2>

<h3>by 一线码农</h3>

<h3>at 2012-07-30 02:01:00</h3>

<h3>original <a href="http://www.cnblogs.com/huangxincheng/archive/2012/07/30/2614484.html">http://www.cnblogs.com/huangxincheng/archive/2012/07/30/2614484.html</a></h3>

<p>       </p>


<p>       我们知道，二叉查找树相对来说比较容易形成最坏的链表情况，所以前辈们想尽了各种优化策略，包括AVL，红黑，以及今天</p>


<p>要讲的Treap树。</p>


<p>       Treap树算是一种简单的优化策略，这名字大家也能猜到，树和堆的合体，其实原理比较简单，在树中维护一个&quot;优先级“，”优先级“</p>


<p>采用随机数的方法，但是”优先级“必须满足根堆的性质，当然是“大根堆”或者“小根堆”都无所谓，比如下面的一棵树：</p>


<p><img src="http://pic002.cnblogs.com/images/2012/214741/2012073000522678.png" alt=""></p>


<p>从树中我们可以看到：</p>


<p>①：节点中的key满足“二叉查找树”。</p>


<p>②：节点中的“优先级”满足小根堆。</p>


<p> </p>


<p>一：基本操作</p>


<p>1：定义</p>


<div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px"><span style="color:#008080"> 1</span>     <span style="color:#0000ff">#region</span> Treap树节点<br><span style="color:#008080"> 2</span>     <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080"> 3</span>     <span style="color:#808080">///</span><span style="color:#008000"> Treap树<br></span><span style="color:#008080"> 4</span>     <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080"> 5</span>     <span style="color:#808080">///</span> <span style="color:#808080">&lt;typeparam name=&quot;K&quot;&gt;&lt;/typeparam&gt;</span><br><span style="color:#008080"> 6</span>     <span style="color:#808080">///</span> <span style="color:#808080">&lt;typeparam name=&quot;V&quot;&gt;&lt;/typeparam&gt;</span><br><span style="color:#008080"> 7</span>     <span style="color:#0000ff">public</span> <span style="color:#0000ff">class</span> TreapNode&lt;K, V&gt;<br><span style="color:#008080"> 8</span> <span style="color:#000000">    {<br></span><span style="color:#008080"> 9</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080">10</span>         <span style="color:#808080">///</span><span style="color:#008000"> 节点元素<br></span><span style="color:#008080">11</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080">12</span>         <span style="color:#0000ff">public</span><span style="color:#000000"> K key;<br></span><span style="color:#008080">13</span> <br><span style="color:#008080">14</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080">15</span>         <span style="color:#808080">///</span><span style="color:#008000"> 优先级（采用随机数）<br></span><span style="color:#008080">16</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080">17</span>         <span style="color:#0000ff">public</span> <span style="color:#0000ff">int</span><span style="color:#000000"> priority;<br></span><span style="color:#008080">18</span> <br><span style="color:#008080">19</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080">20</span>         <span style="color:#808080">///</span><span style="color:#008000"> 节点中的附加值<br></span><span style="color:#008080">21</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080">22</span>         <span style="color:#0000ff">public</span> HashSet&lt;V&gt; attach = <span style="color:#0000ff">new</span> HashSet&lt;V&gt;<span style="color:#000000">();<br></span><span style="color:#008080">23</span> <br><span style="color:#008080">24</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080">25</span>         <span style="color:#808080">///</span><span style="color:#008000"> 左节点<br></span><span style="color:#008080">26</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080">27</span>         <span style="color:#0000ff">public</span> TreapNode&lt;K, V&gt;<span style="color:#000000"> left;<br></span><span style="color:#008080">28</span> <br><span style="color:#008080">29</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080">30</span>         <span style="color:#808080">///</span><span style="color:#008000"> 右节点<br></span><span style="color:#008080">31</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080">32</span>         <span style="color:#0000ff">public</span> TreapNode&lt;K, V&gt;<span style="color:#000000"> right;<br></span><span style="color:#008080">33</span> <br><span style="color:#008080">34</span>         <span style="color:#0000ff">public</span><span style="color:#000000"> TreapNode() { }<br></span><span style="color:#008080">35</span> <br><span style="color:#008080">36</span>         <span style="color:#0000ff">public</span> TreapNode(K key, V value, TreapNode&lt;K, V&gt; left, TreapNode&lt;K, V&gt;<span style="color:#000000"> right)<br></span><span style="color:#008080">37</span> <span style="color:#000000">        {<br></span><span style="color:#008080">38</span>             <span style="color:#008000">//</span><span style="color:#008000">KV键值对</span><br><span style="color:#008080">39</span>             <span style="color:#0000ff">this</span>.key =<span style="color:#000000"> key;<br></span><span style="color:#008080">40</span>             <span style="color:#0000ff">this</span>.priority = <span style="color:#0000ff">new</span> Random(DateTime.Now.Millisecond).Next(<span style="color:#800080">0</span>,<span style="color:#0000ff">int</span><span style="color:#000000">.MaxValue);<br></span><span style="color:#008080">41</span>             <span style="color:#0000ff">this</span><span style="color:#000000">.attach.Add(value);<br></span><span style="color:#008080">42</span> <br><span style="color:#008080">43</span>             <span style="color:#0000ff">this</span>.left =<span style="color:#000000"> left;<br></span><span style="color:#008080">44</span>             <span style="color:#0000ff">this</span>.right =<span style="color:#000000"> right;<br></span><span style="color:#008080">45</span> <span style="color:#000000">        }<br></span><span style="color:#008080">46</span> <span style="color:#000000">    }<br></span><span style="color:#008080">47</span>     <span style="color:#0000ff">#endregion</span></div>


<p>节点里面定义了一个priority作为“堆定义”的旋转因子，因子采用“随机数“。</p>


<p> </p>


<p>2：添加</p>


<p>    首先我们知道各个节点的“优先级”是采用随机数的方法，那么就存在一个问题，当我们插入一个节点后，优先级不满足“堆定义&quot;的</p>


<p>时候我们该怎么办，前辈说此时需要旋转，直到满足堆定义为止。</p>


<p>旋转有两种方式，如果大家玩转了AVL，那么对Treap中的旋转的理解轻而易举。</p>


<p>①： 左左情况旋转</p>


<p><img src="http://pic002.cnblogs.com/images/2012/214741/2012073001112626.png" alt=""></p>


<p>从图中可以看出，当我们插入“节点12”的时候，此时“堆性质”遭到破坏，必须进行旋转，我们发现优先级是6&lt;9，所以就要进行</p>


<p>左左情况旋转，最终也就形成了我们需要的结果。</p>


<p> </p>


<p>②： 右右情况旋转</p>


<p><img src="http://pic002.cnblogs.com/images/2012/214741/2012073001162452.png" alt=""></p>


<p>既然理解了”左左情况旋转“，右右情况也是同样的道理，优先级中发现“6&lt;9&quot;，进行”右右旋转“最终达到我们要的效果。</p>


<div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px"><span style="color:#008080"> 1</span>         <span style="color:#0000ff">#region</span> 添加操作<br><span style="color:#008080"> 2</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080"> 3</span>         <span style="color:#808080">///</span><span style="color:#008000"> 添加操作<br></span><span style="color:#008080"> 4</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080"> 5</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;key&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080"> 6</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;value&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080"> 7</span>         <span style="color:#0000ff">public</span> <span style="color:#0000ff">void</span><span style="color:#000000"> Add(K key, V value)<br></span><span style="color:#008080"> 8</span> <span style="color:#000000">        {<br></span><span style="color:#008080"> 9</span>             node =<span style="color:#000000"> Add(key, value, node);<br></span><span style="color:#008080">10</span> <span style="color:#000000">        }<br></span><span style="color:#008080">11</span>         <span style="color:#0000ff">#endregion</span><br><span style="color:#008080">12</span> <br><span style="color:#008080">13</span>         <span style="color:#0000ff">#region</span> 添加操作<br><span style="color:#008080">14</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080">15</span>         <span style="color:#808080">///</span><span style="color:#008000"> 添加操作<br></span><span style="color:#008080">16</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080">17</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;key&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080">18</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;value&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080">19</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;tree&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080">20</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;returns&gt;&lt;/returns&gt;</span><br><span style="color:#008080">21</span>         <span style="color:#0000ff">public</span> TreapNode&lt;K, V&gt; Add(K key, V value, TreapNode&lt;K, V&gt;<span style="color:#000000"> tree)<br></span><span style="color:#008080">22</span> <span style="color:#000000">        {<br></span><span style="color:#008080">23</span>             <span style="color:#0000ff">if</span> (tree == <span style="color:#0000ff">null</span><span style="color:#000000">)<br></span><span style="color:#008080">24</span>                 tree = <span style="color:#0000ff">new</span> TreapNode&lt;K, V&gt;(key, value, <span style="color:#0000ff">null</span>, <span style="color:#0000ff">null</span><span style="color:#000000">);<br></span><span style="color:#008080">25</span> <br><span style="color:#008080">26</span>             <span style="color:#008000">//</span><span style="color:#008000">左子树</span><br><span style="color:#008080">27</span>             <span style="color:#0000ff">if</span> (key.CompareTo(tree.key) &lt; <span style="color:#800080">0</span><span style="color:#000000">)<br></span><span style="color:#008080">28</span> <span style="color:#000000">            {<br></span><span style="color:#008080">29</span>                 tree.left =<span style="color:#000000"> Add(key, value, tree.left);<br></span><span style="color:#008080">30</span> <br><span style="color:#008080">31</span>                 <span style="color:#008000">//</span><span style="color:#008000">根据小根堆性质，需要”左左情况旋转”</span><br><span style="color:#008080">32</span>                 <span style="color:#0000ff">if</span> (tree.left.priority &lt;<span style="color:#000000"> tree.priority)<br></span><span style="color:#008080">33</span> <span style="color:#000000">                {<br></span><span style="color:#008080">34</span>                     tree =<span style="color:#000000"> RotateLL(tree);<br></span><span style="color:#008080">35</span> <span style="color:#000000">                }<br></span><span style="color:#008080">36</span> <span style="color:#000000">            }<br></span><span style="color:#008080">37</span> <br><span style="color:#008080">38</span>             <span style="color:#008000">//</span><span style="color:#008000">右子树</span><br><span style="color:#008080">39</span>             <span style="color:#0000ff">if</span> (key.CompareTo(tree.key) &gt; <span style="color:#800080">0</span><span style="color:#000000">)<br></span><span style="color:#008080">40</span> <span style="color:#000000">            {<br></span><span style="color:#008080">41</span>                 tree.right =<span style="color:#000000"> Add(key, value, tree.right);<br></span><span style="color:#008080">42</span> <br><span style="color:#008080">43</span>                 <span style="color:#008000">//</span><span style="color:#008000">根据小根堆性质，需要”右右情况旋转”</span><br><span style="color:#008080">44</span>                 <span style="color:#0000ff">if</span> (tree.right.priority &lt;<span style="color:#000000"> tree.priority)<br></span><span style="color:#008080">45</span> <span style="color:#000000">                {<br></span><span style="color:#008080">46</span>                     tree =<span style="color:#000000"> RotateRR(tree);<br></span><span style="color:#008080">47</span> <span style="color:#000000">                }<br></span><span style="color:#008080">48</span> <span style="color:#000000">            }<br></span><span style="color:#008080">49</span> <br><span style="color:#008080">50</span>             <span style="color:#008000">//</span><span style="color:#008000">将value追加到附加值中（也可对应重复元素）</span><br><span style="color:#008080">51</span>             <span style="color:#0000ff">if</span> (key.CompareTo(tree.key) == <span style="color:#800080">0</span><span style="color:#000000">)<br></span><span style="color:#008080">52</span> <span style="color:#000000">                tree.attach.Add(value);<br></span><span style="color:#008080">53</span> <br><span style="color:#008080">54</span>             <span style="color:#0000ff">return</span><span style="color:#000000"> tree;<br></span><span style="color:#008080">55</span> <span style="color:#000000">        }<br></span><span style="color:#008080">56</span>         <span style="color:#0000ff">#endregion</span></div>


<p> </p>


<p>3:删除</p>


<p>  跟普通的二叉查找树一样，删除结点存在三种情况。</p>


<p>①：叶子结点</p>


<p>      跟普通查找树一样，直接释放本节点即可。</p>


<p>②：单孩子结点</p>


<p>     跟普通查找树一样操作。</p>


<p>③：满孩子结点</p>


<p>    其实在treap中删除满孩子结点有两种方式。</p>


<p>第一种：跟普通的二叉查找树一样，找到“右子树”的最左结点（15），拷贝元素的值，但不拷贝元素的优先级，然后在右子树中</p>


<p>           删除“结点15”即可，最终效果如下图。</p>


<p><img src="http://pic002.cnblogs.com/images/2012/214741/2012073001332339.png" alt=""></p>


<p>第二种：将”结点下旋“，直到该节点不是”满孩子的情况“，该赋null的赋null，该将孩子结点顶上的就顶上，如下图：</p>


<p><img src="http://pic002.cnblogs.com/images/2012/214741/2012073001450711.png" alt=""></p>


<p>当然从理论上来说，第二种删除方法更合理，这里我写的就是第二种情况的代码。</p>


<div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px"><span style="color:#008080"> 1</span>         <span style="color:#0000ff">#region</span> 删除当前树中的节点<br><span style="color:#008080"> 2</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080"> 3</span>         <span style="color:#808080">///</span><span style="color:#008000"> 删除当前树中的节点<br></span><span style="color:#008080"> 4</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080"> 5</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;key&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080"> 6</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;returns&gt;&lt;/returns&gt;</span><br><span style="color:#008080"> 7</span>         <span style="color:#0000ff">public</span> <span style="color:#0000ff">void</span><span style="color:#000000"> Remove(K key, V value)<br></span><span style="color:#008080"> 8</span> <span style="color:#000000">        {<br></span><span style="color:#008080"> 9</span>             node =<span style="color:#000000"> Remove(key, value, node);<br></span><span style="color:#008080">10</span> <span style="color:#000000">        }<br></span><span style="color:#008080">11</span>         <span style="color:#0000ff">#endregion</span><br><span style="color:#008080">12</span> <br><span style="color:#008080">13</span>         <span style="color:#0000ff">#region</span> 删除当前树中的节点<br><span style="color:#008080">14</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080">15</span>         <span style="color:#808080">///</span><span style="color:#008000"> 删除当前树中的节点<br></span><span style="color:#008080">16</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080">17</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;key&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080">18</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;tree&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080">19</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;returns&gt;&lt;/returns&gt;</span><br><span style="color:#008080">20</span>         <span style="color:#0000ff">public</span> TreapNode&lt;K, V&gt; Remove(K key, V value, TreapNode&lt;K, V&gt;<span style="color:#000000"> tree)<br></span><span style="color:#008080">21</span> <span style="color:#000000">        {<br></span><span style="color:#008080">22</span>             <span style="color:#0000ff">if</span> (tree == <span style="color:#0000ff">null</span><span style="color:#000000">)<br></span><span style="color:#008080">23</span>                 <span style="color:#0000ff">return</span> <span style="color:#0000ff">null</span><span style="color:#000000">;<br></span><span style="color:#008080">24</span> <br><span style="color:#008080">25</span>             <span style="color:#008000">//</span><span style="color:#008000">左子树</span><br><span style="color:#008080">26</span>             <span style="color:#0000ff">if</span> (key.CompareTo(tree.key) &lt; <span style="color:#800080">0</span><span style="color:#000000">)<br></span><span style="color:#008080">27</span> <span style="color:#000000">            {<br></span><span style="color:#008080">28</span>                 tree.left =<span style="color:#000000"> Remove(key, value, tree.left);<br></span><span style="color:#008080">29</span> <span style="color:#000000">            }<br></span><span style="color:#008080">30</span>             <span style="color:#008000">//</span><span style="color:#008000">右子树</span><br><span style="color:#008080">31</span>             <span style="color:#0000ff">if</span> (key.CompareTo(tree.key) &gt; <span style="color:#800080">0</span><span style="color:#000000">)<br></span><span style="color:#008080">32</span> <span style="color:#000000">            {<br></span><span style="color:#008080">33</span>                 tree.right =<span style="color:#000000"> Remove(key, value, tree.right);<br></span><span style="color:#008080">34</span> <span style="color:#000000">            }<br></span><span style="color:#008080">35</span>             <span style="color:#008000">/*</span><span style="color:#008000">相等的情况</span><span style="color:#008000">*/</span><br><span style="color:#008080">36</span>             <span style="color:#0000ff">if</span> (key.CompareTo(tree.key) == <span style="color:#800080">0</span><span style="color:#000000">)<br></span><span style="color:#008080">37</span> <span style="color:#000000">            {<br></span><span style="color:#008080">38</span>                 <span style="color:#008000">//</span><span style="color:#008000">判断里面的HashSet是否有多值</span><br><span style="color:#008080">39</span>                 <span style="color:#0000ff">if</span> (tree.attach.Count &gt; <span style="color:#800080">1</span><span style="color:#000000">)<br></span><span style="color:#008080">40</span> <span style="color:#000000">                {<br></span><span style="color:#008080">41</span>                     <span style="color:#008000">//</span><span style="color:#008000">实现惰性删除</span><br><span style="color:#008080">42</span> <span style="color:#000000">                    tree.attach.Remove(value);<br></span><span style="color:#008080">43</span> <span style="color:#000000">                }<br></span><span style="color:#008080">44</span>                 <span style="color:#0000ff">else</span><br><span style="color:#008080">45</span> <span style="color:#000000">                {<br></span><span style="color:#008080">46</span>                     <span style="color:#008000">//</span><span style="color:#008000">有两个孩子的情况</span><br><span style="color:#008080">47</span>                     <span style="color:#0000ff">if</span> (tree.left != <span style="color:#0000ff">null</span> &amp;&amp; tree.right != <span style="color:#0000ff">null</span><span style="color:#000000">)<br></span><span style="color:#008080">48</span> <span style="color:#000000">                    {<br></span><span style="color:#008080">49</span>                         <span style="color:#008000">//</span><span style="color:#008000">如果左孩子的优先级低就需要“左旋”</span><br><span style="color:#008080">50</span>                         <span style="color:#0000ff">if</span> (tree.left.priority &lt;<span style="color:#000000"> tree.right.priority)<br></span><span style="color:#008080">51</span> <span style="color:#000000">                        {<br></span><span style="color:#008080">52</span>                             tree =<span style="color:#000000"> RotateLL(tree);<br></span><span style="color:#008080">53</span> <span style="color:#000000">                        }<br></span><span style="color:#008080">54</span>                         <span style="color:#0000ff">else</span><br><span style="color:#008080">55</span> <span style="color:#000000">                        {<br></span><span style="color:#008080">56</span>                             <span style="color:#008000">//</span><span style="color:#008000">否则“右旋”</span><br><span style="color:#008080">57</span>                             tree =<span style="color:#000000"> RotateRR(tree);<br></span><span style="color:#008080">58</span> <span style="color:#000000">                        }<br></span><span style="color:#008080">59</span> <br><span style="color:#008080">60</span>                         <span style="color:#008000">//</span><span style="color:#008000">继续旋转</span><br><span style="color:#008080">61</span>                         tree =<span style="color:#000000"> Remove(key, value, tree);<br></span><span style="color:#008080">62</span> <span style="color:#000000">                    }<br></span><span style="color:#008080">63</span>                     <span style="color:#0000ff">else</span><br><span style="color:#008080">64</span> <span style="color:#000000">                    {<br></span><span style="color:#008080">65</span>                         <span style="color:#008000">//</span><span style="color:#008000">如果旋转后已经变成了叶子节点则直接删除</span><br><span style="color:#008080">66</span>                         <span style="color:#0000ff">if</span> (tree == <span style="color:#0000ff">null</span><span style="color:#000000">)<br></span><span style="color:#008080">67</span>                             <span style="color:#0000ff">return</span> <span style="color:#0000ff">null</span><span style="color:#000000">;<br></span><span style="color:#008080">68</span> <br><span style="color:#008080">69</span>                         <span style="color:#008000">//</span><span style="color:#008000">最后就是单支树</span><br><span style="color:#008080">70</span>                         tree = tree.left == <span style="color:#0000ff">null</span> ?<span style="color:#000000"> tree.right : tree.left;<br></span><span style="color:#008080">71</span> <span style="color:#000000">                    }<br></span><span style="color:#008080">72</span> <span style="color:#000000">                }<br></span><span style="color:#008080">73</span> <span style="color:#000000">            }<br></span><span style="color:#008080">74</span> <br><span style="color:#008080">75</span>             <span style="color:#0000ff">return</span><span style="color:#000000"> tree;<br></span><span style="color:#008080">76</span> <span style="color:#000000">        }<br></span><span style="color:#008080">77</span>         <span style="color:#0000ff">#endregion</span></div>


<p> </p>


<p>4:总结</p>


<p>treap树在CURD中是期望的logN，由于我们加了”优先级“,所以会出现”链表“的情况几乎不存在，但是他的Add和Remove相比严格的</p>


<p>平衡二叉树有更少的旋转操作，可以说性能是在”普通二叉树“和”平衡二叉树“之间。</p>


<p>最后是总运行代码，不过这里我就不做测试了。</p>


<div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px"><div><span style="color:#008080">  1</span> <span style="color:#0000ff">using</span><span style="color:#000000"> System;<br></span><span style="color:#008080">  2</span> <span style="color:#0000ff">using</span><span style="color:#000000"> System.Collections.Generic;<br></span><span style="color:#008080">  3</span> <span style="color:#0000ff">using</span><span style="color:#000000"> System.Linq;<br></span><span style="color:#008080">  4</span> <span style="color:#0000ff">using</span><span style="color:#000000"> System.Text;<br></span><span style="color:#008080">  5</span> <br><span style="color:#008080">  6</span> <span style="color:#0000ff">namespace</span><span style="color:#000000"> DataStruct<br></span><span style="color:#008080">  7</span> <span style="color:#000000">{<br></span><span style="color:#008080">  8</span>     <span style="color:#0000ff">#region</span> Treap树节点<br><span style="color:#008080">  9</span>     <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080"> 10</span>     <span style="color:#808080">///</span><span style="color:#008000"> Treap树<br></span><span style="color:#008080"> 11</span>     <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080"> 12</span>     <span style="color:#808080">///</span> <span style="color:#808080">&lt;typeparam name=&quot;K&quot;&gt;&lt;/typeparam&gt;</span><br><span style="color:#008080"> 13</span>     <span style="color:#808080">///</span> <span style="color:#808080">&lt;typeparam name=&quot;V&quot;&gt;&lt;/typeparam&gt;</span><br><span style="color:#008080"> 14</span>     <span style="color:#0000ff">public</span> <span style="color:#0000ff">class</span> TreapNode&lt;K, V&gt;<br><span style="color:#008080"> 15</span> <span style="color:#000000">    {<br></span><span style="color:#008080"> 16</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080"> 17</span>         <span style="color:#808080">///</span><span style="color:#008000"> 节点元素<br></span><span style="color:#008080"> 18</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080"> 19</span>         <span style="color:#0000ff">public</span><span style="color:#000000"> K key;<br></span><span style="color:#008080"> 20</span> <br><span style="color:#008080"> 21</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080"> 22</span>         <span style="color:#808080">///</span><span style="color:#008000"> 优先级（采用随机数）<br></span><span style="color:#008080"> 23</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080"> 24</span>         <span style="color:#0000ff">public</span> <span style="color:#0000ff">int</span><span style="color:#000000"> priority;<br></span><span style="color:#008080"> 25</span> <br><span style="color:#008080"> 26</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080"> 27</span>         <span style="color:#808080">///</span><span style="color:#008000"> 节点中的附加值<br></span><span style="color:#008080"> 28</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080"> 29</span>         <span style="color:#0000ff">public</span> HashSet&lt;V&gt; attach = <span style="color:#0000ff">new</span> HashSet&lt;V&gt;<span style="color:#000000">();<br></span><span style="color:#008080"> 30</span> <br><span style="color:#008080"> 31</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080"> 32</span>         <span style="color:#808080">///</span><span style="color:#008000"> 左节点<br></span><span style="color:#008080"> 33</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080"> 34</span>         <span style="color:#0000ff">public</span> TreapNode&lt;K, V&gt;<span style="color:#000000"> left;<br></span><span style="color:#008080"> 35</span> <br><span style="color:#008080"> 36</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080"> 37</span>         <span style="color:#808080">///</span><span style="color:#008000"> 右节点<br></span><span style="color:#008080"> 38</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080"> 39</span>         <span style="color:#0000ff">public</span> TreapNode&lt;K, V&gt;<span style="color:#000000"> right;<br></span><span style="color:#008080"> 40</span> <br><span style="color:#008080"> 41</span>         <span style="color:#0000ff">public</span><span style="color:#000000"> TreapNode() { }<br></span><span style="color:#008080"> 42</span> <br><span style="color:#008080"> 43</span>         <span style="color:#0000ff">public</span> TreapNode(K key, V value, TreapNode&lt;K, V&gt; left, TreapNode&lt;K, V&gt;<span style="color:#000000"> right)<br></span><span style="color:#008080"> 44</span> <span style="color:#000000">        {<br></span><span style="color:#008080"> 45</span>             <span style="color:#008000">//</span><span style="color:#008000">KV键值对</span><br><span style="color:#008080"> 46</span>             <span style="color:#0000ff">this</span>.key =<span style="color:#000000"> key;<br></span><span style="color:#008080"> 47</span>             <span style="color:#0000ff">this</span>.priority = <span style="color:#0000ff">new</span> Random(DateTime.Now.Millisecond).Next(<span style="color:#800080">0</span>,<span style="color:#0000ff">int</span><span style="color:#000000">.MaxValue);<br></span><span style="color:#008080"> 48</span>             <span style="color:#0000ff">this</span><span style="color:#000000">.attach.Add(value);<br></span><span style="color:#008080"> 49</span> <br><span style="color:#008080"> 50</span>             <span style="color:#0000ff">this</span>.left =<span style="color:#000000"> left;<br></span><span style="color:#008080"> 51</span>             <span style="color:#0000ff">this</span>.right =<span style="color:#000000"> right;<br></span><span style="color:#008080"> 52</span> <span style="color:#000000">        }<br></span><span style="color:#008080"> 53</span> <span style="color:#000000">    }<br></span><span style="color:#008080"> 54</span>     <span style="color:#0000ff">#endregion</span><br><span style="color:#008080"> 55</span> <br><span style="color:#008080"> 56</span>     <span style="color:#0000ff">public</span> <span style="color:#0000ff">class</span> TreapTree&lt;K, V&gt; <span style="color:#0000ff">where</span><span style="color:#000000"> K : IComparable<br></span><span style="color:#008080"> 57</span> <span style="color:#000000">    {<br></span><span style="color:#008080"> 58</span>         <span style="color:#0000ff">public</span> TreapNode&lt;K, V&gt; node = <span style="color:#0000ff">null</span><span style="color:#000000">;<br></span><span style="color:#008080"> 59</span> <br><span style="color:#008080"> 60</span>         <span style="color:#0000ff">#region</span> 添加操作<br><span style="color:#008080"> 61</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080"> 62</span>         <span style="color:#808080">///</span><span style="color:#008000"> 添加操作<br></span><span style="color:#008080"> 63</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080"> 64</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;key&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080"> 65</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;value&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080"> 66</span>         <span style="color:#0000ff">public</span> <span style="color:#0000ff">void</span><span style="color:#000000"> Add(K key, V value)<br></span><span style="color:#008080"> 67</span> <span style="color:#000000">        {<br></span><span style="color:#008080"> 68</span>             node =<span style="color:#000000"> Add(key, value, node);<br></span><span style="color:#008080"> 69</span> <span style="color:#000000">        }<br></span><span style="color:#008080"> 70</span>         <span style="color:#0000ff">#endregion</span><br><span style="color:#008080"> 71</span> <br><span style="color:#008080"> 72</span>         <span style="color:#0000ff">#region</span> 添加操作<br><span style="color:#008080"> 73</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080"> 74</span>         <span style="color:#808080">///</span><span style="color:#008000"> 添加操作<br></span><span style="color:#008080"> 75</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080"> 76</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;key&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080"> 77</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;value&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080"> 78</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;tree&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080"> 79</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;returns&gt;&lt;/returns&gt;</span><br><span style="color:#008080"> 80</span>         <span style="color:#0000ff">public</span> TreapNode&lt;K, V&gt; Add(K key, V value, TreapNode&lt;K, V&gt;<span style="color:#000000"> tree)<br></span><span style="color:#008080"> 81</span> <span style="color:#000000">        {<br></span><span style="color:#008080"> 82</span>             <span style="color:#0000ff">if</span> (tree == <span style="color:#0000ff">null</span><span style="color:#000000">)<br></span><span style="color:#008080"> 83</span>                 tree = <span style="color:#0000ff">new</span> TreapNode&lt;K, V&gt;(key, value, <span style="color:#0000ff">null</span>, <span style="color:#0000ff">null</span><span style="color:#000000">);<br></span><span style="color:#008080"> 84</span> <br><span style="color:#008080"> 85</span>             <span style="color:#008000">//</span><span style="color:#008000">左子树</span><br><span style="color:#008080"> 86</span>             <span style="color:#0000ff">if</span> (key.CompareTo(tree.key) &lt; <span style="color:#800080">0</span><span style="color:#000000">)<br></span><span style="color:#008080"> 87</span> <span style="color:#000000">            {<br></span><span style="color:#008080"> 88</span>                 tree.left =<span style="color:#000000"> Add(key, value, tree.left);<br></span><span style="color:#008080"> 89</span> <br><span style="color:#008080"> 90</span>                 <span style="color:#008000">//</span><span style="color:#008000">根据小根堆性质，需要”左左情况旋转”</span><br><span style="color:#008080"> 91</span>                 <span style="color:#0000ff">if</span> (tree.left.priority &lt;<span style="color:#000000"> tree.priority)<br></span><span style="color:#008080"> 92</span> <span style="color:#000000">                {<br></span><span style="color:#008080"> 93</span>                     tree =<span style="color:#000000"> RotateLL(tree);<br></span><span style="color:#008080"> 94</span> <span style="color:#000000">                }<br></span><span style="color:#008080"> 95</span> <span style="color:#000000">            }<br></span><span style="color:#008080"> 96</span> <br><span style="color:#008080"> 97</span>             <span style="color:#008000">//</span><span style="color:#008000">右子树</span><br><span style="color:#008080"> 98</span>             <span style="color:#0000ff">if</span> (key.CompareTo(tree.key) &gt; <span style="color:#800080">0</span><span style="color:#000000">)<br></span><span style="color:#008080"> 99</span> <span style="color:#000000">            {<br></span><span style="color:#008080">100</span>                 tree.right =<span style="color:#000000"> Add(key, value, tree.right);<br></span><span style="color:#008080">101</span> <br><span style="color:#008080">102</span>                 <span style="color:#008000">//</span><span style="color:#008000">根据小根堆性质，需要”右右情况旋转”</span><br><span style="color:#008080">103</span>                 <span style="color:#0000ff">if</span> (tree.right.priority &lt;<span style="color:#000000"> tree.priority)<br></span><span style="color:#008080">104</span> <span style="color:#000000">                {<br></span><span style="color:#008080">105</span>                     tree =<span style="color:#000000"> RotateRR(tree);<br></span><span style="color:#008080">106</span> <span style="color:#000000">                }<br></span><span style="color:#008080">107</span> <span style="color:#000000">            }<br></span><span style="color:#008080">108</span> <br><span style="color:#008080">109</span>             <span style="color:#008000">//</span><span style="color:#008000">将value追加到附加值中（也可对应重复元素）</span><br><span style="color:#008080">110</span>             <span style="color:#0000ff">if</span> (key.CompareTo(tree.key) == <span style="color:#800080">0</span><span style="color:#000000">)<br></span><span style="color:#008080">111</span> <span style="color:#000000">                tree.attach.Add(value);<br></span><span style="color:#008080">112</span> <br><span style="color:#008080">113</span>             <span style="color:#0000ff">return</span><span style="color:#000000"> tree;<br></span><span style="color:#008080">114</span> <span style="color:#000000">        }<br></span><span style="color:#008080">115</span>         <span style="color:#0000ff">#endregion</span><br><span style="color:#008080">116</span> <br><span style="color:#008080">117</span>         <span style="color:#0000ff">#region</span> 第一种：左左旋转（单旋转）<br><span style="color:#008080">118</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080">119</span>         <span style="color:#808080">///</span><span style="color:#008000"> 第一种：左左旋转（单旋转）<br></span><span style="color:#008080">120</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080">121</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;node&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080">122</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;returns&gt;&lt;/returns&gt;</span><br><span style="color:#008080">123</span>         <span style="color:#0000ff">public</span> TreapNode&lt;K, V&gt; RotateLL(TreapNode&lt;K, V&gt;<span style="color:#000000"> node)<br></span><span style="color:#008080">124</span> <span style="color:#000000">        {<br></span><span style="color:#008080">125</span>             <span style="color:#008000">//</span><span style="color:#008000">top：需要作为顶级节点的元素</span><br><span style="color:#008080">126</span>             <span style="color:#0000ff">var</span> top =<span style="color:#000000"> node.left;<br></span><span style="color:#008080">127</span> <br><span style="color:#008080">128</span>             <span style="color:#008000">//</span><span style="color:#008000">先截断当前节点的左孩子</span><br><span style="color:#008080">129</span>             node.left =<span style="color:#000000"> top.right;<br></span><span style="color:#008080">130</span> <br><span style="color:#008080">131</span>             <span style="color:#008000">//</span><span style="color:#008000">将当前节点作为temp的右孩子</span><br><span style="color:#008080">132</span>             top.right =<span style="color:#000000"> node;<br></span><span style="color:#008080">133</span> <br><span style="color:#008080">134</span>             <span style="color:#0000ff">return</span><span style="color:#000000"> top;<br></span><span style="color:#008080">135</span> <span style="color:#000000">        }<br></span><span style="color:#008080">136</span>         <span style="color:#0000ff">#endregion</span><br><span style="color:#008080">137</span> <br><span style="color:#008080">138</span>         <span style="color:#0000ff">#region</span> 第二种：右右旋转（单旋转）<br><span style="color:#008080">139</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080">140</span>         <span style="color:#808080">///</span><span style="color:#008000"> 第二种：右右旋转（单旋转）<br></span><span style="color:#008080">141</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080">142</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;node&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080">143</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;returns&gt;&lt;/returns&gt;</span><br><span style="color:#008080">144</span>         <span style="color:#0000ff">public</span> TreapNode&lt;K, V&gt; RotateRR(TreapNode&lt;K, V&gt;<span style="color:#000000"> node)<br></span><span style="color:#008080">145</span> <span style="color:#000000">        {<br></span><span style="color:#008080">146</span>             <span style="color:#008000">//</span><span style="color:#008000">top：需要作为顶级节点的元素</span><br><span style="color:#008080">147</span>             <span style="color:#0000ff">var</span> top =<span style="color:#000000"> node.right;<br></span><span style="color:#008080">148</span> <br><span style="color:#008080">149</span>             <span style="color:#008000">//</span><span style="color:#008000">先截断当前节点的右孩子</span><br><span style="color:#008080">150</span>             node.right =<span style="color:#000000"> top.left;<br></span><span style="color:#008080">151</span> <br><span style="color:#008080">152</span>             <span style="color:#008000">//</span><span style="color:#008000">将当前节点作为temp的右孩子</span><br><span style="color:#008080">153</span>             top.left =<span style="color:#000000"> node;<br></span><span style="color:#008080">154</span> <br><span style="color:#008080">155</span>             <span style="color:#0000ff">return</span><span style="color:#000000"> top;<br></span><span style="color:#008080">156</span> <span style="color:#000000">        }<br></span><span style="color:#008080">157</span>         <span style="color:#0000ff">#endregion</span><br><span style="color:#008080">158</span> <br><span style="color:#008080">159</span>         <span style="color:#0000ff">#region</span> 树的指定范围查找<br><span style="color:#008080">160</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080">161</span>         <span style="color:#808080">///</span><span style="color:#008000"> 树的指定范围查找<br></span><span style="color:#008080">162</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080">163</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;min&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080">164</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;max&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080">165</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;returns&gt;&lt;/returns&gt;</span><br><span style="color:#008080">166</span>         <span style="color:#0000ff">public</span> HashSet&lt;V&gt;<span style="color:#000000"> SearchRange(K min, K max)<br></span><span style="color:#008080">167</span> <span style="color:#000000">        {<br></span><span style="color:#008080">168</span>             HashSet&lt;V&gt; hashSet = <span style="color:#0000ff">new</span> HashSet&lt;V&gt;<span style="color:#000000">();<br></span><span style="color:#008080">169</span> <br><span style="color:#008080">170</span>             hashSet =<span style="color:#000000"> SearchRange(min, max, hashSet, node);<br></span><span style="color:#008080">171</span> <br><span style="color:#008080">172</span>             <span style="color:#0000ff">return</span><span style="color:#000000"> hashSet;<br></span><span style="color:#008080">173</span> <span style="color:#000000">        }<br></span><span style="color:#008080">174</span>         <span style="color:#0000ff">#endregion</span><br><span style="color:#008080">175</span> <br><span style="color:#008080">176</span>         <span style="color:#0000ff">#region</span> 树的指定范围查找<br><span style="color:#008080">177</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080">178</span>         <span style="color:#808080">///</span><span style="color:#008000"> 树的指定范围查找<br></span><span style="color:#008080">179</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080">180</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;range1&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080">181</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;range2&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080">182</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;tree&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080">183</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;returns&gt;&lt;/returns&gt;</span><br><span style="color:#008080">184</span>         <span style="color:#0000ff">public</span> HashSet&lt;V&gt; SearchRange(K min, K max, HashSet&lt;V&gt; hashSet, TreapNode&lt;K, V&gt;<span style="color:#000000"> tree)<br></span><span style="color:#008080">185</span> <span style="color:#000000">        {<br></span><span style="color:#008080">186</span>             <span style="color:#0000ff">if</span> (tree == <span style="color:#0000ff">null</span><span style="color:#000000">)<br></span><span style="color:#008080">187</span>                 <span style="color:#0000ff">return</span><span style="color:#000000"> hashSet;<br></span><span style="color:#008080">188</span> <br><span style="color:#008080">189</span>             <span style="color:#008000">//</span><span style="color:#008000">遍历左子树（寻找下界）</span><br><span style="color:#008080">190</span>             <span style="color:#0000ff">if</span> (min.CompareTo(tree.key) &lt; <span style="color:#800080">0</span><span style="color:#000000">)<br></span><span style="color:#008080">191</span> <span style="color:#000000">                SearchRange(min, max, hashSet, tree.left);<br></span><span style="color:#008080">192</span> <br><span style="color:#008080">193</span>             <span style="color:#008000">//</span><span style="color:#008000">当前节点是否在选定范围内</span><br><span style="color:#008080">194</span>             <span style="color:#0000ff">if</span> (min.CompareTo(tree.key) &lt;= <span style="color:#800080">0</span> &amp;&amp; max.CompareTo(tree.key) &gt;= <span style="color:#800080">0</span><span style="color:#000000">)<br></span><span style="color:#008080">195</span> <span style="color:#000000">            {<br></span><span style="color:#008080">196</span>                 <span style="color:#008000">//</span><span style="color:#008000">等于这种情况</span><br><span style="color:#008080">197</span>                 <span style="color:#0000ff">foreach</span> (<span style="color:#0000ff">var</span> item <span style="color:#0000ff">in</span><span style="color:#000000"> tree.attach)<br></span><span style="color:#008080">198</span> <span style="color:#000000">                    hashSet.Add(item);<br></span><span style="color:#008080">199</span> <span style="color:#000000">            }<br></span><span style="color:#008080">200</span> <br><span style="color:#008080">201</span>             <span style="color:#008000">//</span><span style="color:#008000">遍历右子树（两种情况：①:找min的下限 ②：必须在Max范围之内）</span><br><span style="color:#008080">202</span>             <span style="color:#0000ff">if</span> (min.CompareTo(tree.key) &gt; <span style="color:#800080">0</span> || max.CompareTo(tree.key) &gt; <span style="color:#800080">0</span><span style="color:#000000">)<br></span><span style="color:#008080">203</span> <span style="color:#000000">                SearchRange(min, max, hashSet, tree.right);<br></span><span style="color:#008080">204</span> <br><span style="color:#008080">205</span>             <span style="color:#0000ff">return</span><span style="color:#000000"> hashSet;<br></span><span style="color:#008080">206</span> <span style="color:#000000">        }<br></span><span style="color:#008080">207</span>         <span style="color:#0000ff">#endregion</span><br><span style="color:#008080">208</span> <br><span style="color:#008080">209</span>         <span style="color:#0000ff">#region</span> 找到当前树的最小节点<br><span style="color:#008080">210</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080">211</span>         <span style="color:#808080">///</span><span style="color:#008000"> 找到当前树的最小节点<br></span><span style="color:#008080">212</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080">213</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;returns&gt;&lt;/returns&gt;</span><br><span style="color:#008080">214</span>         <span style="color:#0000ff">public</span> TreapNode&lt;K, V&gt;<span style="color:#000000"> FindMin()<br></span><span style="color:#008080">215</span> <span style="color:#000000">        {<br></span><span style="color:#008080">216</span>             <span style="color:#0000ff">return</span><span style="color:#000000"> FindMin(node);<br></span><span style="color:#008080">217</span> <span style="color:#000000">        }<br></span><span style="color:#008080">218</span>         <span style="color:#0000ff">#endregion</span><br><span style="color:#008080">219</span> <br><span style="color:#008080">220</span>         <span style="color:#0000ff">#region</span> 找到当前树的最小节点<br><span style="color:#008080">221</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080">222</span>         <span style="color:#808080">///</span><span style="color:#008000"> 找到当前树的最小节点<br></span><span style="color:#008080">223</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080">224</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;tree&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080">225</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;returns&gt;&lt;/returns&gt;</span><br><span style="color:#008080">226</span>         <span style="color:#0000ff">public</span> TreapNode&lt;K, V&gt; FindMin(TreapNode&lt;K, V&gt;<span style="color:#000000"> tree)<br></span><span style="color:#008080">227</span> <span style="color:#000000">        {<br></span><span style="color:#008080">228</span>             <span style="color:#0000ff">if</span> (tree == <span style="color:#0000ff">null</span><span style="color:#000000">)<br></span><span style="color:#008080">229</span>                 <span style="color:#0000ff">return</span> <span style="color:#0000ff">null</span><span style="color:#000000">;<br></span><span style="color:#008080">230</span> <br><span style="color:#008080">231</span>             <span style="color:#0000ff">if</span> (tree.left == <span style="color:#0000ff">null</span><span style="color:#000000">)<br></span><span style="color:#008080">232</span>                 <span style="color:#0000ff">return</span><span style="color:#000000"> tree;<br></span><span style="color:#008080">233</span> <br><span style="color:#008080">234</span>             <span style="color:#0000ff">return</span><span style="color:#000000"> FindMin(tree.left);<br></span><span style="color:#008080">235</span> <span style="color:#000000">        }<br></span><span style="color:#008080">236</span>         <span style="color:#0000ff">#endregion</span><br><span style="color:#008080">237</span> <br><span style="color:#008080">238</span>         <span style="color:#0000ff">#region</span> 找到当前树的最大节点<br><span style="color:#008080">239</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080">240</span>         <span style="color:#808080">///</span><span style="color:#008000"> 找到当前树的最大节点<br></span><span style="color:#008080">241</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080">242</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;returns&gt;&lt;/returns&gt;</span><br><span style="color:#008080">243</span>         <span style="color:#0000ff">public</span> TreapNode&lt;K, V&gt;<span style="color:#000000"> FindMax()<br></span><span style="color:#008080">244</span> <span style="color:#000000">        {<br></span><span style="color:#008080">245</span>             <span style="color:#0000ff">return</span><span style="color:#000000"> FindMin(node);<br></span><span style="color:#008080">246</span> <span style="color:#000000">        }<br></span><span style="color:#008080">247</span>         <span style="color:#0000ff">#endregion</span><br><span style="color:#008080">248</span> <br><span style="color:#008080">249</span>         <span style="color:#0000ff">#region</span> 找到当前树的最大节点<br><span style="color:#008080">250</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080">251</span>         <span style="color:#808080">///</span><span style="color:#008000"> 找到当前树的最大节点<br></span><span style="color:#008080">252</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080">253</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;tree&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080">254</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;returns&gt;&lt;/returns&gt;</span><br><span style="color:#008080">255</span>         <span style="color:#0000ff">public</span> TreapNode&lt;K, V&gt; FindMax(TreapNode&lt;K, V&gt;<span style="color:#000000"> tree)<br></span><span style="color:#008080">256</span> <span style="color:#000000">        {<br></span><span style="color:#008080">257</span>             <span style="color:#0000ff">if</span> (tree == <span style="color:#0000ff">null</span><span style="color:#000000">)<br></span><span style="color:#008080">258</span>                 <span style="color:#0000ff">return</span> <span style="color:#0000ff">null</span><span style="color:#000000">;<br></span><span style="color:#008080">259</span> <br><span style="color:#008080">260</span>             <span style="color:#0000ff">if</span> (tree.right == <span style="color:#0000ff">null</span><span style="color:#000000">)<br></span><span style="color:#008080">261</span>                 <span style="color:#0000ff">return</span><span style="color:#000000"> tree;<br></span><span style="color:#008080">262</span> <br><span style="color:#008080">263</span>             <span style="color:#0000ff">return</span><span style="color:#000000"> FindMax(tree.right);<br></span><span style="color:#008080">264</span> <span style="color:#000000">        }<br></span><span style="color:#008080">265</span>         <span style="color:#0000ff">#endregion</span><br><span style="color:#008080">266</span> <br><span style="color:#008080">267</span>         <span style="color:#0000ff">#region</span> 删除当前树中的节点<br><span style="color:#008080">268</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080">269</span>         <span style="color:#808080">///</span><span style="color:#008000"> 删除当前树中的节点<br></span><span style="color:#008080">270</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080">271</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;key&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080">272</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;returns&gt;&lt;/returns&gt;</span><br><span style="color:#008080">273</span>         <span style="color:#0000ff">public</span> <span style="color:#0000ff">void</span><span style="color:#000000"> Remove(K key, V value)<br></span><span style="color:#008080">274</span> <span style="color:#000000">        {<br></span><span style="color:#008080">275</span>             node =<span style="color:#000000"> Remove(key, value, node);<br></span><span style="color:#008080">276</span> <span style="color:#000000">        }<br></span><span style="color:#008080">277</span>         <span style="color:#0000ff">#endregion</span><br><span style="color:#008080">278</span> <br><span style="color:#008080">279</span>         <span style="color:#0000ff">#region</span> 删除当前树中的节点<br><span style="color:#008080">280</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;summary&gt;</span><br><span style="color:#008080">281</span>         <span style="color:#808080">///</span><span style="color:#008000"> 删除当前树中的节点<br></span><span style="color:#008080">282</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;/summary&gt;</span><br><span style="color:#008080">283</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;key&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080">284</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;param name=&quot;tree&quot;&gt;&lt;/param&gt;</span><br><span style="color:#008080">285</span>         <span style="color:#808080">///</span> <span style="color:#808080">&lt;returns&gt;&lt;/returns&gt;</span><br><span style="color:#008080">286</span>         <span style="color:#0000ff">public</span> TreapNode&lt;K, V&gt; Remove(K key, V value, TreapNode&lt;K, V&gt;<span style="color:#000000"> tree)<br></span><span style="color:#008080">287</span> <span style="color:#000000">        {<br></span><span style="color:#008080">288</span>             <span style="color:#0000ff">if</span> (tree == <span style="color:#0000ff">null</span><span style="color:#000000">)<br></span><span style="color:#008080">289</span>                 <span style="color:#0000ff">return</span> <span style="color:#0000ff">null</span><span style="color:#000000">;<br></span><span style="color:#008080">290</span> <br><span style="color:#008080">291</span>             <span style="color:#008000">//</span><span style="color:#008000">左子树</span><br><span style="color:#008080">292</span>             <span style="color:#0000ff">if</span> (key.CompareTo(tree.key) &lt; <span style="color:#800080">0</span><span style="color:#000000">)<br></span><span style="color:#008080">293</span> <span style="color:#000000">            {<br></span><span style="color:#008080">294</span>                 tree.left =<span style="color:#000000"> Remove(key, value, tree.left);<br></span><span style="color:#008080">295</span> <span style="color:#000000">            }<br></span><span style="color:#008080">296</span>             <span style="color:#008000">//</span><span style="color:#008000">右子树</span><br><span style="color:#008080">297</span>             <span style="color:#0000ff">if</span> (key.CompareTo(tree.key) &gt; <span style="color:#800080">0</span><span style="color:#000000">)<br></span><span style="color:#008080">298</span> <span style="color:#000000">            {<br></span><span style="color:#008080">299</span>                 tree.right =<span style="color:#000000"> Remove(key, value, tree.right);<br></span><span style="color:#008080">300</span> <span style="color:#000000">            }<br></span><span style="color:#008080">301</span>             <span style="color:#008000">/*</span><span style="color:#008000">相等的情况</span><span style="color:#008000">*/</span><br><span style="color:#008080">302</span>             <span style="color:#0000ff">if</span> (key.CompareTo(tree.key) == <span style="color:#800080">0</span><span style="color:#000000">)<br></span><span style="color:#008080">303</span> <span style="color:#000000">            {<br></span><span style="color:#008080">304</span>                 <span style="color:#008000">//</span><span style="color:#008000">判断里面的HashSet是否有多值</span><br><span style="color:#008080">305</span>                 <span style="color:#0000ff">if</span> (tree.attach.Count &gt; <span style="color:#800080">1</span><span style="color:#000000">)<br></span><span style="color:#008080">306</span> <span style="color:#000000">                {<br></span><span style="color:#008080">307</span>                     <span style="color:#008000">//</span><span style="color:#008000">实现惰性删除</span><br><span style="color:#008080">308</span> <span style="color:#000000">                    tree.attach.Remove(value);<br></span><span style="color:#008080">309</span> <span style="color:#000000">                }<br></span><span style="color:#008080">310</span>                 <span style="color:#0000ff">else</span><br><span style="color:#008080">311</span> <span style="color:#000000">                {<br></span><span style="color:#008080">312</span>                     <span style="color:#008000">//</span><span style="color:#008000">有两个孩子的情况</span><br><span style="color:#008080">313</span>                     <span style="color:#0000ff">if</span> (tree.left != <span style="color:#0000ff">null</span> &amp;&amp; tree.right != <span style="color:#0000ff">null</span><span style="color:#000000">)<br></span><span style="color:#008080">314</span> <span style="color:#000000">                    {<br></span><span style="color:#008080">315</span>                         <span style="color:#008000">//</span><span style="color:#008000">如果左孩子的优先级低就需要“左旋”</span><br><span style="color:#008080">316</span>                         <span style="color:#0000ff">if</span> (tree.left.priority &lt;<span style="color:#000000"> tree.right.priority)<br></span><span style="color:#008080">317</span> <span style="color:#000000">                        {<br></span><span style="color:#008080">318</span>                             tree =<span style="color:#000000"> RotateLL(tree);<br></span><span style="color:#008080">319</span> <span style="color:#000000">                        }<br></span><span style="color:#008080">320</span>                         <span style="color:#0000ff">else</span><br><span style="color:#008080">321</span> <span style="color:#000000">                        {<br></span><span style="color:#008080">322</span>                             <span style="color:#008000">//</span><span style="color:#008000">否则“右旋”</span><br><span style="color:#008080">323</span>                             tree =<span style="color:#000000"> RotateRR(tree);<br></span><span style="color:#008080">324</span> <span style="color:#000000">                        }<br></span><span style="color:#008080">325</span> <br><span style="color:#008080">326</span>                         <span style="color:#008000">//</span><span style="color:#008000">继续旋转</span><br><span style="color:#008080">327</span>                         tree =<span style="color:#000000"> Remove(key, value, tree);<br></span><span style="color:#008080">328</span> <span style="color:#000000">                    }<br></span><span style="color:#008080">329</span>                     <span style="color:#0000ff">else</span><br><span style="color:#008080">330</span> <span style="color:#000000">                    {<br></span><span style="color:#008080">331</span>                         <span style="color:#008000">//</span><span style="color:#008000">如果旋转后已经变成了叶子节点则直接删除</span><br><span style="color:#008080">332</span>                         <span style="color:#0000ff">if</span> (tree == <span style="color:#0000ff">null</span><span style="color:#000000">)<br></span><span style="color:#008080">333</span>                             <span style="color:#0000ff">return</span> <span style="color:#0000ff">null</span><span style="color:#000000">;<br></span><span style="color:#008080">334</span> <br><span style="color:#008080">335</span>                         <span style="color:#008000">//</span><span style="color:#008000">最后就是单支树</span><br><span style="color:#008080">336</span>                         tree = tree.left == <span style="color:#0000ff">null</span> ?<span style="color:#000000"> tree.right : tree.left;<br></span><span style="color:#008080">337</span> <span style="color:#000000">                    }<br></span><span style="color:#008080">338</span> <span style="color:#000000">                }<br></span><span style="color:#008080">339</span> <span style="color:#000000">            }<br></span><span style="color:#008080">340</span> <br><span style="color:#008080">341</span>             <span style="color:#0000ff">return</span><span style="color:#000000"> tree;<br></span><span style="color:#008080">342</span> <span style="color:#000000">        }<br></span><span style="color:#008080">343</span>         <span style="color:#0000ff">#endregion</span><br><span style="color:#008080">344</span> <span style="color:#000000">    }<br></span><span style="color:#008080">345</span> }</div></div>


<p> </p>


<p> </p>


<p><img src="http://www.cnblogs.com/huangxincheng/aggbug/2614484.html?type=1" width="1" height="1" alt=""><p><a href="http://www.cnblogs.com/huangxincheng/archive/2012/07/30/2614484.html">本文链接</a></p></p>

</div>


            <div class="footer">
              <div class="contact">
                <p>
                  Your Name<br />
                  What You Are<br />
                  your@email.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/yourusername/">github.com/yourusername</a><br />
                  <a href="http://twitter.com/yourusername/">twitter.com/yourusername</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

    </body>
</html>
