<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>知名网站的技术发展历程</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/">Your New Jekyll Site</a></h1>
              <a class="extra" href="/">home</a>
            </div>

                <h2>知名网站的技术发展历程</h2>
<p class="meta">25 May 2012</p>

<div class="post">
<h2>知名网站的技术发展历程</h2>

<h3>by baiyuzhong</h3>

<h3>at 2012-05-25 09:10:57</h3>

<h3>original <a href="http://www.programmer.com.cn/11800/">http://www.programmer.com.cn/11800/</a></h3>

<p><span style="color:#000000"><strong>文 /  林昊</strong></span></p>


<p><span style="color:#808080"><strong>互联网已经发展多年，其中不乏脱颖而出者，这些网站多数都已存在了接近<span style="font-family:Times New Roman">10</span><span style="font-family:宋体">年或</span><span style="font-family:Times New Roman">10</span><span style="font-family:宋体">年以上，在如此长时间的发展过程中，除了业务上面临的挑战，在技术上也面临了很多的挑战。</span>我挑选了一些<a href="http://www.alexa.com/topsites"><span style="font-family:Times New Roman">Alexa</span></a><span style="font-family:宋体"><a href="http://www.alexa.com/topsites">排名较前的网站</a>（</span><span style="font-family:宋体">排名截止到</span><span style="font-family:Times New Roman">2012</span><span style="font-family:宋体">年</span><span style="font-family:Times New Roman">4</span><span style="font-family:宋体">月</span><span style="font-family:Times New Roman">21</span><span style="font-family:宋体">日），看看它们在技术上是如何应对业务发展过程中的挑战的。<span></span></span></strong></span></p>


<p style="text-align:center"><strong><img title="谷歌" src="http://www.programmer.com.cn/wp-content/uploads/2012/05/%E8%B0%B7%E6%AD%8C.jpg" alt="" width="144" height="62"></strong></p>


<p>Google<span style="font-family:宋体">目前</span><span style="font-family:Times New Roman">Alexa</span><span style="font-family:宋体">排名第</span><span style="font-family:Times New Roman">1</span><span style="font-family:宋体">。它诞生于</span><span style="font-family:Times New Roman">1997</span><span style="font-family:宋体">年，当时是一个研究性项目，每个月</span><span style="font-family:Times New Roman">build</span><span style="font-family:宋体">一次索引，</span><span style="font-family:Times New Roman">build</span><span style="font-family:宋体">出来的索引通过</span><span style="font-family:Times New Roman">sharding</span><span style="font-family:宋体">（</span><span style="font-family:Times New Roman">shard by doc</span><span style="font-family:宋体">）的方式分散到多台服务器（</span><span style="font-family:Times New Roman">Index Server</span><span style="font-family:宋体">）上，具体的网页数据同样通过</span><span style="font-family:Times New Roman">sharding</span><span style="font-family:宋体">的方式分散到多台服务器（</span><span style="font-family:Times New Roman">Doc Server</span><span style="font-family:宋体">）上，当用户提交请求时，通过前端的一台服务器将请求提交给</span><span style="font-family:Times New Roman">Index Server</span><span style="font-family:宋体">获得打了分的倒排索引，然后从</span><span style="font-family:Times New Roman">Doc Server</span><span style="font-family:宋体">提取具体的网页信息（例如网页标题、搜索关键词匹配的片段信息等），最终展现给用户。</span></p>


<p>随着索引的网页增加，这个结构可通过增加<span style="font-family:Times New Roman">Index Server</span><span style="font-family:宋体">以及</span><span style="font-family:Times New Roman">Doc Server</span><span style="font-family:宋体">来存储索引以及网页的数据，但仍然会面临其他很多方面的问题，于是在这之后的十多年的时间里，</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">做了很多事情来改进上面的结构。</span></p>


<p>1999<span style="font-family:宋体">年，</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">增加了一个</span><span style="font-family:Times New Roman">Cache Cluster</span><span style="font-family:宋体">，用来</span><span style="font-family:Times New Roman">Cache</span><span style="font-family:宋体">查询的索引结果和文档片段信息，同时将</span><span style="font-family:Times New Roman">Index Server</span><span style="font-family:宋体">和</span><span style="font-family:Times New Roman">Doc Server</span><span style="font-family:宋体">通过</span><span style="font-family:Times New Roman">Replicate</span><span style="font-family:宋体">的方式变成了</span><span style="font-family:Times New Roman">Cluster</span><span style="font-family:宋体">。这两个改造带来的好处是网站的响应速度、可支撑的访问量以及可用性（</span><span style="font-family:Times New Roman">Availability</span><span style="font-family:宋体">）得到了提升。</span>这个变化造成了成本的增加，<span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">在硬件方面的风格始终是不用昂贵的高端硬件，而是在软件层面来保证系统的可靠性及高性能，于是同年，</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">开始采用自行设计的服务器来降低成本。</span>2000<span style="font-family:宋体">年，</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">开始自行设计</span><span style="font-family:Times New Roman">DataCenter</span><span style="font-family:宋体">，采用了各种方法（例如采用其他的制冷方法来替代空调）来优化</span><span style="font-family:Times New Roman">PUE</span><span style="font-family:宋体">（能源利用率），同时对自行设计的服务器也做了很多化。</span>2001<span style="font-family:宋体">年，</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">对</span><span style="font-family:Times New Roman">Index</span><span style="font-family:宋体">的格式进行了修改，将所有的</span><span style="font-family:Times New Roman">Index</span><span style="font-family:宋体">放入内存， 这次改造带来的好处是网站的响应速度以及可支撑的访问量得到了极大的提升。</span>2003<span style="font-family:宋体">年，</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">发表了文章</span><span style="font-family:Times New Roman">Google Cluster Architecture</span><span style="font-family:宋体">，其</span><span style="font-family:Times New Roman">Cluster</span><span style="font-family:宋体">结构组成为硬件</span><span style="font-family:Times New Roman">LB+Index Cluster+Doc Cluster+</span><span style="font-family:宋体">大量廉价服务器（例如</span><span style="font-family:Times New Roman">IDE</span><span style="font-family:宋体">硬盘、性价比高的</span><span style="font-family:Times New Roman">CPU</span><span style="font-family:宋体">等），通过并行处理</span><span style="font-family:Times New Roman">+sharding</span><span style="font-family:宋体">来保证在降低对硬件要求的同时，响应速度仍然很快。同年</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">发表了关于</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">文件系统的论文（</span><span style="font-family:Times New Roman">GFS</span><span style="font-family:宋体">在</span><span style="font-family:Times New Roman">2000</span><span style="font-family:宋体">年就已经上线），这篇论文很大程度也体现了</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">不用昂贵硬件的风格，通过</span><span style="font-family:Times New Roman">GFS+</span><span style="font-family:宋体">大量廉价的服务器即可存储大量的数据。</span>2004<span style="font-family:宋体">年，</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">再次对</span><span style="font-family:Times New Roman">Index</span><span style="font-family:宋体">的格式进行了修改，使得网站的响应速度继续提升。同年</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">发表关于</span><span style="font-family:Times New Roman">MapReduce</span><span style="font-family:宋体">的论文，通过</span><span style="font-family:Times New Roman">MapReduce+</span><span style="font-family:宋体">大量廉价的服务器即可快速完成以前要使用昂贵小型机、中型机甚至是大型机才能完成的计算任务，而这显然对于</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">快速地构建索引提供了很大的帮助。</span>2006<span style="font-family:宋体">年，</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">发表了关于</span><span style="font-family:Times New Roman">BigTable</span><span style="font-family:宋体">的论文（</span><span style="font-family:Times New Roman">2003</span><span style="font-family:宋体">年开始上线），使得海量数据的分析能够达到在线系统的要求了，这对于</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">提升网站的响应速度起到了很大的帮助。</span></p>


<p>以上<span style="font-family:Times New Roman">3</span><span style="font-family:宋体">篇论文彻底改变了业界对于海量数据的存储、分析和检索的方法（小道消息：</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">内部已完成了</span><span style="font-family:Times New Roman">GFS</span><span style="font-family:宋体">、</span><span style="font-family:Times New Roman">MapReduce</span><span style="font-family:宋体">、</span><span style="font-family:Times New Roman">BigTable</span><span style="font-family:宋体">的替换），也奠定了</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">在业界的技术领导地位。</span></p>


<p>在一些场景中，<span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">也采用</span><span style="font-family:Times New Roman">MySQL</span><span style="font-family:宋体">来存储数据。同样，</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">对</span><span style="font-family:Times New Roman">MySQL</span><span style="font-family:宋体">也做了很多修改，它使用的</span><span style="font-family:Times New Roman">MySQL</span><span style="font-family:宋体">信息可以从</span><a href="https://code.google.com/p/google-mysql/"><span style="font-family:Times New Roman">https://code.google.com/p/google-mysql/</span></a><span style="font-family:宋体">了解。</span></p>


<p>2007<span style="font-family:宋体">年，</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">将</span><span style="font-family:Times New Roman">build</span><span style="font-family:宋体">索引的时间缩短到分钟级，当新网页出现后，几分钟后即可在</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">搜索到，同时将</span><span style="font-family:Times New Roman">Index Cluster</span><span style="font-family:宋体">通过</span><span style="font-family:Times New Roman">Protocol Buffers</span><span style="font-family:宋体">对外提供</span><span style="font-family:Times New Roman">Service</span><span style="font-family:宋体">，以供</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">各种搜索（例如网页、图片、新闻、书籍等）使用，除了</span><span style="font-family:Times New Roman">Index Cluster</span><span style="font-family:宋体">提供的</span><span style="font-family:Times New Roman">Service</span><span style="font-family:宋体">外，还有很多其他的</span><span style="font-family:Times New Roman">Service</span><span style="font-family:宋体">，例如广告、词法检查等。</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">的一次搜索大概需要调用内部</span><span style="font-family:Times New Roman">50</span><span style="font-family:宋体">个以上的</span><span style="font-family:Times New Roman">Service</span><span style="font-family:宋体">，</span><span style="font-family:Times New Roman">Service</span><span style="font-family:宋体">主要用</span><span style="font-family:Times New Roman">C++</span><span style="font-family:宋体">或</span><span style="font-family:Times New Roman">Java</span><span style="font-family:宋体">来编写。</span>2009<span style="font-family:宋体">年，</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">的一篇《</span><span style="font-family:Times New Roman">How Google uses Linux</span><span style="font-family:宋体">》文章，揭示了</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">在提升机器利用率方面也做了很多的努力，例如将不同资源消耗类型的应用部署在同一台机器上。</span></p>


<p>在之后，<span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">又研发了</span><span style="font-family:Times New Roman">Colossus</span><span style="font-family:宋体">（下一代类</span><span style="font-family:Times New Roman">GFS</span><span style="font-family:宋体">文件系统）、</span><span style="font-family:Times New Roman">Spanner</span><span style="font-family:宋体">（下一代类</span><span style="font-family:Times New Roman">BigTable</span><span style="font-family:宋体">海量存储和计算架构）、实时搜索（基于</span><span style="font-family:Times New Roman">Colossus</span><span style="font-family:宋体">实现），主要都是为了提升搜索的实时性以及存储更多数据。</span>除了在海量数据相关技术上的革新外，<span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">也不断对业界的传统技术进行创新，例如提高</span><span style="font-family:Times New Roman">TCP</span><span style="font-family:宋体">的初始拥塞窗口值、改进</span><span style="font-family:Times New Roman">HTTP</span><span style="font-family:宋体">的</span><span style="font-family:Times New Roman">SPDY</span><span style="font-family:宋体">协议、新的图片格式</span><span style="font-family:Times New Roman">WebP</span><span style="font-family:宋体">等。</span></p>


<p>在<span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">的发展过程中，其技术的改造主要围绕在可伸缩性、性能、成本和可用性</span><span style="font-family:Times New Roman">4</span><span style="font-family:宋体">个方面，</span><span style="font-family:Times New Roman">Google</span><span style="font-family:宋体">不采用昂贵硬件的风格以及领先其他网站的数据量决定了其技术改造基本都是对传统的软硬件技术的革新。</span></p>


<p style="text-align:center"><span style="color:#888888"><strong><img title="facebook" src="http://www.programmer.com.cn/wp-content/uploads/2012/05/facebook.jpg" alt="" width="154" height="57"></strong></span></p>


<p>Facebook<span style="font-family:宋体">目前</span><span style="font-family:Times New Roman">Alexa</span><span style="font-family:宋体">排名第</span><span style="font-family:Times New Roman">2</span><span style="font-family:宋体">。它采用</span><span style="font-family:Times New Roman">LAMP</span><span style="font-family:宋体">构建，随着业务的发展，它也在技术上做了很多改</span>造。</p>


<p>作为改造的第一步，<span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">首先在</span><span style="font-family:Times New Roman">LAMP</span><span style="font-family:宋体">结构中增加了</span><span style="font-family:Times New Roman">Memcached</span><span style="font-family:宋体">，用来缓存各种数据，从而大幅度提升系统的响应时间以及可支撑的访问量，之后又增加了</span><span style="font-family:Times New Roman">Services</span><span style="font-family:宋体">层，将</span><span style="font-family:Times New Roman">News Feed</span><span style="font-family:宋体">、</span><span style="font-family:Times New Roman">Search</span><span style="font-family:宋体">等较通用的功能作为</span><span style="font-family:Times New Roman">Service</span><span style="font-family:宋体">提供给前端的</span><span style="font-family:Times New Roman">PHP</span><span style="font-family:宋体">系统使用，前端的系统通过</span><span style="font-family:Times New Roman">Thrift</span><span style="font-family:宋体">访问这些</span><span style="font-family:Times New Roman">Service</span><span style="font-family:宋体">。</span><span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">采用了多种语言来编写各种不同的</span><span style="font-family:Times New Roman">Service</span><span style="font-family:宋体">，主要是针对不同的场景选择合适的语言，例如</span><span style="font-family:Times New Roman">C++</span><span style="font-family:宋体">、</span><span style="font-family:Times New Roman">Java</span><span style="font-family:宋体">、</span><span style="font-family:Times New Roman">Erlang</span><span style="font-family:宋体">。</span></p>


<p>大量使用<span style="font-family:Times New Roman">Memcached</span><span style="font-family:宋体">以及访问量的不断上涨，导致访问</span><span style="font-family:Times New Roman">Memcached</span><span style="font-family:宋体">的网络流量太大，交换机无法支撑，</span><span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">通过改造采用</span><span style="font-family:Times New Roman">UDP</span><span style="font-family:宋体">的方式来访问</span><span style="font-family:Times New Roman">Memcached</span><span style="font-family:宋体">，以降低单连接上的网络流量。除此之外，还有其他一些改造，具体信息可以查看</span><a href="http://on.fb.me/8R0C"><span style="font-family:Times New Roman">http://on.fb.me/8R0C</span></a><span style="font-family:宋体">。</span></p>


<p>PHP<span style="font-family:宋体">作为脚本语言，优势是开发简单、易上手，劣势是需要消耗较多的</span><span style="font-family:Times New Roman">CPU</span><span style="font-family:宋体">和内存。当</span><span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">的访问量增长到了一定规模后，这个劣势就比较突出了，于是从</span><span style="font-family:Times New Roman">2007</span><span style="font-family:宋体">年起，</span><span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">就尝试多种方法来解决这个问题，最后诞生于</span><span style="font-family:Times New Roman">Facebook Hackathon</span><span style="font-family:宋体">的</span><span style="font-family:Times New Roman">HipHop</span><span style="font-family:宋体">产品成功地脱颖而出。</span><span style="font-family:Times New Roman">HipHop</span><span style="font-family:宋体">可以自动将</span><span style="font-family:Times New Roman">PHP</span><span style="font-family:宋体">转化为</span><span style="font-family:Times New Roman">C++</span><span style="font-family:宋体">代码，</span><span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">在使用</span><span style="font-family:Times New Roman">HipHop</span><span style="font-family:宋体">后，同等配置的机器，可支撑的请求量是之前的</span><span style="font-family:Times New Roman">6</span><span style="font-family:宋体">倍，</span><span style="font-family:Times New Roman">CPU</span><span style="font-family:宋体">的使用率平均下降了</span><span style="font-family:Times New Roman">50%</span><span style="font-family:宋体">，从而为</span><span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">节省了大量主机。将来</span><span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">还会对</span><span style="font-family:Times New Roman">HipHop</span><span style="font-family:宋体">进行再次改进，通过</span><span style="font-family:Times New Roman">HipHop</span><span style="font-family:宋体">将</span><span style="font-family:Times New Roman">PHP</span><span style="font-family:宋体">编译为</span><span style="font-family:Times New Roman">bytecode</span><span style="font-family:宋体">，放入</span><span style="font-family:Times New Roman">HipHop VM</span><span style="font-family:宋体">中执行，再由</span><span style="font-family:Times New Roman">HipHop VM</span><span style="font-family:宋体">来编译为机器代码，方式与</span><span style="font-family:Times New Roman">JIT</span><span style="font-family:宋体">类似。</span></p>


<p>2009<span style="font-family:宋体">年，</span><span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">研发了</span><span style="font-family:Times New Roman">BigPipe</span><span style="font-family:宋体">，借助此系统，</span><span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">成功让网站的速度提升了两倍。随着</span><span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">访问量的上涨，收集众多服务器上的执行日志也开始面临挑战，于是</span><span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">研发了</span><span style="font-family:Times New Roman">Scribe</span><span style="font-family:宋体">来解决此问题。</span>对于存储在<span style="font-family:Times New Roman">MySQL</span><span style="font-family:宋体">中的数据，</span><span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">采用垂直拆分库和水平拆分表的方式来支撑不断增长的数据量。</span>作为<span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">技术体系中重要的一环，</span><span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">也对</span><span style="font-family:Times New Roman">MySQL</span><span style="font-family:宋体">进行了很多优化和改进，例如</span><span style="font-family:Times New Roman">Online Schema Change</span><span style="font-family:宋体">等，更多信息可见</span><a href="http://www.facebook.com/MySQLAtFacebook"><span style="font-family:Times New Roman">http://www.facebook.com/MySQLAtFacebook</span></a><span style="font-family:宋体">。</span></p>


<p>发展之初的<span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">采用了高端的存储设备（例如</span><span style="font-family:Times New Roman">NetApp</span><span style="font-family:宋体">、</span><span style="font-family:Times New Roman">Akamai</span><span style="font-family:宋体">）来存图片，随着图片不断增加，成本也大幅提高，于是</span><span style="font-family:Times New Roman">2009</span><span style="font-family:宋体">年</span><span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">开发了</span><span style="font-family:Times New Roman">Haystack</span><span style="font-family:宋体">来存储图片。</span><span style="font-family:Times New Roman">Haystack</span><span style="font-family:宋体">可采用廉价的</span><span style="font-family:Times New Roman">PC Server</span><span style="font-family:宋体">进行存储，大幅度降低了成本。</span></p>


<p>Facebook<span style="font-family:宋体">除了使用</span><span style="font-family:Times New Roman">MySQL</span><span style="font-family:宋体">存储数据外，近几年也开始摸索采用新的方式。在</span><span style="font-family:Times New Roman">2008</span><span style="font-family:宋体">年</span><span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">开发了</span><span style="font-family:Times New Roman">Cassandra</span><span style="font-family:宋体">，在</span><span style="font-family:Times New Roman">Message Inbox Search</span><span style="font-family:宋体">中作为新的存储方式。不过在</span><span style="font-family:Times New Roman">2010</span><span style="font-family:宋体">年，</span><span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">又放弃了</span><span style="font-family:Times New Roman">Cassandra</span><span style="font-family:宋体">，转为采用</span><span style="font-family:Times New Roman">HBase</span><span style="font-family:宋体">作为其</span><span style="font-family:Times New Roman">Messages</span><span style="font-family:宋体">的存储，并在</span><span style="font-family:Times New Roman">2011</span><span style="font-family:宋体">年将</span><span style="font-family:Times New Roman">HBase</span><span style="font-family:宋体">应用在了</span><span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">更多的项目上（例如</span><span style="font-family:Times New Roman">Puma</span><span style="font-family:宋体">、</span><span style="font-family:Times New Roman">ODS</span><span style="font-family:宋体">）。据说，现在</span><span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">更是在尝试将其用户以及关系数据从</span><span style="font-family:Times New Roman">MySQL</span><span style="font-family:宋体">迁移到</span><span style="font-family:Times New Roman">HBase</span><span style="font-family:宋体">。</span></p>


<p>从<span style="font-family:Times New Roman">2009</span><span style="font-family:宋体">年开始，</span><span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">尝试自行设计</span><span style="font-family:Times New Roman">DataCenter</span><span style="font-family:宋体">以及服务器，以降低其运行成本，并对外开放了其构建的</span><span style="font-family:Times New Roman">PUE</span><span style="font-family:宋体">仅</span><span style="font-family:Times New Roman">1.07</span><span style="font-family:宋体">的</span><span style="font-family:Times New Roman">DataCenter</span><span style="font-family:宋体">的相关技术。</span>Facebook<span style="font-family:宋体">在技术方面的基本原则是：“在能用开源产品的情况下就用开源，根据情况对其进行优化并反馈给社区”。从</span><span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">的技术发展历程上可以看到这个原则贯彻始终，</span><span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">的技术改造也主要是围绕在可伸缩、性能、成本和可用性</span><span style="font-family:Times New Roman">4</span><span style="font-family:宋体">个方面。</span></p>


<p style="text-align:center"><span style="color:#888888"><strong><img title="twitter" src="http://www.programmer.com.cn/wp-content/uploads/2012/05/twitter.jpg" alt="" width="149" height="56"></strong></span></p>


<p>Twitter目前<span style="font-family:Times New Roman">Alexa</span><span style="font-family:宋体">排名第</span><span style="font-family:Times New Roman">8</span><span style="font-family:宋体">。</span>在<span style="font-family:Times New Roman">2006</span><span style="font-family:宋体">年诞生之时是采用</span><span style="font-family:Times New Roman">Ruby On Rails+ MySQL</span><span style="font-family:宋体">构建的，</span><span style="font-family:Times New Roman">2007</span><span style="font-family:宋体">年增加了</span><span style="font-family:Times New Roman">Memcached</span><span style="font-family:宋体">作为</span><span style="font-family:Times New Roman">Cache</span><span style="font-family:宋体">层，以提升响应速度。</span>基于<span style="font-family:Times New Roman">Ruby on Rails</span><span style="font-family:宋体">让</span><span style="font-family:Times New Roman">Twitter</span><span style="font-family:宋体">享受到了快速的开发能力，但随着访问量的增长，其对</span><span style="font-family:Times New Roman">CPU</span><span style="font-family:宋体">和内存的消耗也让</span><span style="font-family:Times New Roman">Twitter</span><span style="font-family:宋体">痛苦不堪，于是</span><span style="font-family:Times New Roman">Twitter</span><span style="font-family:宋体">做了不少改造和努力，例如编写了一个优化版的</span><span style="font-family:Times New Roman">Ruby GC</span><span style="font-family:宋体">。</span></p>


<p>2008<span style="font-family:宋体">年</span><span style="font-family:Times New Roman">Twitter</span><span style="font-family:宋体">决定逐步往</span><span style="font-family:Times New Roman">Java</span><span style="font-family:宋体">迁移，选择了</span><span style="font-family:Times New Roman">Scala</span><span style="font-family:宋体">作为主力的开发语言（理由是“难以向一屋子的</span><span style="font-family:Times New Roman">Ruby</span><span style="font-family:宋体">程序员推销</span><span style="font-family:Times New Roman">Java</span><span style="font-family:宋体">”），采用</span><span style="font-family:Times New Roman">Thrift</span><span style="font-family:宋体">作为其主要的通信框架，开发了</span><span style="font-family:Times New Roman">Finagle</span><span style="font-family:宋体">作为其</span><span style="font-family:Times New Roman">Service Framework</span><span style="font-family:宋体">，可将后端各种功能暴露为</span><span style="font-family:Times New Roman">Service</span><span style="font-family:宋体">提供给前端系统使用，使得前端系统无需关心各种不同的通信协议（例如对于使用者可以用同样的调用服务的方式去访问</span><span style="font-family:Times New Roman">Memcache</span><span style="font-family:宋体">、</span><span style="font-family:Times New Roman">Redis</span><span style="font-family:宋体">、</span><span style="font-family:Times New Roman">Thrift</span><span style="font-family:宋体">服务端），开发了</span><span style="font-family:Times New Roman">Kestrel</span><span style="font-family:宋体">作为其消息中间件（替代之前用</span><span style="font-family:Times New Roman">Ruby</span><span style="font-family:宋体">写的</span><span style="font-family:Times New Roman">Starling</span><span style="font-family:宋体">）。</span></p>


<p>Twitter<span style="font-family:宋体">的数据存储一直采用</span><span style="font-family:Times New Roman">MySQL</span><span style="font-family:宋体">，发展过程中出现的小插曲是，当</span><span style="font-family:Times New Roman">Facebook</span><span style="font-family:宋体">开源了</span><span style="font-family:Times New Roman">Cassandra</span><span style="font-family:宋体">时，</span><span style="font-family:Times New Roman">Twitter</span><span style="font-family:宋体">本计划使用，但最终还是放弃，仍然保持了使用</span><span style="font-family:Times New Roman">MySQL</span><span style="font-family:宋体">，</span><span style="font-family:Times New Roman">Twitter</span><span style="font-family:宋体">的</span><span style="font-family:Times New Roman">MySQL</span><span style="font-family:宋体">版本已开源（</span><a href="https://github.com/twitter/mysql"><span style="font-family:Times New Roman">https://github.com/twitter/mysql</span></a><span style="font-family:宋体">）。</span><span style="font-family:Times New Roman">Twitter</span><span style="font-family:宋体">也是采用分库分表的方式来支撑大数据量，使用</span><span style="font-family:Times New Roman">Memcached</span><span style="font-family:宋体">来</span><span style="font-family:Times New Roman">Cache tweet</span><span style="font-family:宋体">，</span><span style="font-family:Times New Roman">timeline</span><span style="font-family:宋体">的信息则迁移为用</span><span style="font-family:Times New Roman">Redis</span><span style="font-family:宋体">来</span><span style="font-family:Times New Roman">Cache</span><span style="font-family:宋体">。</span></p>


<p>2010<span style="font-family:宋体">年，</span><span style="font-family:Times New Roman">Twitter</span><span style="font-family:宋体">在盐湖城拥有了第一个自建的</span><span style="font-family:Times New Roman">DataCenter</span><span style="font-family:宋体">，主要是为了增加可控性。</span>从<span style="font-family:Times New Roman">Twitter</span><span style="font-family:宋体">的发展过程看，</span><span style="font-family:Times New Roman">6</span><span style="font-family:宋体">年来它的技术改造主要围绕可伸缩以及可用性。</span></p>


<p style="text-align:center"><span style="color:#888888"><strong><img title="ebay" src="http://www.programmer.com.cn/wp-content/uploads/2012/05/ebay1.jpg" alt="" width="140" height="64"></strong></span></p>


<p>作为一家电子商务网站的员工，请允许我在此介绍这个<span style="font-family:Times New Roman">Alexa</span><span style="font-family:宋体">排名</span><span style="font-family:Times New Roman">21</span><span style="font-family:宋体">的著名电子商务网站的技术演变。</span></p>


<p>1995<span style="font-family:宋体">年，</span><span style="font-family:Times New Roman">eBay</span><span style="font-family:宋体">诞生，当时采用</span><span style="font-family:Times New Roman">CGI</span><span style="font-family:宋体">编写，数据库采用的是</span><span style="font-family:Times New Roman">GDBM</span><span style="font-family:宋体">，最多只能支撑</span><span style="font-family:Times New Roman">5</span><span style="font-family:宋体">万件在线商品。</span>1997<span style="font-family:宋体">年，</span><span style="font-family:Times New Roman">eBay</span><span style="font-family:宋体">将操作系统从</span><span style="font-family:Times New Roman">FreeBSD</span><span style="font-family:宋体">迁移到</span><span style="font-family:Times New Roman">Windows NT</span><span style="font-family:宋体">，另外将数据库从</span><span style="font-family:Times New Roman">GDBM</span><span style="font-family:宋体">迁移为</span><span style="font-family:Times New Roman">Oracle</span><span style="font-family:宋体">。</span>1999<span style="font-family:宋体">年，</span><span style="font-family:Times New Roman">eBay</span><span style="font-family:宋体">将前端系统改造为</span><span style="font-family:Times New Roman">Cluster</span><span style="font-family:宋体">（之前只有一台主机），采用</span><span style="font-family:Times New Roman">Resonate</span><span style="font-family:宋体">作为负载均衡，后端的</span><span style="font-family:Times New Roman">Oracle</span><span style="font-family:宋体">机器升级为</span><span style="font-family:Times New Roman">Sun E1000</span><span style="font-family:宋体">小型机，同年给数据库增加了一台机器作为备库，提升可用性。前端机器随着访问量不断增加还可以应付，但数据库机器在</span><span style="font-family:Times New Roman">1999</span><span style="font-family:宋体">年</span><span style="font-family:Times New Roman">11</span><span style="font-family:宋体">月时已经达到了瓶颈（已经不能再加</span><span style="font-family:Times New Roman">CPU</span><span style="font-family:宋体">和内存了），于是在</span><span style="font-family:Times New Roman">11</span><span style="font-family:宋体">月开始将数据库按业务拆分为多个库。</span>2001-2002<span style="font-family:宋体">年，</span><span style="font-family:Times New Roman">eBay</span><span style="font-family:宋体">将数据表进行了水平拆分，例如按类目存储商品，同时部署</span><span style="font-family:Times New Roman">Oracle</span><span style="font-family:宋体">的小型机换为</span><span style="font-family:Times New Roman">Sun A3500</span><span style="font-family:宋体">。</span>2002<span style="font-family:宋体">年，将整个网站迁移为用</span><span style="font-family:Times New Roman">Java</span><span style="font-family:宋体">构建，在这个阶段，做了</span><span style="font-family:Times New Roman">DAL</span><span style="font-family:宋体">框架来屏蔽数据库分库分表带来的影响，同时还设计了一个开发框架以供开发人员更好地上手进行功能开发。</span>从<span style="font-family:Times New Roman">eBay</span><span style="font-family:宋体">的整个发展过程来看，技术改造主要围绕在可伸缩性和可用性两点。</span></p>


<p style="text-align:center"><img title="腾讯" src="http://www.programmer.com.cn/wp-content/uploads/2012/05/%E8%85%BE%E8%AE%AF.jpg" alt="" width="179" height="37"></p>


<p>腾讯目前Alexa<span style="font-family:宋体">排名第</span><span style="font-family:Times New Roman">9</span><span style="font-family:宋体">。</span>最初<span style="font-family:Times New Roman">QQ IM</span><span style="font-family:宋体">采用的是单台接入服务器来处理用户的登录和状态保持，但在发展到一百万用户同时在线时，这台服务器已经无法支撑。</span>于是<span style="font-family:Times New Roman">QQ IM</span><span style="font-family:宋体">将所有单台服务器改造为了集群，并增加了状态同步服务器，由其完成集群内状态的同步，用户的信息存储在</span><span style="font-family:Times New Roman">MySQL</span><span style="font-family:宋体">中，做了分库分表，好友关系存储在自行实现的文件存储中。</span>为了提升进程间通信的效率，腾讯自行实现了用户态<span style="font-family:Times New Roman">IPC</span><span style="font-family:宋体">。之后腾讯将状态同步服务器也改造为同步集群，以支撑越来越多的在线用户。</span>在经历了前面几次改造后，已基本能支撑千万级别的用户同时在线，但可用性比较差，于是腾讯对<span style="font-family:Times New Roman">QQ IM</span><span style="font-family:宋体">再次进行改造，实现了同城跨</span><span style="font-family:Times New Roman">IDC</span><span style="font-family:宋体">的容灾，加强了监控和运维系统的建设。</span>此后腾讯决定对<span style="font-family:Times New Roman">QQ IM</span><span style="font-family:宋体">架构完全重写（大概是</span><span style="font-family:Times New Roman">2009</span><span style="font-family:宋体">年持续到现在），主要是为了增强灵活性、支持跨城市的</span><span style="font-family:Times New Roman">IDC</span><span style="font-family:宋体">、支撑千万级的好友。在这次大的技术改造过程中，腾讯的数据都不再存储于</span><span style="font-family:Times New Roman">MySQL</span><span style="font-family:宋体">中，而是全部存储在了自己设计的系统里。</span></p>


<p>从<span style="font-family:Times New Roman">QQ  IM</span><span style="font-family:宋体">的技术演变来看，其技术改造主要是围绕在可伸缩性和可用性上。</span></p>


<p style="text-align:center"><span style="color:#888888"><strong><img title="淘宝" src="http://www.programmer.com.cn/wp-content/uploads/2012/05/%E6%B7%98%E5%AE%9D1.jpg" alt="" width="153" height="50"></strong></span></p>


<p>2003<span style="font-family:宋体">年，淘宝诞生，直接购买了一个商业的</span><span style="font-family:Times New Roman">phpAuction</span><span style="font-family:宋体">的软件，在此基础上改造产生了淘宝。</span>2004<span style="font-family:宋体">年，将系统由</span><span style="font-family:Times New Roman">PHP</span><span style="font-family:宋体">迁移到</span><span style="font-family:Times New Roman">Java</span><span style="font-family:宋体">，</span><span style="font-family:Times New Roman">MySQL</span><span style="font-family:宋体">迁移为</span><span style="font-family:Times New Roman">Oracle</span><span style="font-family:宋体">（小型机、高端存储设备），应用服务器采用了</span><span style="font-family:Times New Roman">WebLogic</span><span style="font-family:宋体">。</span>2005-2007<span style="font-family:宋体">年的发展过程中，用</span><span style="font-family:Times New Roman">JBoss</span><span style="font-family:宋体">替代了</span><span style="font-family:Times New Roman">WebLogic</span><span style="font-family:宋体">，对数据库进行了分库，基于</span><span style="font-family:Times New Roman">BDB</span><span style="font-family:宋体">做了分布式缓存，自行开发了分布式文件系统</span><span style="font-family:Times New Roman">TFS</span><span style="font-family:宋体">以支持小文件的存储，并建设了自己的</span><span style="font-family:Times New Roman">CDN</span><span style="font-family:宋体">。</span>2007-2009<span style="font-family:宋体">年对应用系统进行垂直拆分，拆分后的系统都以</span><span style="font-family:Times New Roman">Service</span><span style="font-family:宋体">的方式对外提供功能，对数据采用了垂直和水平拆分。</span></p>


<p>在进行了数据的垂直和水平拆分后，<span style="font-family:Times New Roman">Oracle</span><span style="font-family:宋体">产生的成本越来越高，于是在之后的几年，淘宝又开始将数据逐渐从</span><span style="font-family:Times New Roman">Oracle</span><span style="font-family:宋体">迁移到</span><span style="font-family:Times New Roman">MySQL</span><span style="font-family:宋体">，同时开始尝试新型的数据存储方案，例如采用</span><span style="font-family:Times New Roman">HBase</span><span style="font-family:宋体">来支撑历史交易订单的存储和检索等。</span>近几年淘宝开始进行<span style="font-family:Times New Roman">Linux</span><span style="font-family:宋体">内核、</span><span style="font-family:Times New Roman">JVM</span><span style="font-family:宋体">、</span><span style="font-family:Times New Roman">Nginx</span><span style="font-family:宋体">等软件的修改定制工作，同时也自行设计了低能耗服务器，同时在软硬件上进行优化，以更好地降低成本。</span></p>


<p>从淘宝的整个发展过程来看，技术改造主要围绕在可伸缩性和可用性两点，现在也开始逐渐将精力投入在了性能和成本上。目前淘宝的<span style="font-family:Times New Roman">Alexa</span><span style="font-family:宋体">排名为第</span><span style="font-family:Times New Roman">14</span><span style="font-family:宋体">。</span></p>


<p><span style="color:#888888"><strong>总结</strong></span></p>


<p>从上面这些<span style="font-family:Times New Roman">Alexa</span><span style="font-family:宋体">排名靠前网站的技术发展过程来看，每家网站由于其所承担的业务不同、团队人员组成不同、做事风格相异，在技术的不同发展阶段中会采用不同的方法来支撑业务的发展，但基本都会围绕在可伸缩性、可用性、性能以及成本这</span><span style="font-family:Times New Roman">4</span><span style="font-family:宋体">点上，在发展到比较大规模后，各网站在技术结构上有了很多的相似点，并且这些结构还将继续进行演变。</span></p>


<p><span style="color:#888888"><strong>作者林昊，目前就职于淘宝，2007-2010年负责设计和实现淘宝的服务框架，此服务框架在淘宝大面积使用，每天承担了150亿+的请求；2011年开始负责HBase在淘宝的落地，目前淘宝已有20个以上的在线项目在使用HBase。</strong></span></p>


<p> </p>


<p><a href="http://www.programmer.com.cn/11512/"><strong>本文选自《程序员》杂志2012年05期，未经允许不得转载。如需转载请联系 market@csdn.net</strong></a></p>


<p><strong><a href="http://dingyue.programmer.com.cn/">《程序员》2012年杂志订阅送好礼活动火热进行中</a></strong></p>


<p> </p>


</div>


            <div class="footer">
              <div class="contact">
                <p>
                  Your Name<br />
                  What You Are<br />
                  your@email.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/yourusername/">github.com/yourusername</a><br />
                  <a href="http://twitter.com/yourusername/">twitter.com/yourusername</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

    </body>
</html>
