<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>[译]Javascript:自托管的Parallel JS</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/">Your New Jekyll Site</a></h1>
              <a class="extra" href="/">home</a>
            </div>

                <h2>[译]Javascript:自托管的Parallel JS</h2>
<p class="meta">06 Dec 2012</p>

<div class="post">
<h2>[译]Javascript:自托管的Parallel JS</h2>

<h3>by 紫云飞</h3>

<h3>at 2012-12-06 15:14:00</h3>

<h3>original <a href="http://www.cnblogs.com/ziyunfei/archive/2012/12/06/2804435.html">http://www.cnblogs.com/ziyunfei/archive/2012/12/06/2804435.html</a></h3>

<div><p>原文:<a href="http://smallcultfollowing.com/babysteps/blog/2012/12/05/self-hosted-parallel-js/">http://smallcultfollowing.com/babysteps/blog/2012/12/05/self-hosted-parallel-js/</a></p><hr><blockquote><p>译者注:此文翻译不通顺,你只需要读懂大概.</p></blockquote><p>我已经有段时间没写博客了,原因是我最近正忙着搞<a href="http://smallcultfollowing.com/babysteps/blog/categories/pjs">Parallel JS</a>,已经花了不少时间了.不过,我们的目标是:在接下来的几周内发布一个最初版本!</p><p>一个令人兴奋的消息是我们已经开始了自托管(self-hosting)的实现.自托管是一个非常酷的,由<a href="http://www.tillschneidereit.de/">Till Schneidereit</a>发起的,SpiderMonkey引擎新的发展方向.其核心思想就是"使用JavaScript来实现Javascript引擎自身的大部分功能",类似于<a href="http://www.squeak.org/">Squeak</a>, <a href="http://www.research.ibm.com/jalapeno/publication.html">Jikes RVM</a>, <a href="http://labs.oracle.com/projects/maxine/">Maxine</a>, <a href="http://pypy.org/">PyPy</a>以及许多其他的项目.举个例子,想一下标准的Javascript函数<code>Array.map</code>.在SpiderMonkey中,该函数使用了大概<a href="https://github.com/mozilla/mozilla-central/blob/7ca138ebf9ab8f0f1e981af486b9af6206fd0d15/js/src/jsarray.cpp#L2943">80行C++代码</a>.这些代码必须要处理各种烦人的条件验证,比如要<a href="https://github.com/mozilla/mozilla-central/blob/7ca138ebf9ab8f0f1e981af486b9af6206fd0d15/js/src/jsarray.cpp#L2948">确保所要处理的对象是已<span>根化的(</span>rooted)</a>,<a href="https://github.com/mozilla/mozilla-central/blob/7ca138ebf9ab8f0f1e981af486b9af6206fd0d15/js/src/jsarray.cpp#L2986">检查中断(interrupts)</a>等,还要使用一个<a href="https://github.com/mozilla/mozilla-central/blob/7ca138ebf9ab8f0f1e981af486b9af6206fd0d15/js/src/jsarray.cpp#L2983">优化过的调用序列(call sequence)来让JavaScript代码运行的更快</a>.如果这个函数是使用Javascript写的,那么所有的这些问题都会自动转交给Javascript引擎来处理,就像处理其他非原生函数一样.</p><p>除了复杂度,使用C++实现的<code>Array.map</code>的另外一个缺点是:慢.你也许会大吃一惊:难道C++不比JavaScript快吗?答案是"是的,是快",C++写的程序可以比JavaScript快,不过必须是在操作C++中的数据结构的前提下.等价的数据结构在JavaScript中会表现的完全不一样.比如,一个C++中的数组仅仅是一个存储器单元(memory locations)的连续序列(continuous series),所以一个数组存储操作比如<code>a[i] = v</code>会被编译成极少量<span lang="zh-CN"><span>的</span><span>汇编指令(</span></span>assembly instructions).而在Javascript中,数组灵活了许多:它们可以是稀疏的(sparse),可以动态的增长和缩减(grown and shrunk).所有这些都意味着,一个相同的数组,在JavaScript中会比在C++中有更多更复杂的操作.目前,SpiderMonkey中的实现是<a href="https://github.com/mozilla/mozilla-central/blob/7ca138ebf9ab8f0f1e981af486b9af6206fd0d15/js/src/jsarray.cpp#L3006">调用了JavaScript VM函数<code>SetArrayElement()</code></a>,该函数非常通用,可以处理所有可能遇到的情况.</p><p>使用一个辅助函数是不幸的.因为,在通常情况下,一个JavaScript数组在引擎内部就是使用一个简单的C++数组来表示的,这就意味着,存储操作<code>a[i] = v</code>可以被编译成为C++中等同的操作.实际上,对于一个写在JavaScript中的循环,JIT引擎也会用类似的方法把循环编译到C++中,在执行中,如果有必要的话,会调用一个类似<code>SetArrayElement()</code>通用操作.</p><p>还有一些其他原因让C++代码比JavaScript代码慢.比如GC接口就比较尴尬,由于编译器不能生成一个堆栈地图来告诉我们指针在哪里,C++和JavaScript代码之间的转换就需要一些适应,因为IonMonkey编译器专门针对JavaScript的需求使用了一个调用惯例.等等.</p><p><strong>内部函数</strong></p><p>当然,用Javascript来替换C++并不是一帆风顺的,同样会伴随一些负面的影响.比如,C++代码可以做一些普通Javascript代码不能做的事情(比如访问本地文件).还有在自托管的实现中,JavaScript函数必须处理一些平时不需要关心的内部细节.为了解决这些问题,自托管引入了内部函数(intrinsic function)的概念.一个内部函数就是一个特殊的JavaScript函数,用C++实现,而且仅允许自托管代码调用.内部函数的作用就是暴露额外的功能(进行一些引擎内部的操作)给自托管代码,其它的非自托管代码不能调用这些内部函数.</p><p>为了和普通函数区分开来,目前Parallel JS中的内部函数以<code>%</code>符号开头(比如, <code>%Foo()</code>),不过未来的计划是使用普通的Javascript标识符来替换这些名字.</p><p>在Parallel JS中,我们使用内部函数暴露了一些底层的并行操作,这些操作可以用来实现其他更高级的并行操作(<code>map()</code>, <code>filter()</code>, <code>reduce()</code>, <code>scan()</code>, <code>scatter()</code>).和高级操作不同的是,内部的并行操作并不安全,它可能造成数据争用(data races)的情况.还有,如果调用这个内部操作的高级函数出于某种原因不能被编译成并行操作的话,这个内部操作也会失败.</p></div>


<p><img src="http://www.cnblogs.com/ziyunfei/aggbug/2804435.html?type=1" width="1" height="1" alt=""><p><a href="http://www.cnblogs.com/ziyunfei/archive/2012/12/06/2804435.html">本文链接</a></p></p>

</div>


            <div class="footer">
              <div class="contact">
                <p>
                  Your Name<br />
                  What You Are<br />
                  your@email.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/yourusername/">github.com/yourusername</a><br />
                  <a href="http://twitter.com/yourusername/">twitter.com/yourusername</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

    </body>
</html>
