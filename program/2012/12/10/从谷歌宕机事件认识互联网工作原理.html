<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>从谷歌宕机事件认识互联网工作原理</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/google_reader/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/google_reader/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/google_reader/">Google Reader</a></h1>
              <a class="extra" href="/google_reader/">home</a>
            </div>

                <h2>从谷歌宕机事件认识互联网工作原理</h2>
<p class="meta">2012-12-10 00:14</p>

<div class="post">
<h2>从谷歌宕机事件认识互联网工作原理</h2>

<h3>by</h3>

<h3>at 2012-12-09 16:14:35</h3>

<h3>original <a href="http://kb.cnblogs.com/page/166210/">http://kb.cnblogs.com/page/166210/</a></h3>

<p>　　英文原文：<a href="http://blog.cloudflare.com/why-google-went-offline-today-and-a-bit-about">Why Google Went Offline Today and a Bit about How the Internet Works</a></p>


<p>　　译者注：本文中提到 CloudFlare 是一家总部位于美国旧金山的内容分发网络(CDN)服务公司，由 Project Honey Pot 项目的三位前开发人员成立于 2009 年。2011 年 10 月被华尔街日报评为最具创新精神的网络科技公司。</p>


<p>　　今天，谷歌的服务经历了短暂的宕机事件，持续大概 27 分钟，对部分地区的互联网用户造成了影响。此次事件的原因深究起来需要进入互联网络那深邃的、黑暗的角落。我是 CloudFlare 公司的一名网络工程师，在帮助谷歌从此次宕机中恢复回来提供了一臂之力。下面就是事情发生的过程。</p>


<p>　　大约在太平洋标准时间 2012 年 11 月 5 号下午 6:24 分/时间标准时间 2012 年 11 月 6 号凌晨 2:24 分，CloudFlare 的员工发现谷歌的服务中断了。我们使用谷歌的电子邮件等服务，所以，当它的服务不正常时，办公室的人会很快发现。我在网络技术小组工作，因此我立刻接上网络查看是什么情况——是局部区域问题还是全球问题。</p>


<p>　　<strong>问题排查</strong></p>


<p>　　我很快就意识到，所有谷歌的服务我们都不能连接上——甚至包括连接 8.8.8.8，谷歌的公共 DNS 服务器——于是，我从追查 DNS 开始。</p>


<blockquote>$ dig +trace google.com</blockquote>


<p>　　下面是我在探测 Google.com 的域名服务器时得到的回复：</p>


<blockquote><p>　　google.com. 172800 IN NS ns2.google.com.</p><p>　　google.com. 172800 IN NS ns1.google.com.</p><p>　　google.com. 172800 IN NS ns3.google.com.</p><p>　　google.com. 172800 IN NS ns4.google.com.</p><p>　　;; Received 164 bytes from 192.12.94.30#53(e.gtld-servers.net) in 152 ms</p><p>　　;; connection timed out; no servers could be reached</p></blockquote>


<p>　　无法探测到任何服务器的结果证明确实有什么地方出了问题。尤其是，这意味着从我们的办公室将连接不到任何的谷歌 DNS 服务器。</p>


<p>　　我开始网络层查找问题，看看是否是在这个通信层出了问题。</p>


<blockquote><p>　　PING 216.239.32.10 (216.239.32.10): 56 data bytes</p><p>　　Request timeout for icmp_seq 0</p><p>　　92 bytes from 1-1-15.edge2-eqx-sin.moratelindo.co.id (202.43.176.217)</p></blockquote>


<p>　　这里出现了奇怪的信息。通常，我们不应该在谷歌的路由信息中看到一个印度尼西亚的网络服务提供商(Moratel)的名字。我立即进入一个 CloudFlare 的路由器中查看发生了什么事。与此同时，Twitter 上世界其它地方的报告显示了我们并不是唯一遇到问题的地方。</p>


<p>　　<strong>互联网路由</strong></p>


<p>　　为了理解是出了什么问题，你需要知道一些互联网是如何工作的基础知识。整个互联网是由很多的网络组成，这些网络被称为是“自治系统(AS)”。每个网络都有一个唯一的数字来标志自己，被称为 AS 号。CloudFlare 的 AS 号是 13335，谷歌的 AS 号是 15169。各个网络通过一种叫做边缘网关协议(BGP)的技术互相连接。边缘网关协议被称为是互联网的粘合剂——由它来声明哪个 IP 地址属于哪个网络，由它来建立从某个自治网络到另外一个自治网络的路由。一个互联网“路由”跟这个词的表意完全一样：由一个自治网络里的 IP 地址到另外一个自治网络里的另一个 IP 地址的路径。</p>


<p>　　边缘网关协议是基于一个相互信任的体制。各个网络基于信任的原则告诉其它网络哪个 IP 地址属于哪个网络。当你发送一个数据包，或发送一个穿越网络的请求，你的网络服务提供商会联系它的上游提供商或对等提供商，询问它们从你的网络服务提供商到网络目的地，哪条路线最近。</p>


<p>　　不幸的是，如果当一个网络发出声明说某个 IP 地址或某个网络在它的内部，而事实不是这样，如果它的上游网络或对等网络信任了它，那么，这个数据包最终将会迷路丢失。这里发生的就是这个问题。</p>


<p>　　我查看了边缘网关协议传递的谷歌 IP 的路由地址，路由指向了 Moratel (23947)，一个印度尼西亚的网络服务提供商。我们的办公室在加利福尼亚，离谷歌的数据中心并不远，数据包绝不应该经过印度尼西亚。很有可能是，Moratel 声明了一个错误的网络路由。</p>


<p>　　当时我看到的边缘网关协议发来的路由是：</p>


<blockquote><p>　　tom@edge01.sfo01&gt; show route 216.239.34.10</p><p>　　inet.0: 422168 destinations, 422168 routes (422154 active, 0 holddown, 14 hidden)</p><p>　　+ = Active Route, - = Last Active, * = Both</p><p>　　216. 239.34.0/24 *[BGP/170] 00:15:47, MED 18, localpref 100</p><p>     AS path: 4436 3491 23947 15169 I</p><p>     &gt; to 69.22.153.1 via ge-1/0/9.0</p></blockquote>


<p>　　我查看了其它路由，比如谷歌的公共 DNS，它同样被劫持到了相同的(不正确的)路径：</p>


<blockquote><p>　　tom@edge01.sfo01&gt; show route 8.8.8.8</p><p>　　inet.0: 422196 destinations, 422196 routes (422182 active, 0 holddown, 14 hidden)</p><p>　　+ = Active Route, - = Last Active, * = Both</p><p>　　8. 8.8.0/24 *[BGP/170] 00:27:02, MED 18, localpref 100</p><p>    AS path: 4436 3491 23947 15169 I</p><p>    &gt; to 69.22.153.1 via ge-1/0/9.0</p></blockquote>


<p>　　<strong>路由泄漏</strong></p>


<p>　　像这样的问题在行业内被认为是起源于“路由泄漏”，不是正常的。这种事情并不是没有先例。谷歌之前曾遭受过<a href="http://www.renesys.com/blog/2008/02/pakistan-hijacks-youtube-1.shtml">类似的宕机事件</a>，当时推测是巴基斯坦为了禁止 YouTube 上的一个视频，巴基斯坦国家 ISP 删除了 YouTube 网站的路由信息。不幸的是，他们的这种做法被传递到了外部，巴基斯坦电信公司的上游提供商——电讯盈科(PCCW)信任了巴基斯坦电信公司的做法，把这种路由方式传递到了整个互联网。这个事件导致了 YouTube 网站大约 2 个小时不能访问。</p>


<p style="text-align:center"><a><img title="胖手指辛普森" src="http://pic004.cnblogs.com/news/201211/20121127_090529_1.jpg" alt="胖手指辛普森" width="500" height="375"></a></p>


<p>　　今天发生的事情属于类似情况。在 Moratel 公司的某个人很可能是“胖手指”，输错了互联网路由。而电讯盈科，Moratel 公司的上游提供商，信任了 Moratel 公司传递给他们的路由。很快，这错误的路由就传到了整个互联网。在边缘网关协议这种信任模式中，与其说这是恶意的行为，不如说这是误操作或失误。</p>


<p>　　<strong>修复</strong></p>


<p>　　解决方案就是让 Moratel 公司停止声明错误的路由。作为一个网络工程师，尤其是像 CloudFlare 这样的大网络公司里工作的工程师，很大一部分工作就是和其它世界各地的网络工程师保持联络。当探明问题后，我联系到了 Moratel 公司的一位同事，告诉他发生了什么事。他大概在太平洋标准时间下午 6:50 分/世界标准时间凌晨 2:50 分修复了这个问题。3 分钟后，路由恢复了正常，谷歌的服务重新可以工作了。</p>


<p>　　从网络传输图上观察，我估计全球整个互联网用户的 3-5% 受到了此次宕机事故的影响。重灾区是香港，因为那是电讯盈科的总部。如果你所处的地区在当时无法访问谷歌的服务，你现在应该知道是什么原因了。</p>


<p>　　<strong>构建更好的互联网</strong></p>


<p>　　我说这些就是想让大家知道我们的互联网上如何在一个相互信任的机制下建立起来的。今天的事故说明，即使你是一个像谷歌这样的大公司，外部你无法掌控的因素也会影响到你的用户，让他们无法访问你。所以，一个网络技术小组是非常必要的，由他们来监控路由，管理你与世界的联系。CloudFlare 公司每天的工作就是确保客户得到最佳的路由。我们照看互联网上的所有网站，确保他们的以最快传输速度提供服务。今天的事情只是我们工作内容的一个小片段。</p>


</div>


            <div class="footer">
              <div class="contact">
                <p>
                  Your Name<br />
                  What You Are<br />
                  your@email.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/lyuehh/">github.com/lyuehh</a><br />
                  <a href="http://twitter.com/lyuehh/">twitter.com/lyuehh</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

    </body>
</html>
