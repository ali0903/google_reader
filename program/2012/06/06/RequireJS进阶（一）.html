<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>RequireJS进阶（一）</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/">Your New Jekyll Site</a></h1>
              <a class="extra" href="/">home</a>
            </div>

                <h2>RequireJS进阶（一）</h2>
<p class="meta">06 Jun 2012</p>

<div class="post">
<h2>RequireJS进阶（一）</h2>

<h3>by snandy</h3>

<h3>at 2012-06-06 08:15:00</h3>

<h3>original <a href="http://www.cnblogs.com/snandy/archive/2012/06/06/2536969.html">http://www.cnblogs.com/snandy/archive/2012/06/06/2536969.html</a></h3>

<p>为了应对日益复杂，大规模的JavaScript开发。我们化整为零，化繁为简。将复杂的逻辑划分一个个小单元，各个击破。这时一个项目可能会有几十个甚至上百个JS文件，每个文件为一个模块单元。如果上线时都是这些小文件，那将对性能造成一定影响。</p>


<p> </p>


<p>RequireJS提供了一个打包压缩工具<a href="http://requirejs.org/docs/download.html#rjs">r.js</a>来对模块进行合并压缩。r.js非常强大，不但可以压缩js，css，甚至可以对整个项目进行打包。</p>


<p>r.js的压缩工具使用<a href="https://github.com/mishoo/UglifyJS">UglifyJS</a>或<a href="http://code.google.com/closure/compiler/">Closure Compiler</a>。默认使用UglifyJS（jQuery也是使用它压缩）。此外r.js需要node.js环境，当然它也可以运行在Java环境中如Rhino。</p>


<p> </p>


<p>这篇以一个简单的示例来感受下r.js，创建的目录如下</p>


<p><img src="http://pic002.cnblogs.com/images/2012/114013/2012060516595973.png" alt=""></p>


<p>和<a href="http://www.cnblogs.com/snandy/archive/2012/05/24/2514700.html">入门之三</a>目录结构一样，写了三个模块cache，event，selector。这三个模块的代码就不在贴了。main.js也未做修改，实现的功能仍然是为页面上的所有段落P元素添加个点击事件，点击后弹出P的innerHTML。唯一的区别是目录中<strong>多了个r.js</strong>。</p>


<p> </p>


<p>index.html做了修改，如下</p>


<div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px">&lt;!doctype html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>&lt;title&gt;requirejs进阶（一）&lt;/title&gt;<br>&lt;meta charset=&quot;utf-8&quot;/&gt;<br>&lt;style type=&quot;text/css&quot;&gt;<br>p {<br>background: #999;<br>width: 200px;<br>}<br>&lt;/style&gt;<br> &lt;/head&gt;<br> &lt;body&gt;<br>&lt;p&gt;p1&lt;/p&gt;&lt;p&gt;p2&lt;/p&gt;&lt;p&gt;p3&lt;/p&gt;&lt;p&gt;p4&lt;/p&gt;&lt;p&gt;p5&lt;/p&gt;<br>&lt;script data-main=&quot;built&quot; src=&quot;require.js&quot;&gt;&lt;/script&gt;<br> &lt;/body&gt;<br>&lt;/html&gt;<br></div>


<p>注意，<strong>data-main改为了“built”</strong>，上一篇的是“main”。我们将使用r.js把js目录下的cache.js，event.js，selector.js，main.js合并压缩后写到r4目录中。</p>


<p> </p>


<p>好，让我们开始合并压缩吧。</p>


<p>1，打开windows命令窗口，cd到r4目录中</p>


<p><img src="http://pic002.cnblogs.com/images/2012/114013/2012060517022295.png" alt=""></p>


<p> </p>


<p>2，输入命令</p>


<p><span style="background-color:#000000;color:#ffffff">node r.js -o baseUrl=js name=main out=built.js</span></p>


<p><img src="http://pic002.cnblogs.com/images/2012/114013/2012060517024471.png" alt=""></p>


<p> </p>


<p>命令行信息可以看到已经将各个js文件合并成功了。这时回到r4目录会发现多了一个built.js文件。</p>


<p><img src="http://pic002.cnblogs.com/images/2012/114013/2012060517031239.png" alt=""></p>


<p>好了，合并压缩过程完成了。</p>


<p> </p>


<p>把目录r4放到apache或其它web服务器上，访问index.html。网络请求如下</p>


<p><img src="http://pic002.cnblogs.com/images/2012/114013/2012060517033881.png" alt="" width="600"></p>


<p> </p>


<p>可以看到除了require.js，就只有built.js了。大大减少了JS文件的http请求。这时点击页面上各个P元素，会弹出对应的innerHTML</p>


<p><img src="http://pic002.cnblogs.com/images/2012/114013/2012060517051770.png" alt="" width="600"></p>


<p>这说明功能完损无缺。</p>


<p> </p>


<p>下面对命令行做个简单解释。<br><span style="background-color:#000000;color:#ffffff">node r.js -o baseUrl=js name=main out=built.js</span></p>


<p>-o         表示优化，该参数是固定的，必选。<br>baseUrl  指存放模块的根目录，这里是r4/js，因为cd到r4中了，只需设置为js。可选，如果没有设置将从r4中查找main.js。<br>name     模块的入口文件，这里设置成“main”，那么r.js会从baseUrl+main去查找。这里实际是r4/js/main.js。r.js会分析main.js，找出其所依赖的所有其它模块，然后合并压缩。<br>out        指合并压缩后输出的文件路径，这里直接是built.js，那么将输出到根目录r4下。</p>


<p> </p>


<p>好了，再介绍两个参数</p>


<p>1，excludeShallow 合并时将排除该文件</p>


<p><span style="color:#ffffff;background-color:#000000">node r.js -o baseUrl=js name=main out=built.js excludeShallow=selector</span></p>


<p><img src="http://pic002.cnblogs.com/images/2012/114013/2012060517082743.png" alt="" width="600"></p>


<p> </p>


<p>可以看到输出信息中不再包括selector.js。这时运行index.html页面，会发现selector.js被单独请求下来了。</p>


<p><img src="http://pic002.cnblogs.com/images/2012/114013/2012060517085966.png" alt="" width="600"></p>


<p> </p>


<p>2，optimize (none/uglify/closure)  指定是否压缩，默认为uglify<br>不传该参数时r.js默认以UglifyJS压缩。设置为none则不会压缩，仅合并，这在开发阶段是很用用的。<br><span style="background-color:#000000;color:#ffffff">node r.js -o baseUrl=js name=main out=built.js optimize=none</span></p>


<p><img src="http://pic002.cnblogs.com/images/2012/114013/2012060517453370.png" alt=""></p>


<p>这时生成的built.js是没有压缩的。</p>


<p> </p>


<p>总结：<br>这篇演示了采用模块开发后上线前的一个小示例：把所有模块文件合并为一个文件。</p>


<p>先下载r.js放到开发目录中，然后使用命令行来合并压缩。其中演示了命令行参数-o、baseUrl、name、out及excludeShallow、optimize的使用。-o、name、out是必选的，其它为可选。</p>


<p> </p>


<p><a href="http://files.cnblogs.com/snandy/r4.zip">r4.zip</a></p>


<p><img src="http://www.cnblogs.com/snandy/aggbug/2536969.html?type=1" width="1" height="1" alt=""><p><a href="http://www.cnblogs.com/snandy/archive/2012/06/06/2536969.html">本文链接</a></p></p>

</div>


            <div class="footer">
              <div class="contact">
                <p>
                  Your Name<br />
                  What You Are<br />
                  your@email.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/yourusername/">github.com/yourusername</a><br />
                  <a href="http://twitter.com/yourusername/">twitter.com/yourusername</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

    </body>
</html>
