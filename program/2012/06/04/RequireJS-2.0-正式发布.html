<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>RequireJS 2.0 正式发布</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/google_reader/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/google_reader/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/google_reader/">Google Reader</a></h1>
              <a class="extra" href="/google_reader/">home</a>
            </div>

                <h2>RequireJS 2.0 正式发布</h2>
<p class="meta">2012-06-04 15:58</p>

<div class="post">
<h2>RequireJS 2.0 正式发布</h2>

<h3>by snandy</h3>

<h3>at 2012-06-04 07:58:00</h3>

<h3>original <a href="http://www.cnblogs.com/snandy/archive/2012/06/04/2532997.html">http://www.cnblogs.com/snandy/archive/2012/06/04/2532997.html</a></h3>

<p>就在前天晚上RequireJS发布了一个大版本，直接从version<a href="http://requirejs.org/docs/1.0/">1.0.8</a>升级到了<a href="http://requirejs.org/docs/api.html">2.0</a>。随后的几小时James Burke又迅速的将版本调整为2.0.1，当然其配套的打包压缩工具<a href="https://github.com/jrburke/r.js">r.js</a>也同时升级到了2.0.1。此次变化较大，代码也进行了重构，层次更清晰可读。功能上主要变化如下：</p>


<p> </p>


<p><strong>1，延迟模块的执行。</strong></p>


<p>这是一个很大变化，以前模块加载后factory立马执行。性能上肯定有一些损耗。2.0修改实现，再没人诟病<a href="http://www.cnblogs.com/snandy/archive/2012/03/12/2390782.html">AMD</a>的模块是立即执行的。现在也可以等到require的时候才执行。</p>


<p> </p>


<p><strong>2，config增加了shim，map，module，enforceDefine。</strong></p>


<p><strong>shim</strong>参数解决了使用非AMD方式定义的模块（如jQuery插件）及其载入顺序。使用shim参数来取代1.0版本的<a href="http://requirejs.org/docs/api.html#order">order</a>插件。其实在1.0版本中就曾经有人开发过<a href="https://github.com/tbranyen/use.js/">use</a>和<a href="https://github.com/geddesign/wrapjs">wrap</a>插件来解决此类问题。考虑到很多开发者有此类需求（比如某些JS模块是较早时候其他人开发的，非AMD方式）此次2.0版本直接将其内置其中。</p>


<p>下面是一个使用jQuery插件形式配置的参数。我们知道jQuery插件本质上是将命名空间挂在全局的jQuery或jQuery.fn上而非使用define定义的模块。而jQuery插件都依赖于jQuery，即在require插件时得保证jQuery先下载下来。可以如下配置</p>


<div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px">require.config({<br>shim: {<br>'jquery-slide': ['jquery']<br>}<br>});<br>require(['jquery-slide']);<br></div>


<p>这时会保证先下载jquery.js，然后再下载jquery-slide.js。</p>


<p> </p>


<p><strong>map</strong>参数用来解决同一个模块的不同版本问题，这一灵感来自于Dojo的packageMap。有这样的场景：开发初期使用了的jquery-1.6.4，后期升级到了1.7.2。但担心有些依赖jquery-1.6.4的代码升级到1.7.2后有问题。因此保守的让这部分代码继续使用1.6.4版本。这时map参数将派上用场。</p>


<p>假如A，B模块中使用了jquery-1.6.4.js，C，D模块中使用了jquery-1.7.2.js。如下</p>


<div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px">requirejs.config({<br>    map: {<br>        'A': {<br>            'jquery': 'jquery-1.6.4'<br>        },<br>       'B': {<br>            'jquery': 'jquery-1.7.2'<br>        }<br>    }<br>});<br>require(['A']); // download jquery-1.6.4.js<br>require(['B']); // download jquery-1.7.2.js<br></div>


<p>这时require([&#39;A&#39;])将会下载jquery-1.6.4.js，require([&#39;B&#39;])会下载jquery-1.7.2.js。模块“A”如果写成“*”则表示除了B模块使用jquery-1.7.2之外其它模块都使用jquery-1.6.4。map参数解决了模块的各个版本问题，很好的向下兼容了老代码。</p>


<p> </p>


<p><strong>config</strong>参数用来给指定的模块传递一些有用的数据。如下</p>


<div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px">require.config({<br>    config: {<br>        'A': {<br>            info: {name: 'jack'}<br>        }<br>    }<br>});<br></div>


<p>使用A的模块中可以通过A.config().info获取到该数据信息。如</p>


<div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px">require(['A'], function(A) {<br>var info = a.config().info;<br>console.log(info);<br>});<br></div>


<p> </p>


<p><strong>enforceDefine</strong>用来强制模块使用define定义，默认为false。如underscore不再支持AMD后，其代码移除了define。此时如果仍然使用requirejs来载入它，它就是普通的js文件了。此时如果enforceDefine设为true，虽然underscore.js能下载但requirejs会报错。如</p>


<div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px">require.config({<br>enforceDefine: true<br>});<br>require(['underscore'], function(_){<br>console.log(_)<br>})<br></div>


<p> 错误信息</p>


<p><img src="http://pic002.cnblogs.com/images/2012/114013/2012060400041519.png" alt="" width="600"></p>


<p> </p>


<p><strong>4，require函数增加了第三个参数errbacks。</strong></p>


<p>很明显该函数指模块文件没有载入成功时的回调。这个也是应一些开发者得要求而增加，其中还包括另一个著名AMD的实现<a href="https://github.com/cujojs/curl">curl</a>的作者<a href="https://github.com/unscriptable">John Hann</a>。</p>


<div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px">require(['b'], function(){<br>console.log('success');<br>},function(err){<br>console.log(err)<br>}); <br></div>


<p> err会给出一些出错提示信息。</p>


<p> </p>


<p><strong>5，更强大的paths参数。</strong></p>


<p>requirejs 1.x版本中已经有paths参数，用来映射模块别名。requirejs2.0更加强大，可以配置为一个数组，顺序映射。当前面的路径没有成功载入时可接着使用后面的路径。如下</p>


<div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px">requirejs.config({<br>    enforceDefine: true,<br>    paths: {<br>        jquery: [<br>            'http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min',<br>            'lib/jquery'<br>        ]<br>    }<br>});<br><br>require(['jquery'], function ($) {<br>});<br></div>


<p>当google cdn上的jquery.min.js没有获取时（假如google宕机），可以使用本地的lib/jquery.js。</p>


<p> </p>


<p><strong>6，在模块载入失败回调中可以使用undef函数移除模块的注册。</strong></p>


<p>这个灵感来自<a href="http://livedocs.dojotoolkit.org/loader/amd">dojo AMD loader</a>，RequireJS取名undef。如下</p>


<div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px">require(['jquery'], function ($) {<br>    //Do something with $ here<br>}, function (err) {<br>    var failedId = err.requireModules &amp;&amp; err.requireModules[0];<br>    if (failedId === 'jquery') {<br>        requirejs.undef(failedId);<br>    } <br>});<br></div>


<p> </p>


<p><strong>7，删除了jQuery domready相关代码。</strong></p>


<p>这次没人再诟病RequireJS和jQuery耦合的太紧密。</p>


<p> </p>


<p><strong>8，删除了priority，packagePaths，catchError.define。</strong></p>


<p>这几个参数已经有相应的替代品。</p>


<p> </p>


<p>最后需要注意的是，虽然功能增加了不少。但代码量却减少了近60行。主要是去掉了jQuery ready相关代码。另外newContext函数依然有1000多行。</p>


<p> </p>


<p><img src="http://www.cnblogs.com/snandy/aggbug/2532997.html?type=1" width="1" height="1" alt=""><p><a href="http://www.cnblogs.com/snandy/archive/2012/06/04/2532997.html">本文链接</a></p></p>

</div>


            <div class="footer">
              <div class="contact">
                <p>
                  Your Name<br />
                  What You Are<br />
                  your@email.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/lyuehh/">github.com/lyuehh</a><br />
                  <a href="http://twitter.com/lyuehh/">twitter.com/lyuehh</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

    </body>
</html>
