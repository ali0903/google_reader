<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>关于C/C++内存管理一些乱讲</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/">Your New Jekyll Site</a></h1>
              <a class="extra" href="/">home</a>
            </div>

                <h2>关于C/C++内存管理一些乱讲</h2>
<p class="meta">03 Dec 2010</p>

<div class="post">
<h2>关于C/C++内存管理一些乱讲</h2>

<h3>by Lua</h3>

<h3>at 2010-12-03 15:33:00</h3>

<h3>original <a href="http://www.cnblogs.com/lua5/archive/2010/12/03/1895536.html">http://www.cnblogs.com/lua5/archive/2010/12/03/1895536.html</a></h3>

<p><div><p><a title="http://www.cnblogs.com/skynet/archive/2010/12/03/1895045.html" href="http://www.cnblogs.com/skynet/archive/2010/12/03/1895045.html">http://www.cnblogs.com/skynet/archive/2010/12/03/1895045.html</a>  这篇博客最后写了5个规则，虽然简单，但是还是有些问题，在这里稍作说明。</p> <blockquote><p><strong>【规则1</strong><strong>】</strong>用malloc或new申请内存之后，应该立即检查指针值是否为NULL。防止使 用指针值为NULL的内存。</p> </blockquote> <p>偶评：参考wiki百科针对malloc以及new的说明，对于C语言malloc方式，检查NULL是可以的，但是对于C++的new操作符 （operator），检查NULL基本是无用的，因为C++有异常机制，new不成功就会抛异常std::bad_alloc，如何处理可参考 <a title="http://msdn.microsoft.com/en-us/library/kftdy56f%28v=VS.71%29.aspx" href="http://msdn.microsoft.com/en-us/library/kftdy56f%28v=VS.71%29.aspx">http://msdn.microsoft.com/en-us/library/kftdy56f%28v=VS.71%29.aspx</a></p> <blockquote><p><strong>【规则2</strong><strong>】</strong>不要忘记为数组和动态内存赋初值。防止将未被初始化的内存作为右值使用。</p> </blockquote> <p>偶评：初值的赋值操作也是要花时间的，C语言初始化一块内存memset的时候要注意用buffersize *  sizeof(Object)，而C++就更复杂了，比如构造函数，new的重载之类，要小心。</p> <blockquote><p><strong>【规则3</strong><strong>】</strong>避免数组或指针的下标越界，特别要当心发生“多1”或者“少1”操作。</p> </blockquote> <p>偶评：一般来讲多一少一运行时不会一定出错，比如微软编译器申请内存一般会比你指定的大一些，比如你申请10bytes，如char* p=  malloc(10);，通常情况下操作p[10]，p[11]啥的是没有问题的，所以会发生一些奇怪的现象，就是某些bug有人机器会出，有人就无法重 现。</p> <blockquote><p><strong>【规则4</strong><strong>】</strong>动态内存的申请与释放必须配对，防止内存泄漏。</p> </blockquote> <p>偶评：要说明的是，new一定和delete配对，malloc一定和free配对，否则也会出错。另外new []，一定要delete  []，否则也会泄露。</p> <blockquote><p><strong>【规则5</strong><strong>】</strong>用free或delete释放了内存之后，立即将指针设置为NULL，防止产生 “野指针”。</p> </blockquote> <p>偶评：这种情况一般是代码中函数写的比较长，指针用了又用，或者指针是全局的情况。所以一般软件公司的编码规范都会硬性要求这样做，如果函数很短小 精悍，其实不会有这种担忧的。当然，偶也同意这样做有益无害。</p> <p>再加入一些额外的说明：</p> <p>对于指针类型的检查，不应该用assert，而是应该正常操作，if(!p) return  E_POINTER;这样。使用assert的语义与空指针判断是两码事。如果不想判断或者图省事，C++中可以用const  reference类型，但是不建议传入reference对象，然后在函数体内修改。</p> <p>针对内存操作，比如memset，memcpy，同样要注意不能访问越界的数据，类似规则3。</p> <p>针对C++，new  delete其实可以做出好多花样，个人感觉用处不大，因为服务器端编程大多用C配合内存池，重载new之类的学了也很少用。如果对服务器端内存管理感兴 趣，可以读读nginx的代码，简洁高效实用。</p> <p>一般来讲，应该是谁拉的屎谁擦屁股，也就是说某个对象或者函数new了一些东西，它应该负责delete，否则距离不仅仅产生美，还会产生 bug。（多废话一下，比如在aaa.cpp里面new了一些东西，然后你在bbb.cpp里面释放它，甚至在不同地方释放它，如果对程序结构不了解，很 容易产生bug）</p> <p>可以通过python或者lua编写一些小软件，检查项目中new与delete，malloc与free的个数，如果个数不匹配，就有可能有 bug，另外还可以检查new[]与delete[]的配对情况。我编写了一个这样的小工具，完善以后放出来。</p> </div><img src="http://www.cnblogs.com/lua5/aggbug/1895536.html?type=1" width="1" height="1" alt=""><p>作者: <a href="http://www.cnblogs.com/lua5/">Lua</a> 发表于 2010-12-03 15:33 <a href="http://www.cnblogs.com/lua5/archive/2010/12/03/1895536.html">原文链接</a></p><p>评论: 7　<a href="http://www.cnblogs.com/lua5/archive/2010/12/03/1895536.html#pagedcomment">查看评论</a>　<a href="http://www.cnblogs.com/lua5/archive/2010/12/03/1895536.html#commentform">发表评论</a></p><hr><p>最新新闻：<br>· <a href="http://news.cnblogs.com/n/83440/">2011年用户互联网趋势：电子商务增加娱乐性</a><span style="color:gray">(2010-12-04 12:57)</span><br>· <a href="http://news.cnblogs.com/n/83439/">下载：微软SCVMM 2008 R2 SP1 RC候选版</a><span style="color:gray">(2010-12-04 12:49)</span><br>· <a href="http://news.cnblogs.com/n/83438/">微软开始向员工发放Windows Phone 7手机</a><span style="color:gray">(2010-12-04 12:47)</span><br>· <a href="http://news.cnblogs.com/n/83436/">微软的WebMatrix现在支持PHP 5.3和PEAR</a><span style="color:gray">(2010-12-04 12:38)</span><br>· <a href="http://news.cnblogs.com/n/83435/">Google App Engine SDK 1.4.0 发布</a><span style="color:gray">(2010-12-04 12:28)</span><br></p><p>编辑推荐：<a href="http://zt.cnblogs.com/blogswarriors/">“博客无双“活动：写博客、攒园豆、赢大奖</a><br></p><p>网站导航：<a href="http://www.cnblogs.com">博客园首页</a>  <a href="http://home.cnblogs.com/">我的园子</a>  <a href="http://news.cnblogs.com">新闻</a>  <a href="http://home.cnblogs.com/ing/">闪存</a>  <a href="http://home.cnblogs.com/group/">小组</a>  <a href="http://space.cnblogs.com/q/">博问</a>  <a href="http://kb.cnblogs.com">知识库</a></p></p>


</div>


            <div class="footer">
              <div class="contact">
                <p>
                  Your Name<br />
                  What You Are<br />
                  your@email.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/yourusername/">github.com/yourusername</a><br />
                  <a href="http://twitter.com/yourusername/">twitter.com/yourusername</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

    </body>
</html>
