<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Silverlight + RIA Service的SUID的实例。</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/">Your New Jekyll Site</a></h1>
              <a class="extra" href="/">home</a>
            </div>

                <h2>Silverlight + RIA Service的SUID的实例。</h2>
<p class="meta">02 Sep 2010</p>

<div class="post">
<h2>Silverlight + RIA Service的SUID的实例。</h2>

<h3>by subwayline13</h3>

<h3>at 2010-09-01 16:53:00</h3>

<h3>original <a href="http://www.cnblogs.com/subwayline13/archive/2010/09/01/1813836.html">http://www.cnblogs.com/subwayline13/archive/2010/09/01/1813836.html</a></h3>

<p><a href="http://www.cnblogs.com/subwayline13/"><img src="http://pic.cnblogs.com/face/u61317.jpg" alt="" border="0"></a><br>作者: <a href="http://www.cnblogs.com/subwayline13/">subwayline13</a> 发表于 2010-09-01 16:53 <a href="http://www.cnblogs.com/subwayline13/archive/2010/09/01/1813836.html">原文链接</a> 阅读: 784 评论: 5</p>


<p>WCF RIA Service网上也有一些例子，不过都比较简单，我把我的一个比较接近实际的例子跟大家分享分享。</p>


<h1>1准备工作</h1>


<div>新建一个Silverlight Business Application，首先修改web.config，他自动生成的配置比较省略，我手动加入membership,role,profile的配置，我是ASP.NET MVC的项目中拷贝过来，直接用他的配置也可以，不过手动配置一下连接字符串LocalSqlServer，不然不能运行。</div>


<div>
<div>
<pre><div><span style="color:#000000">        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">membership</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">providers</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">clear </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">add </span><span style="color:#ff0000">name</span><span style="color:#0000ff">="AspNetSqlMembershipProvider"</span><span style="color:#ff0000"> type</span><span style="color:#0000ff">="System.Web.Security.SqlMembershipProvider"</span><span style="color:#ff0000"> connectionStringName</span><span style="color:#0000ff">="ApplicationServices"</span><span style="color:#ff0000"> enablePasswordRetrieval</span><span style="color:#0000ff">="false"</span><span style="color:#ff0000"> enablePasswordReset</span><span style="color:#0000ff">="true"</span><span style="color:#ff0000"> requiresQuestionAndAnswer</span><span style="color:#0000ff">="false"</span><span style="color:#ff0000"> requiresUniqueEmail</span><span style="color:#0000ff">="false"</span><span style="color:#ff0000"> maxInvalidPasswordAttempts</span><span style="color:#0000ff">="5"</span><span style="color:#ff0000"> minRequiredPasswordLength</span><span style="color:#0000ff">="6"</span><span style="color:#ff0000"> minRequiredNonalphanumericCharacters</span><span style="color:#0000ff">="0"</span><span style="color:#ff0000"> passwordAttemptWindow</span><span style="color:#0000ff">="10"</span><span style="color:#ff0000"> applicationName</span><span style="color:#0000ff">="/Vega"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">providers</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>        </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">membership</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">profile</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">providers</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">clear </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">add </span><span style="color:#ff0000">name</span><span style="color:#0000ff">="AspNetSqlProfileProvider"</span><span style="color:#ff0000"> type</span><span style="color:#0000ff">="System.Web.Profile.SqlProfileProvider"</span><span style="color:#ff0000"> connectionStringName</span><span style="color:#0000ff">="ApplicationServices"</span><span style="color:#ff0000"> applicationName</span><span style="color:#0000ff">="/"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">providers</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">properties</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">add </span><span style="color:#ff0000">name</span><span style="color:#0000ff">="FriendlyName"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">properties</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>        </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">profile</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">roleManager </span><span style="color:#ff0000">enabled</span><span style="color:#0000ff">="true"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">providers</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">clear </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">add </span><span style="color:#ff0000">name</span><span style="color:#0000ff">="AspNetSqlRoleProvider"</span><span style="color:#ff0000"> type</span><span style="color:#0000ff">="System.Web.Security.SqlRoleProvider"</span><span style="color:#ff0000"> connectionStringName</span><span style="color:#0000ff">="ApplicationServices"</span><span style="color:#ff0000"> applicationName</span><span style="color:#0000ff">="/Vega"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">add </span><span style="color:#ff0000">name</span><span style="color:#0000ff">="AspNetWindowsTokenRoleProvider"</span><span style="color:#ff0000"> type</span><span style="color:#0000ff">="System.Web.Security.WindowsTokenRoleProvider"</span><span style="color:#ff0000"> applicationName</span><span style="color:#0000ff">="/"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">providers</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>        </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">roleManager</span><span style="color:#0000ff">&gt;</span></div></pre>
</div>
<p>我用的连接字符串名字是ApplicationServices</p>
<p>如果没安装ASP.NET的SQL数据，可以用Visual Studio 命令提示(2010) （在开始菜单的Visual Studio Tools里）调出命令提示符输入aspnet_regsql,调出“ASP.NET SQL SERVER安装向导”，而在运行-cmd里因为没有相关环境变量，是调不出安装向导的。</p>
<p>新建一个ADO.NET实体数据模型。</p>
<p><img src="http://pic002.cnblogs.com/img/subwayline13/201008/2010083118011550.png"></p>
<p>编译一下，然后新建Domain Service Class，勾上Course，如果不编译，那么数据实体模型是找不到的。</p>
<p>我们需要Microsoft Silverlight 4 Toolkit，http://silverlight.codeplex.com/，没安装的话要先安装。</p>
<h1>2用户登录和角色</h1>
<div>用户登录后往往要根据不用角色实现不同的功能导航，所以要修改/Views/Login/LoginStatus.xaml 这个登录状态的用户控件。</div>
<div>首先加上管理员的功能面板。</div>
<div>
<div>
<pre><div><span style="color:#000000">        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">StackPanel </span><span style="color:#ff0000">x:Name</span><span style="color:#0000ff">="adminControls"</span><span style="color:#ff0000"> Style</span><span style="color:#0000ff">="</span><span style="color:#808000">{StaticResource LoginPanelStyle}</span><span style="color:#0000ff">"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>            </span><span style="color:#008000">&lt;!--</span><span style="color:#008000"> welcomeText.Text property's binding is setup in code-behind </span><span style="color:#008000">--&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">TextBlock </span><span style="color:#ff0000">x:Name</span><span style="color:#0000ff">="welcomeAdminText"</span><span style="color:#ff0000"> Style</span><span style="color:#0000ff">="</span><span style="color:#808000">{StaticResource WelcomeTextStyle}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> VerticalAlignment</span><span style="color:#0000ff">="Center"</span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>            </span><span style="color:#008000">&lt;!--</span><span style="color:#008000"> welcomeText.Text property's binding is setup in code-behind </span><span style="color:#008000">--&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">TextBlock </span><span style="color:#ff0000">Text</span><span style="color:#0000ff">="  |  "</span><span style="color:#ff0000"> Style</span><span style="color:#0000ff">="</span><span style="color:#808000">{StaticResource SpacerStyle}</span><span style="color:#0000ff">"</span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">HyperlinkButton </span><span style="color:#ff0000">TargetName</span><span style="color:#0000ff">="ContentFrame"</span><span style="color:#ff0000"> Content</span><span style="color:#0000ff">="课程"</span><span style="color:#ff0000"> VerticalAlignment</span><span style="color:#0000ff">="Center"</span><span style="color:#ff0000"> Foreground</span><span style="color:#0000ff">="White"</span><span style="color:#ff0000"> NavigateUri</span><span style="color:#0000ff">="/Courses"</span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">TextBlock </span><span style="color:#ff0000">Text</span><span style="color:#0000ff">="  |  "</span><span style="color:#ff0000"> Style</span><span style="color:#0000ff">="</span><span style="color:#808000">{StaticResource SpacerStyle}</span><span style="color:#0000ff">"</span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">HyperlinkButton </span><span style="color:#ff0000">TargetName</span><span style="color:#0000ff">="ContentFrame"</span><span style="color:#ff0000"> Content</span><span style="color:#0000ff">="学员"</span><span style="color:#ff0000"> VerticalAlignment</span><span style="color:#0000ff">="Center"</span><span style="color:#ff0000"> Foreground</span><span style="color:#0000ff">="White"</span><span style="color:#ff0000"> NavigateUri</span><span style="color:#0000ff">="/Students"</span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">TextBlock </span><span style="color:#ff0000">Text</span><span style="color:#0000ff">="  |  "</span><span style="color:#ff0000"> Style</span><span style="color:#0000ff">="</span><span style="color:#808000">{StaticResource SpacerStyle}</span><span style="color:#0000ff">"</span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">HyperlinkButton </span><span style="color:#ff0000">TargetName</span><span style="color:#0000ff">="ContentFrame"</span><span style="color:#ff0000"> Content</span><span style="color:#0000ff">="排课"</span><span style="color:#ff0000"> VerticalAlignment</span><span style="color:#0000ff">="Center"</span><span style="color:#ff0000"> Foreground</span><span style="color:#0000ff">="White"</span><span style="color:#ff0000"> NavigateUri</span><span style="color:#0000ff">="/Schedules"</span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">TextBlock </span><span style="color:#ff0000">Text</span><span style="color:#0000ff">="  |  "</span><span style="color:#ff0000"> Style</span><span style="color:#0000ff">="</span><span style="color:#808000">{StaticResource SpacerStyle}</span><span style="color:#0000ff">"</span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">Button </span><span style="color:#ff0000">x:Name</span><span style="color:#0000ff">="adminLogoutButton"</span><span style="color:#ff0000"> Content</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding ApplicationStrings.LogOffButton, Source={StaticResource ResourceWrapper}}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> <br>                                    Click</span><span style="color:#0000ff">="LogoutButton_Click"</span><span style="color:#ff0000"> <br>                                    Style</span><span style="color:#0000ff">="</span><span style="color:#808000">{StaticResource LoginRegisterLinkStyle}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> <br>                                    IsEnabled</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding Authentication.IsLoggingOut, Converter={StaticResource NotOperatorValueConverter}}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>        </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">StackPanel</span><span style="color:#0000ff">&gt;</span></div></pre>
</div>
<p>然后增加一个状态，叫做adminLoggedIn，在&lt;vsm:VisualStateGroup x:Name=&quot;loginStates&quot;&gt;代码短里加上adminLoggedIn的代码</p>
<p> </p>
<div>
<pre><div><span style="color:#000000">                </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">vsm:VisualState </span><span style="color:#ff0000">x:Name</span><span style="color:#0000ff">="adminLoggedIn"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                    </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">Storyboard</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">ObjectAnimationUsingKeyFrames </span><span style="color:#ff0000">BeginTime</span><span style="color:#0000ff">="00:00:00"</span><span style="color:#ff0000"> Storyboard.TargetName</span><span style="color:#0000ff">="logoutControls"</span><span style="color:#ff0000"> Storyboard.TargetProperty</span><span style="color:#0000ff">="(UIElement.Visibility)"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">DiscreteObjectKeyFrame </span><span style="color:#ff0000">KeyTime</span><span style="color:#0000ff">="00:00:00.0000000"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                                </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">DiscreteObjectKeyFrame.Value</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                                    </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">Visibility</span><span style="color:#0000ff">&gt;</span><span style="color:#000000">Collapsed</span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">Visibility</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                                </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">DiscreteObjectKeyFrame.Value</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                            </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">DiscreteObjectKeyFrame</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">ObjectAnimationUsingKeyFrames</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">ObjectAnimationUsingKeyFrames </span><span style="color:#ff0000">BeginTime</span><span style="color:#0000ff">="00:00:00"</span><span style="color:#ff0000"> Storyboard.TargetName</span><span style="color:#0000ff">="loginControls"</span><span style="color:#ff0000"> Storyboard.TargetProperty</span><span style="color:#0000ff">="(UIElement.Visibility)"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">DiscreteObjectKeyFrame </span><span style="color:#ff0000">KeyTime</span><span style="color:#0000ff">="00:00:00.0000000"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                                </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">DiscreteObjectKeyFrame.Value</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                                    </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">Visibility</span><span style="color:#0000ff">&gt;</span><span style="color:#000000">Collapsed</span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">Visibility</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                                </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">DiscreteObjectKeyFrame.Value</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                            </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">DiscreteObjectKeyFrame</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">ObjectAnimationUsingKeyFrames</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                    </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">Storyboard</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">vsm:VisualState</span><span style="color:#0000ff">&gt;</span></div></pre>
</div>
<p> </p>
不要忘了在其他的状态里加上把adminControls设置为不显示，只有在adminLoggedIn才显示管理员的功能导航。
<p> </p>
<p>在构造器函数里加上welcomeAdminText的绑定</p>
<p> </p>
<div>
<pre><div><span style="color:#0000ff">public</span><span style="color:#000000"> LoginStatus()<br>        {<br>            </span><span style="color:#0000ff">this</span><span style="color:#000000">.InitializeComponent();<br><br>            </span><span style="color:#0000ff">this</span><span style="color:#000000">.welcomeText.SetBinding(TextBlock.TextProperty, WebContext.Current.CreateOneWayBinding(</span><span style="color:#800000">"</span><span style="color:#800000">User.DisplayName</span><span style="color:#800000">"</span><span style="color:#000000">, </span><span style="color:#0000ff">new</span><span style="color:#000000"> StringFormatValueConverter(ApplicationStrings.WelcomeMessage)));<br>            </span><span style="color:#0000ff">this</span><span style="color:#000000">.welcomeAdminText.SetBinding(TextBlock.TextProperty, WebContext.Current.CreateOneWayBinding(</span><span style="color:#800000">"</span><span style="color:#800000">User.DisplayName</span><span style="color:#800000">"</span><span style="color:#000000">, </span><span style="color:#0000ff">new</span><span style="color:#000000"> StringFormatValueConverter(ApplicationStrings.WelcomeMessage)));<br>            </span><span style="color:#0000ff">this</span><span style="color:#000000">.authService.LoggedIn </span><span style="color:#000000">+=</span><span style="color:#000000"> </span><span style="color:#0000ff">this</span><span style="color:#000000">.Authentication_LoggedIn;<br>            </span><span style="color:#0000ff">this</span><span style="color:#000000">.authService.LoggedOut </span><span style="color:#000000">+=</span><span style="color:#000000"> </span><span style="color:#0000ff">this</span><span style="color:#000000">.Authentication_LoggedOut;<br>            </span><span style="color:#0000ff">this</span><span style="color:#000000">.UpdateLoginState();<br>        }</span></div></pre>
</div>
<p> </p>
修改UpdateLoginState函数，判断如果当前用户角色有admin，就显示admin的功能导航按钮
<div>
<pre><div><span style="color:#000000"><br>        </span><span style="color:#0000ff">private</span><span style="color:#000000"> </span><span style="color:#0000ff">void</span><span style="color:#000000"> UpdateLoginState()<br>        {<br>            </span><span style="color:#0000ff">if</span><span style="color:#000000"> (WebContext.Current.User.IsAuthenticated)<br>            {<br>                VisualStateManager.GoToState(</span><span style="color:#0000ff">this</span><span style="color:#000000">, (WebContext.Current.Authentication </span><span style="color:#0000ff">is</span><span style="color:#000000"> WindowsAuthentication) </span><span style="color:#000000">?</span><span style="color:#000000"><br>                    </span><span style="color:#800000">"</span><span style="color:#800000">windowsAuth</span><span style="color:#800000">"</span><span style="color:#000000"> :<br>                    </span><span style="color:#0000ff">this</span><span style="color:#000000">.authService.User.IsInRole(</span><span style="color:#800000">"</span><span style="color:#800000">admin</span><span style="color:#800000">"</span><span style="color:#000000">) </span><span style="color:#000000">?</span><span style="color:#000000"> </span><span style="color:#800000">"</span><span style="color:#800000">adminLoggedIn</span><span style="color:#800000">"</span><span style="color:#000000"> : </span><span style="color:#800000">"</span><span style="color:#800000">loggedIn</span><span style="color:#800000">"</span><span style="color:#000000">, </span><span style="color:#0000ff">true</span><span style="color:#000000">);<br>            }<br>            </span><span style="color:#0000ff">else</span><span style="color:#000000"><br>            {<br>                VisualStateManager.GoToState(</span><span style="color:#0000ff">this</span><span style="color:#000000">, </span><span style="color:#800000">"</span><span style="color:#800000">loggedOut</span><span style="color:#800000">"</span><span style="color:#000000">, </span><span style="color:#0000ff">true</span><span style="color:#000000">);<br>            }<br>        }</span></div></pre>
</div>
<p> </p>
通过ASP.NET 网站配置加上个admin角色和用户。
<p><img src="http://pic002.cnblogs.com/img/subwayline13/201009/2010090115513050.png"></p>
<p>好了，用户程序登录之后判断有admin角色，登录后就显示管理员的功能导航了。</p>
<p><img src="http://pic002.cnblogs.com/img/subwayline13/201009/2010090115534190.png"></p>
</div>
<h1>3绑定数据源</h1>
<div>新建一个课程页面，在Page页面上加上DomainDataSource，一种办法是通过数据源窗口直接拽页面上去。</div>
<div><img src="http://pic002.cnblogs.com/img/subwayline13/201008/2010083118114574.png"></div>
<div>他会自动帮你建立一个riaDataSource,还有DataGrid。</div>
<div>在DataGrid外面加一个BusyIndicator（他是Silverlight Toolkit的控件之一），如果BusyIndicator得IsBusy为Ture，那么会出现一个等待的提示，并且BusyIndicator包含的内容不可操作，所以要把BusyIndicator的IsBusy和DomainDataSource的IsBusy绑定起来： IsBusy=&quot;{Binding IsBusy, ElementName=courseDomainDataSource}&quot; 。</div>
<div>DataGrid已经和DomainDataSource绑定了，IDE帮我们自动加上代码： ItemsSource=&quot;{Binding Data, ElementName=courseDomainDataSource}&quot;。</div>
<div>我还要加个简单搜索，通过课程名称模糊搜索，加一个TextBox。</div>
<div>
<div>
<pre><div><span style="color:#0000ff">&lt;</span><span style="color:#800000">TextBlock </span><span style="color:#ff0000">Margin</span><span style="color:#0000ff">="0,18,137,0"</span><span style="color:#ff0000"> Text</span><span style="color:#0000ff">="课程名称"</span><span style="color:#ff0000"> FontSize</span><span style="color:#0000ff">="12"</span><span style="color:#ff0000"> HorizontalAlignment</span><span style="color:#0000ff">="Right"</span><span style="color:#ff0000"> Width</span><span style="color:#0000ff">="48"</span><span style="color:#ff0000"> Height</span><span style="color:#0000ff">="23"</span><span style="color:#ff0000"> VerticalAlignment</span><span style="color:#0000ff">="Top"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br></span><span style="color:#0000ff">&lt;</span><span style="color:#800000">TextBox </span><span style="color:#ff0000">Margin</span><span style="color:#0000ff">="0,15,0,0"</span><span style="color:#ff0000"> x:Name</span><span style="color:#0000ff">="tbFilterCourseName"</span><span style="color:#ff0000"> Height</span><span style="color:#0000ff">="23"</span><span style="color:#ff0000"> VerticalAlignment</span><span style="color:#0000ff">="Top"</span><span style="color:#ff0000"> HorizontalAlignment</span><span style="color:#0000ff">="Right"</span><span style="color:#ff0000"> Width</span><span style="color:#0000ff">="120"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span></div></pre>
</div>
<p>好了，然后拖一个DataPaper上去实现分页，也和DomainDataSource绑定上 Source=&quot;{Binding Data, ElementName=courseDomainDataSource}&quot;。</p>
<p>我们还要加上一排CheckBox用于多选，跟ASP.NET的GridView差不多，有一种DataGridTemplateColumn。CheckBox直接绑定实体对象，加上<span>Tag</span><span>="</span><span>{Binding}</span><span>"</span>，然后给CheckBox加上事件，在选中的把绑定的对象加入到一个List里，取消选中的时候在取出来，维护一个要删除对象的列表。</p>
<p> </p>
<div>
<pre><div><span style="color:#0000ff">　　　　private</span><span style="color:#000000"> IList</span><span style="color:#000000">&lt;</span><span style="color:#000000">Course</span><span style="color:#000000">&gt;</span><span style="color:#000000"> deletedCourses </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#0000ff">new</span><span style="color:#000000"> List</span><span style="color:#000000">&lt;</span><span style="color:#000000">Course</span><span style="color:#000000">&gt;</span><span style="color:#000000">();</span></div><div><span style="color:#000000"><br>        </span><span style="color:#0000ff">private</span><span style="color:#000000"> </span><span style="color:#0000ff">void</span><span style="color:#000000"> CheckBox_Checked(</span><span style="color:#0000ff">object</span><span style="color:#000000"> sender, RoutedEventArgs e)<br>        {<br>            var checkBox </span><span style="color:#000000">=</span><span style="color:#000000"> sender </span><span style="color:#0000ff">as</span><span style="color:#000000"> CheckBox;<br>            </span><span style="color:#0000ff">this</span><span style="color:#000000">.deletedCourses.Add(checkBox.Tag </span><span style="color:#0000ff">as</span><span style="color:#000000"> Course);<br>        }<br><br>        </span><span style="color:#0000ff">private</span><span style="color:#000000"> </span><span style="color:#0000ff">void</span><span style="color:#000000"> CheckBox_Unchecked(</span><span style="color:#0000ff">object</span><span style="color:#000000"> sender, RoutedEventArgs e)<br>        {<br>            var checkBox </span><span style="color:#000000">=</span><span style="color:#000000"> sender </span><span style="color:#0000ff">as</span><span style="color:#000000"> CheckBox;<br>            </span><span style="color:#0000ff">this</span><span style="color:#000000">.deletedCourses.Remove(checkBox.Tag </span><span style="color:#0000ff">as</span><span style="color:#000000"> Course);<br>        }</span></div></pre>
</div>
<p>另外加一个删除全部的按钮。</p>
<p>下面是BusyIndicator的全部代码</p>
<div>
<pre><div><span style="color:#000000">        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">toolkit:BusyIndicator </span><span style="color:#ff0000">x:Name</span><span style="color:#0000ff">="dataBusyIndicator"</span><span style="color:#ff0000"> BusyContent</span><span style="color:#0000ff">="载入课程数据"</span><span style="color:#ff0000"> IsBusy</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding IsBusy, ElementName=courseDomainDataSource}</span><span style="color:#0000ff">"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">Grid</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">sdk:DataGrid </span><span style="color:#ff0000">AutoGenerateColumns</span><span style="color:#0000ff">="False"</span><span style="color:#ff0000"> ItemsSource</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding Data, ElementName=courseDomainDataSource}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> x:Name</span><span style="color:#0000ff">="courseDataGrid"</span><span style="color:#ff0000"> RowDetailsVisibilityMode</span><span style="color:#0000ff">="VisibleWhenSelected"</span><span style="color:#ff0000"> Margin</span><span style="color:#0000ff">="30,47,0,33"</span><span style="color:#ff0000"> IsReadOnly</span><span style="color:#0000ff">="True"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                    </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">sdk:DataGrid.Resources</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">DataTemplate </span><span style="color:#ff0000">x:Name</span><span style="color:#0000ff">="CheckBoxCellTemplate"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">CheckBox </span><span style="color:#ff0000">VerticalAlignment</span><span style="color:#0000ff">="Center"</span><span style="color:#ff0000"> HorizontalAlignment</span><span style="color:#0000ff">="Center"</span><span style="color:#ff0000"> Tag</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> Checked</span><span style="color:#0000ff">="CheckBox_Checked"</span><span style="color:#ff0000"> Unchecked</span><span style="color:#0000ff">="CheckBox_Unchecked"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">DataTemplate</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                    </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">sdk:DataGrid.Resources</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                    </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">sdk:DataGrid.Columns</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">sdk:DataGridTemplateColumn </span><span style="color:#ff0000">CanUserReorder</span><span style="color:#0000ff">="True"</span><span style="color:#ff0000"> CanUserResize</span><span style="color:#0000ff">="True"</span><span style="color:#ff0000"> CanUserSort</span><span style="color:#0000ff">="True"</span><span style="color:#ff0000"> Width</span><span style="color:#0000ff">="30"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">sdk:DataGridTemplateColumn.CellEditingTemplate</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                                </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">StaticResource </span><span style="color:#ff0000">ResourceKey</span><span style="color:#0000ff">="CheckBoxCellTemplate"</span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                            </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">sdk:DataGridTemplateColumn.CellEditingTemplate</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">sdk:DataGridTemplateColumn</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">sdk:DataGridTextColumn </span><span style="color:#ff0000">x:Name</span><span style="color:#0000ff">="courseNameColumn"</span><span style="color:#ff0000"> Binding</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding CourseName}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> Header</span><span style="color:#0000ff">="课程名称"</span><span style="color:#ff0000"> Width</span><span style="color:#0000ff">="SizeToCells"</span><span style="color:#ff0000"> MinWidth</span><span style="color:#0000ff">="70"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">sdk:DataGridTextColumn </span><span style="color:#ff0000">x:Name</span><span style="color:#0000ff">="titleColumn"</span><span style="color:#ff0000"> Binding</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding Title}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> Header</span><span style="color:#0000ff">="标题"</span><span style="color:#ff0000"> Width</span><span style="color:#0000ff">="SizeToCells"</span><span style="color:#ff0000"> MinWidth</span><span style="color:#0000ff">="100"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">sdk:DataGridTextColumn </span><span style="color:#ff0000">x:Name</span><span style="color:#0000ff">="providerColumn"</span><span style="color:#ff0000"> Binding</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding Provider}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> Header</span><span style="color:#0000ff">="内容提供商"</span><span style="color:#ff0000"> Width</span><span style="color:#0000ff">="SizeToCells"</span><span style="color:#ff0000"> MinWidth</span><span style="color:#0000ff">="70"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">sdk:DataGridTextColumn </span><span style="color:#ff0000">x:Name</span><span style="color:#0000ff">="teachersColumn"</span><span style="color:#ff0000"> Binding</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding Teachers}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> Header</span><span style="color:#0000ff">="主讲老师"</span><span style="color:#ff0000"> Width</span><span style="color:#0000ff">="SizeToCells"</span><span style="color:#ff0000"> MinWidth</span><span style="color:#0000ff">="70"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">sdk:DataGridTextColumn </span><span style="color:#ff0000">x:Name</span><span style="color:#0000ff">="publishDateColumn"</span><span style="color:#ff0000"> Binding</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding PublishDate}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> Header</span><span style="color:#0000ff">="发布时间"</span><span style="color:#ff0000"> Width</span><span style="color:#0000ff">="SizeToCells"</span><span style="color:#ff0000"> MinWidth</span><span style="color:#0000ff">="70"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">sdk:DataGridTextColumn </span><span style="color:#ff0000">x:Name</span><span style="color:#0000ff">="createTimeColumn"</span><span style="color:#ff0000"> Binding</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding CreateTime}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> Header</span><span style="color:#0000ff">="创建时间"</span><span style="color:#ff0000"> Width</span><span style="color:#0000ff">="SizeToCells"</span><span style="color:#ff0000"> MinWidth</span><span style="color:#0000ff">="70"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                    </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">sdk:DataGrid.Columns</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">sdk:DataGrid</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">sdk:DataPager </span><span style="color:#ff0000">Margin</span><span style="color:#0000ff">="30,444,0,10"</span><span style="color:#ff0000"> x:Name</span><span style="color:#0000ff">="dataPager1"</span><span style="color:#ff0000"> PageSize</span><span style="color:#0000ff">="10"</span><span style="color:#ff0000"> Source</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding Data, ElementName=courseDomainDataSource}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">TextBlock </span><span style="color:#ff0000">Margin</span><span style="color:#0000ff">="0,18,137,0"</span><span style="color:#ff0000"> Text</span><span style="color:#0000ff">="课程名称"</span><span style="color:#ff0000"> FontSize</span><span style="color:#0000ff">="12"</span><span style="color:#ff0000"> HorizontalAlignment</span><span style="color:#0000ff">="Right"</span><span style="color:#ff0000"> Width</span><span style="color:#0000ff">="48"</span><span style="color:#ff0000"> Height</span><span style="color:#0000ff">="23"</span><span style="color:#ff0000"> VerticalAlignment</span><span style="color:#0000ff">="Top"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">TextBox </span><span style="color:#ff0000">Margin</span><span style="color:#0000ff">="0,15,0,0"</span><span style="color:#ff0000"> x:Name</span><span style="color:#0000ff">="tbFilterCourseName"</span><span style="color:#ff0000"> Height</span><span style="color:#0000ff">="23"</span><span style="color:#ff0000"> VerticalAlignment</span><span style="color:#0000ff">="Top"</span><span style="color:#ff0000"> HorizontalAlignment</span><span style="color:#0000ff">="Right"</span><span style="color:#ff0000"> Width</span><span style="color:#0000ff">="120"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">Button </span><span style="color:#ff0000">Content</span><span style="color:#0000ff">="删除所选"</span><span style="color:#ff0000"> Height</span><span style="color:#0000ff">="23"</span><span style="color:#ff0000"> HorizontalAlignment</span><span style="color:#0000ff">="Left"</span><span style="color:#ff0000"> Margin</span><span style="color:#0000ff">="30,15,0,0"</span><span style="color:#ff0000"> Name</span><span style="color:#0000ff">="button1"</span><span style="color:#ff0000"> VerticalAlignment</span><span style="color:#0000ff">="Top"</span><span style="color:#ff0000"> Width</span><span style="color:#0000ff">="75"</span><span style="color:#ff0000"> Click</span><span style="color:#0000ff">="button1_Click"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">Grid</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>        </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">toolkit:BusyIndicator</span><span style="color:#0000ff">&gt;</span></div></pre>
</div>
<p> </p>
<p>然后，要把DomainDataSource.FilterDescriptors的筛选和我刚才加的TextBox绑定起来，这样就自动搜索了。</p>
</div>
<div>
<div>
<pre><div><span style="color:#000000">        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">riaControls:DomainDataSource </span><span style="color:#ff0000">AutoLoad</span><span style="color:#0000ff">="True"</span><span style="color:#ff0000"> Height</span><span style="color:#0000ff">="0"</span><span style="color:#ff0000"> LoadedData</span><span style="color:#0000ff">="courseDomainDataSource_LoadedData"</span><span style="color:#ff0000"> x:Name</span><span style="color:#0000ff">="courseDomainDataSource"</span><span style="color:#ff0000"> QueryName</span><span style="color:#0000ff">="GetCoursesQuery"</span><span style="color:#ff0000"> Width</span><span style="color:#0000ff">="0"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">riaControls:DomainDataSource.SortDescriptors</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">riaControls:SortDescriptor </span><span style="color:#ff0000">Direction</span><span style="color:#0000ff">="Descending"</span><span style="color:#ff0000"> PropertyPath</span><span style="color:#0000ff">="CourseID"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">riaControls:DomainDataSource.SortDescriptors</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">riaControls:DomainDataSource.FilterDescriptors</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">riaControls:FilterDescriptor </span><span style="color:#ff0000">Operator</span><span style="color:#0000ff">="Contains"</span><span style="color:#ff0000"> PropertyPath</span><span style="color:#0000ff">="CourseName"</span><span style="color:#ff0000"> IgnoredValue</span><span style="color:#0000ff">=""</span><span style="color:#ff0000"> Value</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding Text, ElementName=tbFilterCourseName}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">riaControls:DomainDataSource.FilterDescriptors</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">riaControls:DomainDataSource.DomainContext</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">my1:VegaContext </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">riaControls:DomainDataSource.DomainContext</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>        </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">riaControls:DomainDataSource</span><span style="color:#0000ff">&gt;</span></div></pre>
</div>
<p> </p>
如果不加FilterDescriptors，那么分页的时候报错，因为分页前必须Order，也可以在后台加一个默认排序</div>
<div>
<div>
<pre><div><span style="color:#000000">        </span><span style="color:#0000ff">public</span><span style="color:#000000"> IQueryable</span><span style="color:#000000">&lt;</span><span style="color:#000000">Course</span><span style="color:#000000">&gt;</span><span style="color:#000000"> GetCourses()<br>        {<br>            </span><span style="color:#0000ff">return</span><span style="color:#000000"> </span><span style="color:#0000ff">this</span><span style="color:#000000">.ObjectContext.Courses.OrderByDescending</span><span style="color:#000000">&lt;</span><span style="color:#000000">Course, </span><span style="color:#0000ff">int</span><span style="color:#000000">&gt;</span><span style="color:#000000">(c </span><span style="color:#000000">=&gt;</span><span style="color:#000000"> c.CourseID);<br>        }</span></div></pre>
</div>
<p> </p>
效果如下</div>
<div><img src="http://pic002.cnblogs.com/img/subwayline13/201008/2010083118315457.png"></div>
<h1>4删除全部选择的项目。</h1>
<div>只需要逐个删除列表中的对象，然后DomainDataSource.SubmitChanges()就行了，很方便吧。</div>
<div>
<h1>
<pre><div><span style="color:#000000">        </span><span style="color:#0000ff">private</span><span style="color:#000000"> </span><span style="color:#0000ff">void</span><span style="color:#000000"> button1_Click(</span><span style="color:#0000ff">object</span><span style="color:#000000"> sender, RoutedEventArgs e)<br>        {<br>            var result </span><span style="color:#000000">=</span><span style="color:#000000"> MessageBox.Show(</span><span style="color:#800000">"</span><span style="color:#800000">确定删除该课程?删除后不可恢复!</span><span style="color:#800000">"</span><span style="color:#000000">, </span><span style="color:#800000">"</span><span style="color:#800000">提示</span><span style="color:#800000">"</span><span style="color:#000000">, MessageBoxButton.OKCancel);<br>            </span><span style="color:#0000ff">if</span><span style="color:#000000"> (result </span><span style="color:#000000">==</span><span style="color:#000000"> MessageBoxResult.OK)<br>            {<br>                </span><span style="color:#0000ff">foreach</span><span style="color:#000000"> (var course </span><span style="color:#0000ff">in</span><span style="color:#000000"> </span><span style="color:#0000ff">this</span><span style="color:#000000">.deletedCourses)<br>                {<br>                    </span><span style="color:#0000ff">this</span><span style="color:#000000">.courseDomainDataSource.DataView.Remove(course);<br>                }<br>                </span><span style="color:#0000ff">this</span><span style="color:#000000">.deletedCourses.Clear();<br>                </span><span style="color:#0000ff">this</span><span style="color:#000000">.courseDomainDataSource.SubmitChanges();<br>            }<br>        }</span></div></pre>
</h1>
<h1>5上传图片</h1>
<div>我需要一个上传图片的功能，首先需要后台支持，建一个DomainService专门负责上传。</div>
<div>
<div>
<pre><div><span style="color:#000000">    [EnableClientAccess()]<br>    </span><span style="color:#0000ff">public</span><span style="color:#000000"> </span><span style="color:#0000ff">class</span><span style="color:#000000"> UploadService : DomainService<br>    {<br>        </span><span style="color:#0000ff">public</span><span style="color:#000000"> </span><span style="color:#0000ff">string</span><span style="color:#000000"> Upload(</span><span style="color:#0000ff">byte</span><span style="color:#000000">[] stream,</span><span style="color:#0000ff">string</span><span style="color:#000000"> extension)<br>        {<br>            var rootPath </span><span style="color:#000000">=</span><span style="color:#000000"> HttpContext.Current.Server.MapPath(</span><span style="color:#800000">"</span><span style="color:#800000">/Uploads</span><span style="color:#800000">"</span><span style="color:#000000">);<br>            var datePath </span><span style="color:#000000">=</span><span style="color:#000000"> DateTime.Now.ToString(</span><span style="color:#800000">"</span><span style="color:#800000">yyyyMMdd</span><span style="color:#800000">"</span><span style="color:#000000">);<br>            var dirPath </span><span style="color:#000000">=</span><span style="color:#000000"> Path.Combine(rootPath, datePath);<br>            </span><span style="color:#0000ff">if</span><span style="color:#000000"> (</span><span style="color:#000000">!</span><span style="color:#000000">Directory.Exists(dirPath))<br>            {<br>                Directory.CreateDirectory(dirPath);<br>            }<br><br>            var fileName </span><span style="color:#000000">=</span><span style="color:#000000"> Guid.NewGuid().ToString() </span><span style="color:#000000">+</span><span style="color:#000000"> extension;<br>            </span><span style="color:#0000ff">using</span><span style="color:#000000"> (var fileStream </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#0000ff">new</span><span style="color:#000000"> FileStream(<br>                Path.Combine(dirPath, fileName), FileMode.Create, FileAccess.Write))<br>            {<br>                fileStream.Write(stream, </span><span style="color:#800080">0</span><span style="color:#000000">, stream.Length);<br>                fileStream.Flush();<br>                fileStream.Close();<br>            }<br>            </span><span style="color:#0000ff">return</span><span style="color:#000000"> </span><span style="color:#800000">"</span><span style="color:#800000">/Uploads/</span><span style="color:#800000">"</span><span style="color:#000000"> </span><span style="color:#000000">+</span><span style="color:#000000"> datePath </span><span style="color:#000000">+</span><span style="color:#000000"> </span><span style="color:#800000">"</span><span style="color:#800000">/</span><span style="color:#800000">"</span><span style="color:#000000"> </span><span style="color:#000000">+</span><span style="color:#000000"> fileName;<br>        }<br>    }</span></div></pre>
</div>
<p> </p>
代码很简单，就一个方法，将传过来的字节流保存到服务器上，然后返回为这个文件自动生成的路径。</div>
<div>在服务器端建一个DomainService后，客户端会自动生成调用的代码，真的很方便。</div>
<div>在客户端直接实例化一个Context就能用了 private UploadContext uploadContext = new UploadContext();</div>
<div>在Silverlight建一个用户控件，专门负责上传和现实图片。</div>
<div>
<div>
<pre><div><span style="color:#0000ff">&lt;</span><span style="color:#800000">UserControl </span><span style="color:#ff0000">xmlns:toolkit</span><span style="color:#0000ff">="http://schemas.microsoft.com/winfx/2006/xaml/presentation/toolkit"</span><span style="color:#ff0000">  x:Class</span><span style="color:#0000ff">="Vega.Controls.SelecteImage"</span><span style="color:#ff0000"><br>    xmlns</span><span style="color:#0000ff">="http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span><span style="color:#ff0000"><br>    xmlns:x</span><span style="color:#0000ff">="http://schemas.microsoft.com/winfx/2006/xaml"</span><span style="color:#ff0000"><br>    xmlns:d</span><span style="color:#0000ff">="http://schemas.microsoft.com/expression/blend/2008"</span><span style="color:#ff0000"><br>    xmlns:mc</span><span style="color:#0000ff">="http://schemas.openxmlformats.org/markup-compatibility/2006"</span><span style="color:#ff0000"><br>    mc:Ignorable</span><span style="color:#0000ff">="d"</span><span style="color:#ff0000"><br>    d:DesignHeight</span><span style="color:#0000ff">="300"</span><span style="color:#ff0000"> d:DesignWidth</span><span style="color:#0000ff">="400"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>    </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">toolkit:BusyIndicator </span><span style="color:#ff0000">Name</span><span style="color:#0000ff">="busyIndicator"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">StackPanel </span><span style="color:#ff0000">Margin</span><span style="color:#0000ff">="0"</span><span style="color:#ff0000"> Orientation</span><span style="color:#0000ff">="Horizontal"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">Image </span><span style="color:#ff0000">HorizontalAlignment</span><span style="color:#0000ff">="Left"</span><span style="color:#ff0000"> VerticalAlignment</span><span style="color:#0000ff">="Top"</span><span style="color:#ff0000"> Source</span><span style="color:#0000ff">="/Vega;component/Assets/Icons/picture2.png"</span><span style="color:#ff0000"> MaxWidth</span><span style="color:#0000ff">="150"</span><span style="color:#ff0000"> MaxHeight</span><span style="color:#0000ff">="150"</span><span style="color:#ff0000"> Name</span><span style="color:#0000ff">="image"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">Button </span><span style="color:#ff0000">x:Name</span><span style="color:#0000ff">="btnSelected"</span><span style="color:#ff0000"> Content</span><span style="color:#0000ff">="选择"</span><span style="color:#ff0000"> Margin</span><span style="color:#0000ff">="8,0,0,0"</span><span style="color:#ff0000"> HorizontalAlignment</span><span style="color:#0000ff">="Left"</span><span style="color:#ff0000"> VerticalAlignment</span><span style="color:#0000ff">="Bottom"</span><span style="color:#ff0000"> Click</span><span style="color:#0000ff">="btnSelected_Click"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>        </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">StackPanel</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>    </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">toolkit:BusyIndicator</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br></span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">UserControl</span><span style="color:#0000ff">&gt;</span></div></pre>
</div>
<p> </p>
</div>
点击选择按钮，出现一个文件选择框，然后将选中文件上传到服务器，将返回的图片路径复制给Image控件</div>
<div>
<div>
<pre><div><span style="color:#000000">        </span><span style="color:#0000ff">private</span><span style="color:#000000"> </span><span style="color:#0000ff">void</span><span style="color:#000000"> btnSelected_Click(</span><span style="color:#0000ff">object</span><span style="color:#000000"> sender, RoutedEventArgs e)<br>        {<br>            var fileDialog </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#0000ff">new</span><span style="color:#000000"> OpenFileDialog()<br>            {<br>                Filter </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#800000">"</span><span style="color:#800000">图片(.jpg)|*.jpg|图片(.jpeg)|*.jpeg|图片(.png)|*.png</span><span style="color:#800000">"</span><span style="color:#000000">,<br>                Multiselect </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#0000ff">false</span><span style="color:#000000"><br>            };<br><br>            var result </span><span style="color:#000000">=</span><span style="color:#000000"> fileDialog.ShowDialog();<br>            </span><span style="color:#0000ff">if</span><span style="color:#000000"> (result.HasValue </span><span style="color:#000000">&amp;&amp;</span><span style="color:#000000"> result.Value)<br>            {<br>                var stream </span><span style="color:#000000">=</span><span style="color:#000000"> fileDialog.File.OpenRead();<br>                var bytes </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#0000ff">new</span><span style="color:#000000"> </span><span style="color:#0000ff">byte</span><span style="color:#000000">[stream.Length];<br>                stream.Read(bytes, </span><span style="color:#800080">0</span><span style="color:#000000">, bytes.Length);<br>                </span><span style="color:#0000ff">this</span><span style="color:#000000">.busyIndicator.IsBusy </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#0000ff">true</span><span style="color:#000000">;<br>                var op </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#0000ff">this</span><span style="color:#000000">.uploadContext.Upload(bytes, fileDialog.File.Extension);<br>                op.Completed </span><span style="color:#000000">+=</span><span style="color:#000000"> (opSender, opE) </span><span style="color:#000000">=&gt;</span><span style="color:#000000"> {<br>                    </span><span style="color:#0000ff">this</span><span style="color:#000000">.ImageUri </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#0000ff">new</span><span style="color:#000000"> Uri(op.Value, UriKind.Relative);<br>                    </span><span style="color:#0000ff">this</span><span style="color:#000000">.busyIndicator.IsBusy </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#0000ff">false</span><span style="color:#000000">;<br>                };<br>            }<br>        }</span></div></pre>
</div>
<p> </p>
然后，我为控件加了一个属性，ImageUrl暴露给外面，提供绑定什么的功能。</div>
<div>
<div>
<pre><div><span style="color:#000000">        </span><span style="color:#0000ff">public</span><span style="color:#000000"> </span><span style="color:#0000ff">static</span><span style="color:#000000"> </span><span style="color:#0000ff">readonly</span><span style="color:#000000"> DependencyProperty ImageUriProperty </span><span style="color:#000000">=</span><span style="color:#000000"> DependencyProperty.Register(<br>            </span><span style="color:#800000">"</span><span style="color:#800000">ImageUri</span><span style="color:#800000">"</span><span style="color:#000000">,<br>            </span><span style="color:#0000ff">typeof</span><span style="color:#000000">(Uri),<br>            </span><span style="color:#0000ff">typeof</span><span style="color:#000000">(SelecteImage),<br>            </span><span style="color:#0000ff">new</span><span style="color:#000000"> PropertyMetadata(</span><span style="color:#0000ff">null</span><span style="color:#000000"> , </span><span style="color:#0000ff">new</span><span style="color:#000000"> PropertyChangedCallback(OnImageUriChanged)));<br><br>        </span><span style="color:#0000ff">private</span><span style="color:#000000"> </span><span style="color:#0000ff">static</span><span style="color:#000000"> </span><span style="color:#0000ff">void</span><span style="color:#000000"> OnImageUriChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)<br>        {<br>            ((SelecteImage)d).OnImageUriChanged(e);<br>        }<br><br>        </span><span style="color:#0000ff">protected</span><span style="color:#000000"> </span><span style="color:#0000ff">virtual</span><span style="color:#000000"> </span><span style="color:#0000ff">void</span><span style="color:#000000"> OnImageUriChanged(DependencyPropertyChangedEventArgs e)<br>        {<br>            </span><span style="color:#0000ff">if</span><span style="color:#000000"> (e.NewValue </span><span style="color:#000000">==</span><span style="color:#000000"> </span><span style="color:#0000ff">null</span><span style="color:#000000">)<br>            {<br>                </span><span style="color:#0000ff">return</span><span style="color:#000000">;<br>            }<br>            var uri </span><span style="color:#000000">=</span><span style="color:#000000"> (Uri)e.NewValue;<br>            </span><span style="color:#0000ff">if</span><span style="color:#000000"> (</span><span style="color:#000000">!</span><span style="color:#000000">uri.IsAbsoluteUri)<br>            {<br>                </span><span style="color:#008000">//</span><span style="color:#008000">Application.Current.Host.Source</span><span style="color:#008000"><br></span><span style="color:#000000">                var source </span><span style="color:#000000">=</span><span style="color:#000000"> Application.Current.Host.Source;<br>                uri </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#0000ff">new</span><span style="color:#000000"> Uri(String.Format(</span><span style="color:#800000">"</span><span style="color:#800000">{0}://{1}:{2}{3}</span><span style="color:#800000">"</span><span style="color:#000000">,source.Scheme,source.Host,source.Port,uri.OriginalString), UriKind.Absolute);<br>            }<br>            </span><span style="color:#0000ff">this</span><span style="color:#000000">.image.Source </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#0000ff">new</span><span style="color:#000000"> BitmapImage(uri);<br>        }<br><br>        </span><span style="color:#0000ff">public</span><span style="color:#000000"> Uri ImageUri<br>        {<br>            </span><span style="color:#0000ff">get</span><span style="color:#000000"> { </span><span style="color:#0000ff">return</span><span style="color:#000000"> (Uri)GetValue(ImageUriProperty); }<br>            </span><span style="color:#0000ff">set</span><span style="color:#000000"> { SetValue(ImageUriProperty, value); }<br>        }</span></div></pre>
</div>
<p> </p>
由于Silverlight中的相对Uri并不是只服务器上的资源，而是指XAP文件中的资源，所以我吧相对地址改为绝对地址。</div>
<div>这个图片上传控件就OK乐。</div>
<h1>6DataForm，实现新增和编辑</h1>
<div>首先拖上去一个DataForm控件，然后将DataForm和DomainService绑定起来。ItemsSource="{Binding ElementName=courseDomainDataSource, Path=Data}" CurrentItem="{Binding ElementName=courseDomainDataSource, Path=DataCurrentItem}"，ItemSource绑定的是数据源，CurrentItem绑定时当前项目，如果不绑定ItemSource,只绑定CurrentItem的话就可以用CurrentItem="{Binding ElementName=courseDomainDataSource, Path=Data.CurrentItem}"，不过如果这样的话，就只能编辑不能新增了。DataForm有很多按钮，比如导航的，编辑的，删除的，我只需需要增加和编辑，CommandButtonsVisibility="Add, Edit, Commit, Cancel"，如果需要全部按钮的话CommandButtonsVisibility="All"就行了。</div>
<div>另外，外面要重新设置DataForm的字段，把刚才做的上传图片的控件加进入，我需要编辑EditDataTemplate。</div>
<div>
<div>
<pre><div><span style="color:#0000ff">&lt;</span><span style="color:#800000">toolkit:BusyIndicator </span><span style="color:#ff0000">Grid.Column</span><span style="color:#0000ff">="1"</span><span style="color:#ff0000"> x:Name</span><span style="color:#0000ff">="formBusyIndicator"</span><span style="color:#ff0000"> IsBusy</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding IsBusy, ElementName=courseDomainDataSource}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">toolkit:DataForm </span><span style="color:#ff0000">Grid.Column</span><span style="color:#0000ff">="1"</span><span style="color:#ff0000"> Margin</span><span style="color:#0000ff">="30,18,30,12"</span><span style="color:#ff0000"> x:Name</span><span style="color:#0000ff">="dfCourse"</span><span style="color:#ff0000"> AutoEdit</span><span style="color:#0000ff">="False"</span><span style="color:#ff0000"> ItemsSource</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding ElementName=courseDomainDataSource, Path=Data}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> CurrentItem</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding CurrentItem}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> AutoGenerateFields</span><span style="color:#0000ff">="False"</span><span style="color:#ff0000"> AutoCommit</span><span style="color:#0000ff">="False"</span><span style="color:#ff0000"> EditEnded</span><span style="color:#0000ff">="dfCourse_EditEnded"</span><span style="color:#ff0000"> CommandButtonsVisibility</span><span style="color:#0000ff">="Add, Edit, Commit, Cancel"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">toolkit:DataForm.Resources</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">DataTemplate </span><span style="color:#ff0000">x:Key</span><span style="color:#0000ff">="EditDataTemplate"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                    </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">StackPanel</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">toolkit:DataField </span><span style="color:#ff0000">Label</span><span style="color:#0000ff">="课程名称："</span><span style="color:#ff0000"> Margin</span><span style="color:#0000ff">="0,0,0,8"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">TextBox </span><span style="color:#ff0000">Text</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding CourseName, Mode=TwoWay}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">toolkit:DataField</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">toolkit:DataField </span><span style="color:#ff0000">Label</span><span style="color:#0000ff">="标题："</span><span style="color:#ff0000"> Margin</span><span style="color:#0000ff">="0,0,0,8"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">TextBox </span><span style="color:#ff0000">Text</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding Title, Mode=TwoWay}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">toolkit:DataField</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">toolkit:DataField </span><span style="color:#ff0000">Label</span><span style="color:#0000ff">="子标题："</span><span style="color:#ff0000"> Margin</span><span style="color:#0000ff">="0,0,0,8"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">TextBox </span><span style="color:#ff0000">Text</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding SubTitle, Mode=TwoWay}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">toolkit:DataField</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">toolkit:DataField </span><span style="color:#ff0000">Label</span><span style="color:#0000ff">="短标题："</span><span style="color:#ff0000"> Margin</span><span style="color:#0000ff">="0,0,0,8"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">TextBox </span><span style="color:#ff0000">Text</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding ShortTitle, Mode=TwoWay}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">toolkit:DataField</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">toolkit:DataField </span><span style="color:#ff0000">Label</span><span style="color:#0000ff">="主讲老师："</span><span style="color:#ff0000"> Margin</span><span style="color:#0000ff">="0,0,0,8"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">TextBox </span><span style="color:#ff0000">Text</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding Teachers, Mode=TwoWay}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">toolkit:DataField</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">toolkit:DataField </span><span style="color:#ff0000">Label</span><span style="color:#0000ff">="提供商："</span><span style="color:#ff0000"> Margin</span><span style="color:#0000ff">="0,0,0,8"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">TextBox </span><span style="color:#ff0000">Text</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding Provider, Mode=TwoWay}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">toolkit:DataField</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">toolkit:DataField </span><span style="color:#ff0000">Label</span><span style="color:#0000ff">="发布时间："</span><span style="color:#ff0000"> Margin</span><span style="color:#0000ff">="0,0,0,8"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">sdk:DatePicker </span><span style="color:#ff0000">SelectedDate</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding PublishDate, Mode=TwoWay}</span><span style="color:#0000ff">"</span><span style="color:#ff0000">  </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">toolkit:DataField</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">toolkit:DataField </span><span style="color:#ff0000">Label</span><span style="color:#0000ff">="概要："</span><span style="color:#ff0000"> Margin</span><span style="color:#0000ff">="0,0,0,8"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">TextBox </span><span style="color:#ff0000">Text</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding Summary, Mode=TwoWay}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> Height</span><span style="color:#0000ff">="120"</span><span style="color:#ff0000"> HorizontalScrollBarVisibility</span><span style="color:#0000ff">="Auto"</span><span style="color:#ff0000"> VerticalScrollBarVisibility</span><span style="color:#0000ff">="Auto"</span><span style="color:#ff0000"> AcceptsReturn</span><span style="color:#0000ff">="True"</span><span style="color:#ff0000"> </span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">toolkit:DataField</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">toolkit:DataField </span><span style="color:#ff0000">Label</span><span style="color:#0000ff">="图片："</span><span style="color:#ff0000"> Margin</span><span style="color:#0000ff">="0,0,0,8"</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">Vega_Controls:SelecteImage </span><span style="color:#ff0000">ImageUri</span><span style="color:#0000ff">="</span><span style="color:#808000">{Binding ThumbUrl, Mode=TwoWay}</span><span style="color:#0000ff">"</span><span style="color:#ff0000"> Margin</span><span style="color:#0000ff">="0"</span><span style="color:#ff0000"> d:LayoutOverrides</span><span style="color:#0000ff">="Width, Height"</span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>                        </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">toolkit:DataField</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                    </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">StackPanel</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">DataTemplate</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">toolkit:DataForm.Resources</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">toolkit:DataForm.EditTemplate</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>                </span><span style="color:#0000ff">&lt;</span><span style="color:#800000">StaticResource </span><span style="color:#ff0000">ResourceKey</span><span style="color:#0000ff">="EditDataTemplate"</span><span style="color:#0000ff">/&gt;</span><span style="color:#000000"><br>            </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">toolkit:DataForm.EditTemplate</span><span style="color:#0000ff">&gt;</span><span style="color:#000000"><br>        </span><span style="color:#0000ff">&lt;/</span><span style="color:#800000">toolkit:DataForm</span><span style="color:#0000ff">&gt;</span></div></pre>
</div>
<p> </p>
把SelectImage的ImageUrl属性和实体的属性绑定起来。</div>
<div><img src="http://pic002.cnblogs.com/img/subwayline13/201009/2010090116334610.png"></div>
<div>效果图。</div>
<div>最后加上事件，在完成编辑的时候提交更改就好了。</div>
<div>
<div>
<pre><div><span style="color:#000000">        </span><span style="color:#0000ff">private</span><span style="color:#000000"> </span><span style="color:#0000ff">void</span><span style="color:#000000"> dfCourse_EditEnded(</span><span style="color:#0000ff">object</span><span style="color:#000000"> sender, DataFormEditEndedEventArgs e)<br>        {<br>            </span><span style="color:#0000ff">if</span><span style="color:#000000"> (e.EditAction </span><span style="color:#000000">==</span><span style="color:#000000"> DataFormEditAction.Commit)<br>            {<br>                var course </span><span style="color:#000000">=</span><span style="color:#000000"> (Course)</span><span style="color:#0000ff">this</span><span style="color:#000000">.courseDataGrid.SelectedItem;<br>                </span><span style="color:#0000ff">if</span><span style="color:#000000"> (course.CourseID </span><span style="color:#000000">==</span><span style="color:#000000"> </span><span style="color:#800080">0</span><span style="color:#000000">)<br>                {<br>                    course.CreateTime </span><span style="color:#000000">=</span><span style="color:#000000"> DateTime.Now;<br>                }<br>                </span><span style="color:#0000ff">this</span><span style="color:#000000">.courseDomainDataSource.SubmitChanges();<br>            }<br>        }</span></div></pre>
</div>
<p> </p>
<div>最后最后，加上验证。</div>
<div>直接修改DomainService.matadata.cs</div>
<div>和ASP.NET MVC2集成的验证方式一样，使用Attribute的方式</div>
<div>
<div>
<pre><div><span style="color:#000000">            [Display(Name</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">课程名称</span><span style="color:#800000">"</span><span style="color:#000000">)]<br>            [Required(ErrorMessage</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">课程名称不能为空</span><span style="color:#800000">"</span><span style="color:#000000">)]<br>            </span><span style="color:#0000ff">public</span><span style="color:#000000"> </span><span style="color:#0000ff">string</span><span style="color:#000000"> CourseName { </span><span style="color:#0000ff">get</span><span style="color:#000000">; </span><span style="color:#0000ff">set</span><span style="color:#000000">; }</span></div></pre>
</div>
<p> </p>
</div>
<div>不过效果好多了</div>
<img src="http://pic002.cnblogs.com/img/subwayline13/201009/2010090116370157.png"></div>
</div>


<p><img src="http://www.cnblogs.com/subwayline13/aggbug/1813836.html?type=1" width="1" height="1" alt=""><p>评论: 5　<a href="http://www.cnblogs.com/subwayline13/archive/2010/09/01/1813836.html#pagedcomment">查看评论</a>　<a href="http://www.cnblogs.com/subwayline13/archive/2010/09/01/1813836.html#commentform">发表评论</a></p><p><a href="http://job.cnblogs.com/">程序员找工作，就在博客园</a></p><hr><p>最新新闻：<br>· <a href="http://news.cnblogs.com/n/72858/">Reality 2.0：现实增强技术的未来</a><span style="color:gray">(2010-09-02 15:00)</span><br>· <a href="http://news.cnblogs.com/n/72857/">电视产业——苹果们的新战场</a><span style="color:gray">(2010-09-02 14:55)</span><br>· <a href="http://news.cnblogs.com/n/72856/">网易CEO丁磊督战163邮箱iPad版上线</a><span style="color:gray">(2010-09-02 14:49)</span><br>· <a href="http://news.cnblogs.com/n/72854/">剖析IE浏览器子系统的性能权重</a><span style="color:gray">(2010-09-02 14:45)</span><br>· <a href="http://news.cnblogs.com/n/72852/">百度框的背后</a><span style="color:gray">(2010-09-02 14:13)</span><br></p><p>编辑推荐：<a href="http://news.cnblogs.com/n/72793/">发现腾讯的“阿喀琉斯之踵”</a><br></p><p>网站导航：<a href="http://www.cnblogs.com">博客园首页</a>  <a href="http://home.cnblogs.com/">个人主页</a>  <a href="http://news.cnblogs.com">新闻</a>  <a href="http://home.cnblogs.com/ing/">闪存</a>  <a href="http://home.cnblogs.com/group/">小组</a>  <a href="http://space.cnblogs.com/q/">博问</a>  <a href="http://space.cnblogs.com">社区</a>  <a href="http://kb.cnblogs.com">知识库</a></p></p>

</div>


            <div class="footer">
              <div class="contact">
                <p>
                  Your Name<br />
                  What You Are<br />
                  your@email.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/yourusername/">github.com/yourusername</a><br />
                  <a href="http://twitter.com/yourusername/">twitter.com/yourusername</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

    </body>
</html>
