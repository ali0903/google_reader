<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>asp.net mvc 2 简简单单做开发 自定义DropdownList控件</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/google_reader/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/google_reader/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/google_reader/">Google Reader</a></h1>
              <a class="extra" href="/google_reader/">home</a>
            </div>

                <h2>asp.net mvc 2 简简单单做开发 自定义DropdownList控件</h2>
<p class="meta">2010-07-03 16:37</p>

<div class="post">
<h2>asp.net mvc 2 简简单单做开发 自定义DropdownList控件</h2>

<h3>by 王继坤</h3>

<h3>at 2010-07-03 08:37:00</h3>

<h3>original <a href="http://www.cnblogs.com/wangjikun3/archive/2010/07/03/1770318.html">http://www.cnblogs.com/wangjikun3/archive/2010/07/03/1770318.html</a></h3>

<p>作者: <a href="http://www.cnblogs.com/wangjikun3/">王继坤</a> 发表于 2010-07-03 08:37 <a href="http://www.cnblogs.com/wangjikun3/archive/2010/07/03/1770318.html">原文链接</a> 阅读: 848 评论: 3</p>


<p>　　asp.net mvc 2 给我们提供了强大的自定义功能，今天主要说下DropdownList自定义绑定字段显示，通过ViewData设定DropdownList的数据项。自动绑定显示。实现的方式。在global.asax 中注册 FieldTemplateMetadataProvider，</p>


<p> <span style="color:#2b91af">ModelMetadataProviders</span>.Current = <span style="color:blue">new</span> mvc.Models.<span style="color:#2b91af">FieldTemplateMetadataProvider</span>();<br>通过返回的 FieldTemplateMetadata 。在MetaData中指定使用DropDownList的字段<br>       [<span style="color:#2b91af">Display</span>( Name=<span style="color:#a31515">""</span>,Order=12)]<br>        [<span style="color:#2b91af">Required</span>]<br>        [<span style="color:#2b91af">SearchFilter</span>]<br>        [<span style="color:#2b91af">DisplayName</span>(<span style="color:#a31515">"栏目"</span>)]<br>        [<span style="color:#2b91af">DropDownList</span>(<span style="color:#a31515">"Category"</span>, <span style="color:#a31515">"Id"</span>, <span style="color:#a31515">"Name"</span>)]<br>        <span style="color:blue">public</span> <span style="color:blue">int</span> Cid { <span style="color:blue">get</span>; <span style="color:blue">set</span>; }</p>


<p>通过<span style="color:#2b91af">DropDownList</span><span>指定调用的模板为dropdownlist.ascx ,在dropdownlist.ascx 将默认的 ModelMetadata 转成FieldTemplateMetadata 获取 DropDownListAttribute 。</span></p>


<pre style="font-family:consolas"><span style="color:blue">&lt;</span><span style="color:maroon">script</span> <span style="color:red">runat</span><span style="color:blue">=</span><span style="color:blue">"server"</span><span style="color:blue">&gt;</span><br>    <span style="color:#2b91af">DropDownListAttribute</span> GetDropDownListAttribute()<br>    {<br>        <span style="color:#2b91af">FieldTemplateMetadata</span> metaData = ViewData.ModelMetadata <span style="color:blue">as</span> <span style="color:#2b91af">FieldTemplateMetadata</span>;<br> <br>        <span style="color:blue">return</span> (metaData != <span style="color:blue">null</span>) ? metaData.Attributes.OfType&lt;<span style="color:#2b91af">DropDownListAttribute</span>&gt;().SingleOrDefault() : <span style="color:blue">null</span>;<br>    }<br><span style="color:blue">&lt;/</span><span style="color:maroon">script</span><span style="color:blue">&gt;</span></pre>


<pre style="font-family:consolas"><span style="color:blue"></span> <br>　　通过DropDownListAttribute 获得 ViewData的key ，绑定的文本对应的字段，值对应的字段，使用html.DropDownlist显示数据</pre>


<p>    DropdownList.ascx 代码<br></p>


<div><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif"><span>代码</span> 
<div>
<div><span style="color:#000000">&lt;%</span><span style="color:#000000">@ Import Namespace</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">mvc.Models</span><span style="color:#800000">"</span><span style="color:#000000">%&gt;</span><span style="color:#000000"><br></span><span style="color:#000000">&lt;%</span><span style="color:#000000">@ Control Language</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">C#</span><span style="color:#800000">"</span><span style="color:#000000"> Inherits</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">System.Web.Mvc.ViewUserControl</span><span style="color:#800000">"</span><span style="color:#000000"> </span><span style="color:#000000">%&gt;</span><span style="color:#000000"><br></span><span style="color:#000000">&lt;</span><span style="color:#000000">script runat</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">server</span><span style="color:#800000">"</span><span style="color:#000000">&gt;</span><span style="color:#000000"><br>    DropDownListAttribute GetDropDownListAttribute()<br>    {<br>        FieldTemplateMetadata metaData </span><span style="color:#000000">=</span><span style="color:#000000"> ViewData.ModelMetadata </span><span style="color:#0000ff">as</span><span style="color:#000000"> FieldTemplateMetadata;<br><br>        </span><span style="color:#0000ff">return</span><span style="color:#000000"> (metaData </span><span style="color:#000000">!=</span><span style="color:#000000"> </span><span style="color:#0000ff">null</span><span style="color:#000000">) </span><span style="color:#000000">?</span><span style="color:#000000"> metaData.Attributes.OfType</span><span style="color:#000000">&lt;</span><span style="color:#000000">DropDownListAttribute</span><span style="color:#000000">&gt;</span><span style="color:#000000">().SingleOrDefault() : </span><span style="color:#0000ff">null</span><span style="color:#000000">;<br>    }<br></span><span style="color:#000000">&lt;/</span><span style="color:#000000">script</span><span style="color:#000000">&gt;</span><span style="color:#000000"><br></span><span style="color:#000000">&lt;%</span><span style="color:#000000"> DropDownListAttribute attribute </span><span style="color:#000000">=</span><span style="color:#000000"> GetDropDownListAttribute();</span><span style="color:#000000">%&gt;</span><span style="color:#000000"><br></span><span style="color:#000000">&lt;%</span><span style="color:#000000"> </span><span style="color:#0000ff">if</span><span style="color:#000000"> (attribute </span><span style="color:#000000">!=</span><span style="color:#000000"> </span><span style="color:#0000ff">null</span><span style="color:#000000">) {</span><span style="color:#000000">%&gt;</span><span style="color:#000000"><br>    </span><span style="color:#000000">&lt;%=</span><span style="color:#000000"> Html.DropDownList(</span><span style="color:#0000ff">string</span><span style="color:#000000">.Empty, </span><span style="color:#0000ff">new</span><span style="color:#000000"> SelectList(ViewData[attribute.ViewDataKey] </span><span style="color:#0000ff">as</span><span style="color:#000000"> IEnumerable, attribute.DataValueField, attribute.DataTextField, Model), attribute.OptionLabel, attribute.HtmlAttributes) </span><span style="color:#000000">%&gt;</span><span style="color:#000000"><br></span><span style="color:#000000">&lt;%</span><span style="color:#000000"> }</span><span style="color:#000000">%&gt;</span><span style="color:#000000"><br></span><span style="color:#000000">&lt;%</span><span style="color:#000000"> </span><span style="color:#0000ff">else</span><span style="color:#000000"> {</span><span style="color:#000000">%&gt;</span><span style="color:#000000"><br>    </span><span style="color:#000000">&lt;%=</span><span style="color:#000000"> Html.DisplayForModel() </span><span style="color:#000000">%&gt;</span><span style="color:#000000"><br></span><span style="color:#000000">&lt;%</span><span style="color:#000000"> }</span><span style="color:#000000">%&gt;</span></div></div></div>


<p> </p>


<p>自定义DropDownListAttribute 属性</p>


<p> </p>


<div><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif"><span>代码</span> 
<div>
<div><span style="color:#0000ff">namespace</span><span style="color:#000000"> mvc.Models<br>{<br>    </span><span style="color:#0000ff">using</span><span style="color:#000000"> System;<br>    </span><span style="color:#0000ff">using</span><span style="color:#000000"> System.Collections.Generic;<br>    </span><span style="color:#0000ff">using</span><span style="color:#000000"> System.ComponentModel;<br>    </span><span style="color:#0000ff">using</span><span style="color:#000000"> System.ComponentModel.DataAnnotations;<br>    </span><span style="color:#0000ff">using</span><span style="color:#000000"> System.Linq;<br>    </span><span style="color:#0000ff">using</span><span style="color:#000000"> System.Web.Routing;<br><br>    [AttributeUsage(AttributeTargets.Property, AllowMultiple </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#0000ff">false</span><span style="color:#000000">, Inherited </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#0000ff">true</span><span style="color:#000000">)]<br>    </span><span style="color:#0000ff">public</span><span style="color:#000000"> </span><span style="color:#0000ff">sealed</span><span style="color:#000000"> </span><span style="color:#0000ff">class</span><span style="color:#000000"> DropDownListAttribute : Attribute, ITemplateField<br>    {<br>        </span><span style="color:#0000ff">private</span><span style="color:#000000"> </span><span style="color:#0000ff">static</span><span style="color:#000000"> </span><span style="color:#0000ff">string</span><span style="color:#000000"> defaultTemplateName;<br><br>        </span><span style="color:#0000ff">public</span><span style="color:#000000"> DropDownListAttribute(</span><span style="color:#0000ff">string</span><span style="color:#000000"> viewDataKey, </span><span style="color:#0000ff">string</span><span style="color:#000000"> dataValueField) : </span><span style="color:#0000ff">this</span><span style="color:#000000">(viewDataKey, dataValueField, </span><span style="color:#0000ff">null</span><span style="color:#000000">)<br>        {<br>        }<br><br>        </span><span style="color:#0000ff">public</span><span style="color:#000000"> DropDownListAttribute(</span><span style="color:#0000ff">string</span><span style="color:#000000"> viewDataKey, </span><span style="color:#0000ff">string</span><span style="color:#000000"> dataValueField, </span><span style="color:#0000ff">string</span><span style="color:#000000"> dataTextField) : </span><span style="color:#0000ff">this</span><span style="color:#000000">(viewDataKey, dataValueField, dataTextField, </span><span style="color:#0000ff">null</span><span style="color:#000000">)<br>        {<br>        }<br><br>        </span><span style="color:#0000ff">public</span><span style="color:#000000"> DropDownListAttribute(</span><span style="color:#0000ff">string</span><span style="color:#000000"> viewDataKey, </span><span style="color:#0000ff">string</span><span style="color:#000000"> dataValueField, </span><span style="color:#0000ff">string</span><span style="color:#000000"> dataTextField, </span><span style="color:#0000ff">string</span><span style="color:#000000"> optionLabel) : </span><span style="color:#0000ff">this</span><span style="color:#000000">(DefaultTemplateName, viewDataKey, dataValueField, dataTextField, optionLabel, </span><span style="color:#0000ff">null</span><span style="color:#000000">)<br>        {<br>        }<br><br>        </span><span style="color:#0000ff">public</span><span style="color:#000000"> DropDownListAttribute(</span><span style="color:#0000ff">string</span><span style="color:#000000"> viewDataKey, </span><span style="color:#0000ff">string</span><span style="color:#000000"> dataValueField, </span><span style="color:#0000ff">string</span><span style="color:#000000"> dataTextField, </span><span style="color:#0000ff">string</span><span style="color:#000000"> optionLabel, </span><span style="color:#0000ff">object</span><span style="color:#000000"> htmlAttributes) : </span><span style="color:#0000ff">this</span><span style="color:#000000">(DefaultTemplateName, viewDataKey, dataValueField, dataTextField, optionLabel, htmlAttributes)<br>        {<br>        }<br><br>        </span><span style="color:#0000ff">public</span><span style="color:#000000"> DropDownListAttribute(</span><span style="color:#0000ff">string</span><span style="color:#000000"> templateName, </span><span style="color:#0000ff">string</span><span style="color:#000000"> viewDataKey, </span><span style="color:#0000ff">string</span><span style="color:#000000"> dataValueField, </span><span style="color:#0000ff">string</span><span style="color:#000000"> dataTextField, </span><span style="color:#0000ff">string</span><span style="color:#000000"> optionLabel, </span><span style="color:#0000ff">object</span><span style="color:#000000"> htmlAttributes)<br>        {<br>            </span><span style="color:#0000ff">if</span><span style="color:#000000"> (</span><span style="color:#0000ff">string</span><span style="color:#000000">.IsNullOrEmpty(templateName))<br>            {<br>                </span><span style="color:#0000ff">throw</span><span style="color:#000000"> </span><span style="color:#0000ff">new</span><span style="color:#000000"> ArgumentException(</span><span style="color:#800000">"</span><span style="color:#800000">Template name cannot be empty.</span><span style="color:#800000">"</span><span style="color:#000000">);<br>            }<br><br>            </span><span style="color:#0000ff">if</span><span style="color:#000000"> (</span><span style="color:#0000ff">string</span><span style="color:#000000">.IsNullOrEmpty(viewDataKey))<br>            {<br>                </span><span style="color:#0000ff">throw</span><span style="color:#000000"> </span><span style="color:#0000ff">new</span><span style="color:#000000"> ArgumentException(</span><span style="color:#800000">"</span><span style="color:#800000">View data key cannot be empty.</span><span style="color:#800000">"</span><span style="color:#000000">);<br>            }<br><br>            </span><span style="color:#0000ff">if</span><span style="color:#000000"> (</span><span style="color:#0000ff">string</span><span style="color:#000000">.IsNullOrEmpty(dataValueField))<br>            {<br>                </span><span style="color:#0000ff">throw</span><span style="color:#000000"> </span><span style="color:#0000ff">new</span><span style="color:#000000"> ArgumentException(</span><span style="color:#800000">"</span><span style="color:#800000">Data value field cannot be empty.</span><span style="color:#800000">"</span><span style="color:#000000">);<br>            }<br><br>            TemplateName </span><span style="color:#000000">=</span><span style="color:#000000"> templateName;<br>            ViewDataKey </span><span style="color:#000000">=</span><span style="color:#000000"> viewDataKey;<br>            DataValueField </span><span style="color:#000000">=</span><span style="color:#000000"> dataValueField;<br>            DataTextField </span><span style="color:#000000">=</span><span style="color:#000000"> dataTextField;<br>            OptionLabel </span><span style="color:#000000">=</span><span style="color:#000000"> optionLabel;<br>            HtmlAttributes </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#0000ff">new</span><span style="color:#000000"> RouteValueDictionary(htmlAttributes);<br>        }<br><br>        </span><span style="color:#0000ff">public</span><span style="color:#000000"> </span><span style="color:#0000ff">static</span><span style="color:#000000"> </span><span style="color:#0000ff">string</span><span style="color:#000000"> DefaultTemplateName<br>        {<br>            </span><span style="color:#0000ff">get</span><span style="color:#000000"><br>            {<br>                </span><span style="color:#0000ff">if</span><span style="color:#000000"> (</span><span style="color:#0000ff">string</span><span style="color:#000000">.IsNullOrEmpty(defaultTemplateName))<br>                {<br>                    defaultTemplateName </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#800000">"</span><span style="color:#800000">DropDownList</span><span style="color:#800000">"</span><span style="color:#000000">;<br>                }<br><br>                </span><span style="color:#0000ff">return</span><span style="color:#000000"> defaultTemplateName;<br>            }<br>            </span><span style="color:#0000ff">set</span><span style="color:#000000"><br>            {<br>                defaultTemplateName </span><span style="color:#000000">=</span><span style="color:#000000"> value;<br>            }<br>        }<br><br>        </span><span style="color:#0000ff">public</span><span style="color:#000000"> </span><span style="color:#0000ff">string</span><span style="color:#000000"> TemplateName { </span><span style="color:#0000ff">get</span><span style="color:#000000">; </span><span style="color:#0000ff">private</span><span style="color:#000000"> </span><span style="color:#0000ff">set</span><span style="color:#000000">; }<br><br>        </span><span style="color:#0000ff">public</span><span style="color:#000000"> </span><span style="color:#0000ff">string</span><span style="color:#000000"> ViewDataKey { </span><span style="color:#0000ff">get</span><span style="color:#000000">; </span><span style="color:#0000ff">private</span><span style="color:#000000"> </span><span style="color:#0000ff">set</span><span style="color:#000000">; }<br><br>        </span><span style="color:#0000ff">public</span><span style="color:#000000"> </span><span style="color:#0000ff">string</span><span style="color:#000000"> DataValueField { </span><span style="color:#0000ff">get</span><span style="color:#000000">; </span><span style="color:#0000ff">private</span><span style="color:#000000"> </span><span style="color:#0000ff">set</span><span style="color:#000000">; }<br><br>        </span><span style="color:#0000ff">public</span><span style="color:#000000"> </span><span style="color:#0000ff">string</span><span style="color:#000000"> DataTextField { </span><span style="color:#0000ff">get</span><span style="color:#000000">; </span><span style="color:#0000ff">private</span><span style="color:#000000"> </span><span style="color:#0000ff">set</span><span style="color:#000000">; }<br><br>        </span><span style="color:#0000ff">public</span><span style="color:#000000"> </span><span style="color:#0000ff">string</span><span style="color:#000000"> OptionLabel { </span><span style="color:#0000ff">get</span><span style="color:#000000">; </span><span style="color:#0000ff">private</span><span style="color:#000000"> </span><span style="color:#0000ff">set</span><span style="color:#000000">; }<br><br>        </span><span style="color:#0000ff">public</span><span style="color:#000000"> IDictionary</span><span style="color:#000000">&lt;</span><span style="color:#0000ff">string</span><span style="color:#000000">, </span><span style="color:#0000ff">object</span><span style="color:#000000">&gt;</span><span style="color:#000000"> HtmlAttributes { </span><span style="color:#0000ff">get</span><span style="color:#000000">; </span><span style="color:#0000ff">private</span><span style="color:#000000"> </span><span style="color:#0000ff">set</span><span style="color:#000000">; }<br><br>        </span><span style="color:#0000ff">public</span><span style="color:#000000"> </span><span style="color:#0000ff">object</span><span style="color:#000000"> GetSelectedValue(</span><span style="color:#0000ff">object</span><span style="color:#000000"> model)<br>        {<br>            </span><span style="color:#0000ff">return</span><span style="color:#000000"> GetPropertyValue(model, DataValueField);<br>        }<br><br>        </span><span style="color:#0000ff">public</span><span style="color:#000000"> </span><span style="color:#0000ff">object</span><span style="color:#000000"> GetSelectedText(</span><span style="color:#0000ff">object</span><span style="color:#000000"> model)<br>        {<br>            </span><span style="color:#0000ff">return</span><span style="color:#000000"> GetPropertyValue(model, </span><span style="color:#000000">!</span><span style="color:#0000ff">string</span><span style="color:#000000">.IsNullOrEmpty(DataTextField) </span><span style="color:#000000">?</span><span style="color:#000000"> DataTextField : DataValueField);<br>        }<br><br>        </span><span style="color:#0000ff">private</span><span style="color:#000000"> </span><span style="color:#0000ff">static</span><span style="color:#000000"> </span><span style="color:#0000ff">object</span><span style="color:#000000"> GetPropertyValue(</span><span style="color:#0000ff">object</span><span style="color:#000000"> model, </span><span style="color:#0000ff">string</span><span style="color:#000000"> propertyName)<br>        {<br>            </span><span style="color:#0000ff">if</span><span style="color:#000000"> (model </span><span style="color:#000000">!=</span><span style="color:#000000"> </span><span style="color:#0000ff">null</span><span style="color:#000000">)<br>            {<br>                PropertyDescriptor property </span><span style="color:#000000">=</span><span style="color:#000000"> GetTypeDescriptor(model.GetType()).GetProperties()<br>                                                                                .Cast</span><span style="color:#000000">&lt;</span><span style="color:#000000">PropertyDescriptor</span><span style="color:#000000">&gt;</span><span style="color:#000000">()<br>                                                                                .SingleOrDefault(p </span><span style="color:#000000">=&gt;</span><span style="color:#000000"> </span><span style="color:#0000ff">string</span><span style="color:#000000">.Compare(p.Name, propertyName, StringComparison.OrdinalIgnoreCase) </span><span style="color:#000000">==</span><span style="color:#000000"> </span><span style="color:#800080">0</span><span style="color:#000000">);<br>               <br>                </span><span style="color:#0000ff">if</span><span style="color:#000000"> (property </span><span style="color:#000000">!=</span><span style="color:#000000"> </span><span style="color:#0000ff">null</span><span style="color:#000000">)<br>                {<br>                    </span><span style="color:#0000ff">return</span><span style="color:#000000"> property.GetValue(model);<br>                }<br>            }<br><br>            </span><span style="color:#0000ff">return</span><span style="color:#000000"> </span><span style="color:#0000ff">null</span><span style="color:#000000">;<br>        }<br><br>        </span><span style="color:#0000ff">private</span><span style="color:#000000"> </span><span style="color:#0000ff">static</span><span style="color:#000000"> ICustomTypeDescriptor GetTypeDescriptor(Type type)<br>        {<br>            </span><span style="color:#0000ff">return</span><span style="color:#000000"> </span><span style="color:#0000ff">new</span><span style="color:#000000"> AssociatedMetadataTypeTypeDescriptionProvider(type).GetTypeDescriptor(type);<br>        }<br>    }<br>}</span></div></div></div>


<p> </p>


<p>自定义DataAnnotationsModelMetadata</p>


<p> </p>


<div><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif"><span>代码</span> 
<div>
<div><span style="color:#0000ff">public</span><span style="color:#000000"> </span><span style="color:#0000ff">class</span><span style="color:#000000"> FieldTemplateMetadata : DataAnnotationsModelMetadata<br>    {<br>        </span><span style="color:#0000ff">public</span><span style="color:#000000"> FieldTemplateMetadata(DisplayAttribute aa, DataAnnotationsModelMetadataProvider provider, Type containerType, Func</span><span style="color:#000000">&lt;</span><span style="color:#0000ff">object</span><span style="color:#000000">&gt;</span><span style="color:#000000"> modelAccessor, Type modelType, </span><span style="color:#0000ff">string</span><span style="color:#000000"> propertyName, DisplayColumnAttribute displayColumnAttribute, IEnumerable</span><span style="color:#000000">&lt;</span><span style="color:#000000">Attribute</span><span style="color:#000000">&gt;</span><span style="color:#000000"> attributes) : </span><span style="color:#0000ff">base</span><span style="color:#000000">(provider, containerType, modelAccessor, modelType, propertyName, displayColumnAttribute)<br>        {<br>            Attributes </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#0000ff">new</span><span style="color:#000000"> List</span><span style="color:#000000">&lt;</span><span style="color:#000000">Attribute</span><span style="color:#000000">&gt;</span><span style="color:#000000">(attributes);<br>            Display </span><span style="color:#000000">=</span><span style="color:#000000"> aa;<br>        }<br><br>        </span><span style="color:#0000ff">public</span><span style="color:#000000"> IList</span><span style="color:#000000">&lt;</span><span style="color:#000000">Attribute</span><span style="color:#000000">&gt;</span><span style="color:#000000"> Attributes<br>        {<br>            </span><span style="color:#0000ff">get</span><span style="color:#000000">;<br>            </span><span style="color:#0000ff">private</span><span style="color:#000000"> </span><span style="color:#0000ff">set</span><span style="color:#000000">;<br>        }<br>        </span><span style="color:#0000ff">public</span><span style="color:#000000"> DisplayAttribute Display { </span><span style="color:#0000ff">get</span><span style="color:#000000">; </span><span style="color:#0000ff">set</span><span style="color:#000000">; }<br>    }</span></div></div></div>


<p> </p>


<p>自定义 DataAnnotationsModelMetadataProvider</p>


<p> </p>


<div><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif"><span>代码</span> 
<div>
<div><span style="color:#0000ff">public</span><span style="color:#000000"> </span><span style="color:#0000ff">class</span><span style="color:#000000"> FieldTemplateMetadataProvider : DataAnnotationsModelMetadataProvider<br>    {<br>        </span><span style="color:#0000ff">protected</span><span style="color:#000000"> </span><span style="color:#0000ff">override</span><span style="color:#000000"> ModelMetadata CreateMetadata(IEnumerable</span><span style="color:#000000">&lt;</span><span style="color:#000000">Attribute</span><span style="color:#000000">&gt;</span><span style="color:#000000"> attributes, Type containerType, Func</span><span style="color:#000000">&lt;</span><span style="color:#0000ff">object</span><span style="color:#000000">&gt;</span><span style="color:#000000"> modelAccessor, Type modelType, </span><span style="color:#0000ff">string</span><span style="color:#000000"> propertyName)<br>        {<br>            DataAnnotationsModelMetadata result </span><span style="color:#000000">=</span><span style="color:#000000"> (DataAnnotationsModelMetadata) </span><span style="color:#0000ff">base</span><span style="color:#000000">.CreateMetadata(attributes, containerType, modelAccessor, modelType, propertyName);<br><br>            </span><span style="color:#0000ff">string</span><span style="color:#000000"> templateName </span><span style="color:#000000">=</span><span style="color:#000000"> attributes.OfType</span><span style="color:#000000">&lt;</span><span style="color:#000000">ITemplateField</span><span style="color:#000000">&gt;</span><span style="color:#000000">()<br>                                            .Select(field </span><span style="color:#000000">=&gt;</span><span style="color:#000000"> field.TemplateName)<br>                                            .LastOrDefault();<br>            List</span><span style="color:#000000">&lt;</span><span style="color:#000000">System.Attribute</span><span style="color:#000000">&gt;</span><span style="color:#000000"> attributeList </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#0000ff">new</span><span style="color:#000000"> List</span><span style="color:#000000">&lt;</span><span style="color:#000000">System.Attribute</span><span style="color:#000000">&gt;</span><span style="color:#000000">(attributes);<br>            DisplayAttribute disp </span><span style="color:#000000">=</span><span style="color:#000000"> attributeList.OfType</span><span style="color:#000000">&lt;</span><span style="color:#000000">DisplayAttribute</span><span style="color:#000000">&gt;</span><span style="color:#000000">().FirstOrDefault();<br>            </span><span style="color:#0000ff">if</span><span style="color:#000000"> (disp </span><span style="color:#000000">!=</span><span style="color:#000000"> </span><span style="color:#0000ff">null</span><span style="color:#000000">)<br>            {<br>                result.ShortDisplayName </span><span style="color:#000000">=</span><span style="color:#000000"> disp.Order.ToString(); ;<br>                result.Description </span><span style="color:#000000">=</span><span style="color:#000000"> disp.Description;<br>            }<br><br>           <br><br>            var data</span><span style="color:#000000">=</span><span style="color:#000000"> (</span><span style="color:#0000ff">new</span><span style="color:#000000"> FieldTemplateMetadata(disp, </span><span style="color:#0000ff">this</span><span style="color:#000000">, containerType, modelAccessor, modelType, propertyName, attributes.OfType</span><span style="color:#000000">&lt;</span><span style="color:#000000">DisplayColumnAttribute</span><span style="color:#000000">&gt;</span><span style="color:#000000">().FirstOrDefault(), attributes)<br><br>                    {<br>                        TemplateHint </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#000000">!</span><span style="color:#0000ff">string</span><span style="color:#000000">.IsNullOrEmpty(templateName) </span><span style="color:#000000">?</span><span style="color:#000000"> templateName : result.TemplateHint,<br>                        HideSurroundingHtml </span><span style="color:#000000">=</span><span style="color:#000000"> result.HideSurroundingHtml,<br>                        DataTypeName </span><span style="color:#000000">=</span><span style="color:#000000"> result.DataTypeName,<br>                        IsReadOnly </span><span style="color:#000000">=</span><span style="color:#000000"> result.IsReadOnly,<br>                        NullDisplayText </span><span style="color:#000000">=</span><span style="color:#000000"> result.NullDisplayText,<br>                        DisplayFormatString </span><span style="color:#000000">=</span><span style="color:#000000"> result.DisplayFormatString,<br>                        ConvertEmptyStringToNull </span><span style="color:#000000">=</span><span style="color:#000000"> result.ConvertEmptyStringToNull,<br>                        EditFormatString </span><span style="color:#000000">=</span><span style="color:#000000"> result.EditFormatString,<br>                        ShowForDisplay </span><span style="color:#000000">=</span><span style="color:#000000"> result.ShowForDisplay,<br>                        ShowForEdit </span><span style="color:#000000">=</span><span style="color:#000000"> result.ShowForEdit,<br>                        DisplayName </span><span style="color:#000000">=</span><span style="color:#000000"> result.DisplayName,<br>                        Description </span><span style="color:#000000">=</span><span style="color:#000000"> result.Description,<br>                        ShortDisplayName </span><span style="color:#000000">=</span><span style="color:#000000"> result.ShortDisplayName,<br><br>                    });<br><br>            SearchFilterAttribute searchFilterAttribute </span><span style="color:#000000">=</span><span style="color:#000000"> attributes.OfType</span><span style="color:#000000">&lt;</span><span style="color:#000000">SearchFilterAttribute</span><span style="color:#000000">&gt;</span><span style="color:#000000">().FirstOrDefault();<br>            </span><span style="color:#0000ff">if</span><span style="color:#000000"> (searchFilterAttribute </span><span style="color:#000000">!=</span><span style="color:#000000"> </span><span style="color:#0000ff">null</span><span style="color:#000000">)<br>            {<br>                data.AdditionalValues.Add(</span><span style="color:#800000">"</span><span style="color:#800000">Search</span><span style="color:#800000">"</span><span style="color:#000000">, searchFilterAttribute);<br>            }<br><br>            OrderByAttribute orderByAttribute </span><span style="color:#000000">=</span><span style="color:#000000"> attributes.OfType</span><span style="color:#000000">&lt;</span><span style="color:#000000">OrderByAttribute</span><span style="color:#000000">&gt;</span><span style="color:#000000">().FirstOrDefault();<br>            </span><span style="color:#0000ff">if</span><span style="color:#000000"> (orderByAttribute </span><span style="color:#000000">!=</span><span style="color:#000000"> </span><span style="color:#0000ff">null</span><span style="color:#000000">)<br>            {<br>                data.AdditionalValues.Add(</span><span style="color:#800000">"</span><span style="color:#800000">OrderBy</span><span style="color:#800000">"</span><span style="color:#000000">, orderByAttribute);<br>            }<br>            </span><span style="color:#0000ff">return</span><span style="color:#000000"> data;<br>        }<br>    }<br></span></div></div></div>


<p> </p>


<p> </p>


<p><img src="http://www.cnblogs.com/wangjikun3/aggbug/1770318.html?type=1" width="1" height="1" alt=""><p>评论: 3　<a href="http://www.cnblogs.com/wangjikun3/archive/2010/07/03/1770318.html#pagedcomment">查看评论</a>　<a href="http://www.cnblogs.com/wangjikun3/archive/2010/07/03/1770318.html#commentform">发表评论</a></p><p><a href="http://mpd.cnblogs.com/">软件研发团队管理年会(上海，7.10-7.11)</a></p><hr><p>最新新闻：<br>· <a href="http://news.cnblogs.com/n/67519/">苹果雷人解释：公式差错致iPhone信号失常</a><span style="color:gray">(2010-07-03 18:55)</span><br>· <a href="http://news.cnblogs.com/n/67518/">网易回应黑客攻击事件：员工电脑被入侵所致</a><span style="color:gray">(2010-07-03 18:52)</span><br>· <a href="http://news.cnblogs.com/n/67517/">网易四大邮箱集体遭入侵 黑客留言称只是玩笑</a><span style="color:gray">(2010-07-03 16:19)</span><br>· <a href="http://news.cnblogs.com/n/67516/">微软KIN手机的生与死：高层勾心斗角</a><span style="color:gray">(2010-07-03 16:07)</span><br>· <a href="http://news.cnblogs.com/n/67512/">腾讯投资韩国7家网游公司</a><span style="color:gray">(2010-07-03 15:15)</span><br></p><p>编辑推荐：<a href="http://www.cnblogs.com/sumtec/archive/2010/07/02/1768490.html">老调重弹——如何面试（一）</a><br></p><p>网站导航：<a href="http://www.cnblogs.com">博客园首页</a>  <a href="http://home.cnblogs.com/">个人主页</a>  <a href="http://news.cnblogs.com">新闻</a>  <a href="http://home.cnblogs.com/ing/">闪存</a>  <a href="http://home.cnblogs.com/group/">小组</a>  <a href="http://space.cnblogs.com/q/">博问</a>  <a href="http://space.cnblogs.com">社区</a>  <a href="http://kb.cnblogs.com">知识库</a></p></p>

</div>


            <div class="footer">
              <div class="contact">
                <p>
                  Your Name<br />
                  What You Are<br />
                  your@email.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/lyuehh/">github.com/lyuehh</a><br />
                  <a href="http://twitter.com/lyuehh/">twitter.com/lyuehh</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

    </body>
</html>
