<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>MongoDB与内存</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/">Your New Jekyll Site</a></h1>
              <a class="extra" href="/">home</a>
            </div>

                <h2>MongoDB与内存</h2>
<p class="meta">20 Aug 2011</p>

<div class="post">
<h2>MongoDB与内存</h2>

<h3>by nosqlfan</h3>

<h3>at 2011-08-19 17:07:28</h3>

<h3>original <a href="http://item.feedsky.com/~feedsky/nosqlfan/~8149226/548090381/6253001/1/item.html">http://item.feedsky.com/~feedsky/nosqlfan/~8149226/548090381/6253001/1/item.html</a></h3>

<p>本文转载自火丁笔记，文章对Linux的<span><a href="http://blog.nosqlfan.com/tags/%e8%99%9a%e6%8b%9f%e5%86%85%e5%ad%98" title="查看 虚拟内存 的全部文章">虚拟内存</a></span>管理机制做了简单介绍，对<span><a href="http://blog.nosqlfan.com/tags/mongodb" title="查看 MongoDB 的全部文章">MongoDB</a></span>的MMAP的<span><a href="http://blog.nosqlfan.com/tags/%e5%86%85%e5%ad%98" title="查看 内存 的全部文章">内存</a></span>映射机制做了描述，后面也说到了一些MongoDB内存使用上的监控和优化。是一篇MongoDB内存使用机制描述很清楚的文章。</p>


<p>原文链接：<a href="http://huoding.com/2011/08/19/107">huoding.com</a></p>


<blockquote><p>但凡初次接触MongoDB的人，无不惊讶于它对内存的贪得无厌，至于个中缘由，我先讲讲Linux是如何管理内存的，再说说MongoDB是如何使用内存的，答案自然就清楚了。</p>
<p>据说带着问题学习更有效，那就先看一个MongoDB服务器的top命令结果：</p>
<pre>shell&gt; top -p $(pidof mongod)
Mem:  32872124k total, 30065320k used,  2806804k free,   245020k buffers
Swap:  2097144k total,      100k used,  2097044k free, 26482048k cached

 VIRT  RES  SHR %MEM
1892g  21g  21g 69.6</pre>
<p>这台MongoDB服务器有没有性能问题？大家可以一边思考一边继续阅读。</p>
<h3>先讲讲Linux是如何管理内存的</h3>
<p>在Linux里（别的系统也差不多），内存有物理内存和<a href="http://en.wikipedia.org/wiki/Virtual_memory">虚拟内存</a>之说，物理内存是什么自然无需解释，虚拟内存实际是物理内存的抽象，多数情况下，出于方便性的考虑，程序访问的都是虚拟内存地址，然后操作系统会把它翻译成物理内存地址。</p>
<p>很多人会把虚拟内存和Swap混为一谈，实际上Swap只是虚拟内存引申出的一种技术而已：操作系统一旦物理内存不足，为了腾出内存空间存放新内容，就会把当前物理内存中的内容放到交换分区里，稍后用到的时候再取回来，需要注意的是，Swap的使用可能会带来性能问题，偶尔为之无需紧张，糟糕的是物理内存和交换分区频繁的发生数据交换，这被称之为Swap颠簸，一旦发生这种情况，先要明确是什么原因造成的，如果是内存不足就好办了，加内存就可以解决，不过有的时候即使内存充足也可能会出现这种问题，比如MySQL就有可能出现这样的情况，解决方法是限制使用Swap：</p>
<pre>shell&gt; sysctl -w vm.swappiness=0</pre>
<p>查看内存情况最常用的是free命令：</p>
<pre>shell&gt; free -m
             total       used       free     shared    buffers     cached
Mem:         32101      29377       2723          0        239      25880
-/+ buffers/cache:       3258      28842
Swap:         2047          0       2047</pre>
<p>新手看到used一栏数值偏大，free一栏数值偏小，往往会认为内存要用光了。其实并非如此，之所以这样是因为每当我们操作文件的时候，Linux都会尽可能的把文件缓存到内存里，这样下次访问的时候，就可以直接从内存中取结果，所以cached一栏的数值非常的大，不过不用担心，这部分内存是可回收的，操作系统会按照<a href="http://en.wikipedia.org/wiki/Cache_algorithms">LRU</a>算法淘汰冷数据。除了cached，还有一个buffers，它和cached类似，也是可回收的，不过它的侧重点在于缓解不同设备的操作速度不一致造成的阻塞，这里就不多做解释了。</p>
<p>知道了原理，我们就可以推算出系统可用的内存是free + buffers + cached：</p>
<pre>shell&gt; echo &quot;2723 + 239 + 25880&quot; | bc -l
28842</pre>
<p>至于系统实际使用的内存是used – buffers – cached：</p>
<pre>shell&gt; echo &quot;29377 - 239 - 25880&quot; | bc -l
3258</pre>
<p>除了free命令，还可以使用sar命令：</p>
<pre>shell&gt; sar -r
kbmemfree kbmemused  %memused kbbuffers  kbcached
  3224392  29647732     90.19    246116  26070160
  3116324  29755800     90.52    245992  26157372
  2959520  29912604     91.00    245556  26316396
  2792248  30079876     91.51    245680  26485672
  2718260  30153864     91.73    245684  26563540

shell&gt; sar -W
pswpin/s pswpout/s
    0.00      0.00
    0.00      0.00
    0.00      0.00
    0.00      0.00
    0.00      0.00</pre>
<p>希望你没有被%memused吓到，如果不幸言中，请参考free命令的解释。</p>
<h3>再说说MongoDB是如何使用内存的</h3>
<p>目前，MongoDB使用的是<a href="http://www.mongodb.org/display/DOCS/Caching">内存映射存储引擎</a>，它会把磁盘IO操作转换成内存操作，如果是读操作，内存中的数据起到缓存的作用，如果是写操作，内存还可以把随机的写操作转换成顺序的写操作，总之可以大幅度提升性能。MongoDB并不干涉内存管理工作，而是把这些工作留给操作系统的虚拟缓存管理器去处理，这样的好处是简化了MongoDB的工作，但坏处是你没有方法很方便的控制MongoDB占多大内存，事实上MongoDB会占用所有能用的内存，所以最好不要把别的服务和MongoDB放一起。</p>
<p>有时候，即便MongoDB使用的是64位操作系统，也可能会遭遇臭名昭著的<a href="http://en.wikipedia.org/wiki/Out_of_memory">OOM</a>问题，出现这种情况，多半是因为限制了虚拟内存的大小所致，可以这样查看当前值：</p>
<pre>shell&gt; ulimit -a | grep &#39;virtual&#39;</pre>
<p>多数操作系统缺省都是把它设置成unlimited的，如果你的操作系统不是，可以这样修改：</p>
<pre>shell&gt; ulimit -v unlimited</pre>
<p>不过要注意的是，ulimit的使用是有上下文的，最好放在MongoDB的启动脚本里。</p>
<p>有时候，出于某些原因，你可能想释放掉MongoDB占用的内存，不过前面说了，内存管理工作是由虚拟内存管理器控制的，所以通常你只能通过重启服务来释放内存，你一定不齿于这样的方法，幸好可以使用MongoDB内置的<a href="http://www.mongodb.org/display/DOCS/List+of+Database+Commands">closeAllDatabases</a>命令达到目的：</p>
<pre>mongo&gt; use admin
mongo&gt; db.runCommand({closeAllDatabases:1})</pre>
<p>另外，通过调整内核参数<a href="http://www.kernel.org/doc/Documentation/sysctl/vm.txt">drop_caches</a>也可以释放缓存：</p>
<pre>shell&gt; sysctl -w vm.drop_caches=1</pre>
<p>平时可以通过mongo命令行来监控MongoDB的内存使用情况，如下所示：</p>
<pre>mongo&gt; db.serverStatus().mem:
{
    &quot;resident&quot; : 22346,
    &quot;virtual&quot; : 1938524,
    &quot;mapped&quot; : 962283
}</pre>
<p>还可以通过<a href="http://www.mongodb.org/display/DOCS/mongostat">mongostat</a>命令来监控MongoDB的内存使用情况，如下所示：</p>
<pre>shell&gt; mongostat
mapped  vsize    res faults
  940g  1893g  21.9g      0
  940g  1893g  21.9g      0
  940g  1893g  21.9g      0
  940g  1893g  21.9g      0
  940g  1893g  21.9g      0</pre>
<p>其中内存相关字段的含义是：</p>
<ul>
<li>mapped：映射到内存的数据大小</li>
<li>visze：占用的虚拟内存大小</li>
<li>res：实际使用的内存大小</li>
</ul>
<p>注：如果操作不能再内存中完成，结果faults列的数值不会是0，视大小可能有性能问题。</p>
<p>在上面的结果中，vsize是mapped的两倍，而mapped等于数据文件的大小，所以说vsize是数据文件的两倍，之所以会这样，是因为本例中，MongoDB开启了<a href="http://www.mongodb.org/display/DOCS/Journaling">journal</a>，需要在内存里多映射一次数据文件，如果关闭journal，则vsize和mapped大致相当。</p>
<p>如果想验证这一点，可以在开启或关闭journal后，通过pmap命令来观察文件映射情况：</p>
<pre>shell&gt; pmap $(pidof mongod)</pre>
<p>到底MongoDB配备多大内存合适？宽泛点来说，多多益善，如果要确切点来说，这实际取决于你的数据及索引的大小，内存如果能够装下全部数据加索引是最佳情况，不过很多时候，数据都会比内存大，比如本文说涉及的MongoDB实例：</p>
<pre>mongo&gt; db.stats()
{
        &quot;dataSize&quot; : 1004862191980,
        &quot;indexSize&quot; : 1335929664
}</pre>
<p>本例中索引只有1G多，内存完全能装下，而数据文件则达到了1T，估计很难找到这么大内存，此时保证内存能装下热数据即可，至于热数据有多少，这就是个比例问题了，取决于具体的应用。如此一来内存大小就明确了：内存 &gt; 索引 + 热数据。</p>
<p>关于MongoDB与内存的话题，大家还可以参考<a href="http://www.mongodb.org/display/DOCS/Checking+Server+Memory+Usage">官方文档</a>中的相关介绍。</p></blockquote>


<table cellspacing="0" cellpadding="3" border="0" style="clear:both">
    
    <tr>
        <td colspan="5"><b><font size="-1" style="display:block!important;padding:20px 0 5px!important">相关文章：</font></b></td>
    </tr>
    
        <tr>
                <td width="106" valign="top" style="padding:5px!important;margin:0!important">
                    <a title="MongoDB安全性初探" style="text-decoration:none!important" href="http://app.wumii.com/ext/redirect.htm?url=http%3A%2F%2Fblog.nosqlfan.com%2Fhtml%2F2860.html&amp;from=http%3A%2F%2Fblog.nosqlfan.com%2Fhtml%2F2865.html">
                        <img style="margin:0!important;padding:2px!important;border:1px solid #dddddd!important;width:100px!important;height:100px!important" src="http://static.wumii.com/site_images/2011/08/19/23449047.png" width="100px" height="100px"><br>
                        <font size="-1" color="#333333" style="display:block!important;line-height:15px!important;width:106px!important;font:12px/15px arial!important;height:60px!important;margin:3px 0 0 0!important;padding:0!important;overflow:hidden!important">MongoDB安全性初探</font>
                    </a>
                </td>
                <td width="106" valign="top" style="padding:5px!important;margin:0!important;border-left:1px solid #dddddd!important">
                    <a title="Mongoid：一个MongoDB的Ruby ODM封装" style="text-decoration:none!important" href="http://app.wumii.com/ext/redirect.htm?url=http%3A%2F%2Fblog.nosqlfan.com%2Fhtml%2F2806.html&amp;from=http%3A%2F%2Fblog.nosqlfan.com%2Fhtml%2F2865.html">
                        <img style="margin:0!important;padding:2px!important;border:1px solid #dddddd!important;width:100px!important;height:100px!important" src="http://static.wumii.com/site_images/2011/08/14/22799490.png" width="100px" height="100px"><br>
                        <font size="-1" color="#333333" style="display:block!important;line-height:15px!important;width:106px!important;font:12px/15px arial!important;height:60px!important;margin:3px 0 0 0!important;padding:0!important;overflow:hidden!important">Mongoid：一个MongoDB的Ruby ODM封装</font>
                    </a>
                </td>
                <td width="106" valign="top" style="padding:5px!important;margin:0!important;border-left:1px solid #dddddd!important">
                    <a title="记一次MongoDB性能问题，附原理解析" style="text-decoration:none!important" href="http://app.wumii.com/ext/redirect.htm?url=http%3A%2F%2Fblog.nosqlfan.com%2Fhtml%2F2772.html&amp;from=http%3A%2F%2Fblog.nosqlfan.com%2Fhtml%2F2865.html">
                        <img style="margin:0!important;padding:2px!important;border:1px solid #dddddd!important;width:100px!important;height:100px!important" src="http://static.wumii.com/site_images/2011/08/10/21984991.png" width="100px" height="100px"><br>
                        <font size="-1" color="#333333" style="display:block!important;line-height:15px!important;width:106px!important;font:12px/15px arial!important;height:60px!important;margin:3px 0 0 0!important;padding:0!important;overflow:hidden!important">记一次MongoDB性能问题，附原理解析</font>
                    </a>
                </td>
                <td width="106" valign="top" style="padding:5px!important;margin:0!important;border-left:1px solid #dddddd!important">
                    <a title="MongoDB 1.4.3 发布" style="text-decoration:none!important" href="http://app.wumii.com/ext/redirect.htm?url=http%3A%2F%2Fblog.nosqlfan.com%2Fhtml%2F231.html&amp;from=http%3A%2F%2Fblog.nosqlfan.com%2Fhtml%2F2865.html">
                        <img style="margin:0!important;padding:2px!important;border:1px solid #dddddd!important;width:100px!important;height:100px!important" src="http://pic.yupoo.com/iammutex/B8sPBDdj/square.jpg" width="100px" height="100px"><br>
                        <font size="-1" color="#333333" style="display:block!important;line-height:15px!important;width:106px!important;font:12px/15px arial!important;height:60px!important;margin:3px 0 0 0!important;padding:0!important;overflow:hidden!important">MongoDB 1.4.3 发布</font>
                    </a>
                </td>
                <td width="106" valign="top" style="padding:5px!important;margin:0!important;border-left:1px solid #dddddd!important">
                    <a title="MongoDB paddingFactor的含义" style="text-decoration:none!important" href="http://app.wumii.com/ext/redirect.htm?url=http%3A%2F%2Fblog.nosqlfan.com%2Fhtml%2F2654.html&amp;from=http%3A%2F%2Fblog.nosqlfan.com%2Fhtml%2F2865.html">
                        <img style="margin:0!important;padding:2px!important;border:1px solid #dddddd!important;width:100px!important;height:100px!important" src="http://pic.yupoo.com/iammutex/B8sPBDdj/square.jpg" width="100px" height="100px"><br>
                        <font size="-1" color="#333333" style="display:block!important;line-height:15px!important;width:106px!important;font:12px/15px arial!important;height:60px!important;margin:3px 0 0 0!important;padding:0!important;overflow:hidden!important">MongoDB paddingFactor的含义</font>
                    </a>
                </td>
        </tr>
    
    <tr>
        <td colspan="5" align="right">
            <a style="text-decoration:none!important" href="http://www.wumii.com/widget/relatedItems.htm" title="无觅相关文章插件">
                <font size="-1" color="#bbbbbb" style="display:block!important;font-family:arial!important;padding:5px 0!important;font-size:12px!important;color:#bbb!important">无觅</font>
            </a>
        </td>
    </tr>
</table>


<p><img src="http://www1.feedsky.com/t1/548090381/nosqlfan/feedsky/s.gif?r=http://item.feedsky.com/~feedsky/nosqlfan/~8149226/548090381/6253001/1/item.html" border="0" height="0" width="0"></p>

</div>


            <div class="footer">
              <div class="contact">
                <p>
                  Your Name<br />
                  What You Are<br />
                  your@email.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/yourusername/">github.com/yourusername</a><br />
                  <a href="http://twitter.com/yourusername/">twitter.com/yourusername</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

    </body>
</html>
