<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Perl与Ruby解析Properties文件之异同</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/">Your New Jekyll Site</a></h1>
              <a class="extra" href="/">home</a>
            </div>

                <h2>Perl与Ruby解析Properties文件之异同</h2>
<p class="meta">14 Jun 2011</p>

<div class="post">
<h2>Perl与Ruby解析Properties文件之异同</h2>

<h3>by liujun.1980</h3>

<h3>at 2011-06-14 15:38:34</h3>

<h3>original <a href="http://liumaodou.iteye.com/blog/1087844">http://liumaodou.iteye.com/blog/1087844</a></h3>

<p>Perl解释Properties不太方便，需要自己分析
<br><pre name="code"></p>

<h1>!/usr/bin/perl -w</h1>

<p>package ncs::Properties;</p>

<p>use vars qw(@ISA @EXPORT @EXPORT_OK);
use Exporter;
@ISA = qw(Exporter);
@EXPORT = qw(load get set merge merge_with_file);</p>

<p>use ncs::Common;</p>

<p>sub new
{
    my $this = {};
    $this-&gt;{&#39;properties_file&#39;} = &#39;ncs_default.properties&#39;;
    $this-&gt;{&#39;properties&#39;} = {};
    bless $this;
    return $this;
}</p>

<p>sub load
{
    my ($class, $properties_file, $keep_escape) = @_;
    if (!defined($properties_file) || $properties_file eq &quot;&quot;){
        $properties_file = &quot;ncs.properties&quot;;
    }
    $class-&gt;{&#39;properties_file&#39;} = $properties_file;
    my $k = $v = &quot;&quot;;
    my $is_multiline = 0;
    open(PROPFILE, &quot;&lt;$properties_file&quot;) || die(&quot;Cannot open properties file $properties_file&quot;);
    while($line = &lt;PROPFILE&gt;){
        $line = trim($line);
        #space line or commentted line will be ignored
        if($line =~ /^$/ || $line =~ /^#/){
            next;<br/>
        }
        if($line =~ /\$/){ #end with \
            $line =~ s/\$//;
            if($is_multiline){ #not first line,not end line
                $v = $v.&#39; &#39;.$line;
            }
            else{ #first line
                ($k,$v) = split(&quot;=&quot;, $line, 2);
                $is_multiline = 1;
            }
            next;
        }
        if($is_multiline){
            #print &quot;is multiline: $is_multiline\n&quot;;
            #print &quot;$line\n&quot;;
            $v = $v.&#39; &#39;.$line;
            if($line =~ /[^\]$/){ #end line
                $class-&gt;{&#39;properties&#39;}-&gt;{trim($k)} = trim($v);
                #print &quot;$k=$v\n&quot;;
                $k = $v = &quot;&quot;;
                $is_multiline = 0;
            }
            next;
        }
        ($k,$v) = split(&quot;=&quot;, $line, 2);
        if(trim($k) eq &quot;&quot;){
            next;
        }
        #print(&quot;$k=$v&quot;);
        $class-&gt;{&#39;properties&#39;}-&gt;{trim($k)} = trim($v);
        $k = $v = &quot;&quot;;
    }
    close(PROPFILE);
    my $import = $class-&gt;get(&quot;ncs.import&quot;);
    $import = $class-&gt;unescapeProperty(&quot;ncs.import&quot;, $import) if $import;
    if(-e $import){
        print(&quot;found import properties: $import\n&quot;);
        $class-&gt;merge_with_file($import);
    }
    $class-&gt;unescapeProperties() if !$keep_escape;
    return $class-&gt;{&#39;properties&#39;};
}</p>

<p>sub unescapeProperty
{
    my ($class, $k, $v) = @_;
    if(!defined($v) || $v =~ /^\s*$/){
        return;
    }</p>

<pre><code>while($v =~ /^(.*)\${([^}]+)}(.*)$/){ #match ${ncs.log.dir}
    my $prefix = (defined($1) ? $1 : &amp;quot;&amp;quot;);
    my $matched = $2;
    my $suffix = (defined($3) ? $3 : &amp;quot;&amp;quot;);
    #print(&amp;quot;matched key: $matched\n&amp;quot;);
    if(!exists($class-&amp;gt;{&amp;#39;properties&amp;#39;}-&amp;gt;{$matched})){
        warn(&amp;quot;[warn] matched key not exists: $matched&amp;quot;);
        last;
    }
    #matched key exits
    #print(&amp;quot;$matched=&amp;quot;.$class-&amp;gt;{&amp;#39;properties&amp;#39;}-&amp;gt;{$matched}.&amp;quot;\n&amp;quot;);
    $class-&amp;gt;{&amp;#39;properties&amp;#39;}-&amp;gt;{$k} = $prefix.$class-&amp;gt;{&amp;#39;properties&amp;#39;}-&amp;gt;{$matched}.$suffix;
    $v = $class-&amp;gt;{&amp;#39;properties&amp;#39;}-&amp;gt;{$k};
}

while($v =~ /^(.*)(\$ENV{[^}]+})(.*)$/){ #match $ENV{HOME}
    my $prefix = (defined($1) ? $1 : &amp;quot;&amp;quot;);
    my $matched = $2;
    my $suffix = (defined($3) ? $3 : &amp;quot;&amp;quot;);
    #print(&amp;quot;matched env: $matched\n&amp;quot;);
    $matched = eval($matched) || &amp;#39;&amp;#39;;
    #print(&amp;quot;matched env value:&amp;quot;.$matched.&amp;quot;\n&amp;quot;);
    $matched = (defined($matched) ? $matched : &amp;quot;&amp;quot;);
    $class-&amp;gt;{&amp;#39;properties&amp;#39;}{$k} = $prefix.$matched.$suffix;
    $v = $class-&amp;gt;{&amp;#39;properties&amp;#39;}-&amp;gt;{$k};
}
#print(&amp;quot;$k=$class-&amp;gt;{&amp;#39;properties&amp;#39;}-&amp;gt;{$k}\n&amp;quot;);
return $v;
</code></pre>

<p>}</p>

<p>sub unescapeProperties
{
    my $class = shift @_;
    my $props = $class-&gt;{&#39;properties&#39;};
    #print &quot;list properties before unescape start\n&quot;;
    while( local ($k,$v) = each(%$props)){
        #print(&quot;$k=$v\n&quot;);
        $class-&gt;unescapeProperty($k, $v);
    }
    #print &quot;list properties before unescape end\n&quot;;
}</p>

<p>sub get
{
    my ($class,$key,$default) = @_;
    if(exists($class-&gt;{&#39;properties&#39;}-&gt;{$key})){
        return $class-&gt;{&#39;properties&#39;}-&gt;{$key};
    }
    if(defined($default)){ #not exists $props{$key}
        return $default;
    }
    return &quot;&quot;; #no default
}</p>

<p>sub set
{
    my ($class, $key, $value) = @_;
    $class-&gt;{&#39;properties&#39;}-&gt;{$key} = $value;
}</p>

<p>sub merge
{
    my ($class, $props_to_be_merged, $override) = @_;
    my $props = $class-&gt;{&#39;properties&#39;};
    while(local ($k,$v) = each(%$props_to_be_merged)){
        $k = trim($k);
        if($k eq &quot;&quot;){ next; }
        if(exists($props-&gt;{$k})){ next if(!$override); }
        $props-&gt;{$k} = trim($v);
    }
    return $props;
}</p>

<p>sub merge_with_file
{
    my ($class, $file_to_be_merged, $override) = @_;
    if(-e $file_to_be_merged){
        return $class-&gt;merge(ncs::Properties-&gt;new()-&gt;load($file_to_be_merged, 1), $override);
    }
    return $class-&gt;{&#39;properties&#39;};
}</p>

<p></pre>
<br>Ruby也没有提供现成的库，自己写了一个，可以看出，ruby跟perl是何等的相似，尤其是正则表达式的应用这块，难怪网络上都说ruby是perl6，确实不假。
<br><pre name="code"></p>

<h1>!/usr/bin/ruby -w</h1>

<p>class Properties
    def initialize
        @properties = {}
    end</p>

<pre><code>def load(properties_file, escape=true)
    raise &amp;quot;#{properties_file} not exists!&amp;quot; if not File.exists?(properties_file)
    @properties_file = properties_file
    k = v = &amp;quot;&amp;quot;
    is_multiline = false
    IO::foreach(@properties_file) {|line|
        line = line.strip
        #skip blank-space line or comments 
        next if line =~/^\s*$/ or line =~/^\s*#/
        #puts &amp;quot;line: #{line}&amp;quot;
        #end with \
        if line =~ /\\$/
            #puts &amp;quot;line end with \\: #{line}&amp;quot;
            line.chomp!().chop!()
            if is_multiline #not first line,not end line
                v = v + &amp;#39; &amp;#39; + line
            else #first line
                k,v=line.split(/=/, 2)
                is_multiline = true
            end
            next;
        end
        if is_multiline
            #puts &amp;quot;line is one of multiline: #{is_multiline}&amp;quot;
            v = v+&amp;#39; &amp;#39;+line
            if line =~ /[^\\]$/ #end line
                @properties.store(k.strip, v.strip)
                #puts &amp;quot;#{k}=#{v}&amp;quot;
                k = v = &amp;quot;&amp;quot;
                is_multiline = false
            end
            next;
        end
        k,v=line.split(/=/, 2)
        next if(k.strip.empty?)
        #puts &amp;quot;#{k}=#{v}&amp;quot;
        @properties.store(k.strip, v.strip)
        k = v = &amp;quot;&amp;quot;
    }
    self.import_files()
    self._escapeprops() if escape
    return self
end

def _escapeprops
    @properties.each do |key,val|
        self._escapeprop(key,val)
    end
end
def _escapeenv(env)
    env = env.delete(&amp;#39;$&amp;#39;).sub(&amp;#39;{&amp;#39;,&amp;#39;[&amp;quot;&amp;#39;).sub(&amp;#39;}&amp;#39;,&amp;#39;&amp;quot;]&amp;#39;)
    #puts &amp;quot;env: #{matched}&amp;quot;
    (eval(env) or &amp;quot;&amp;quot;)
end
def _escapeprop(key,val)
    return if val =~ /^\s*$/ #ignore empty value
    while val =~ /^(.*)\$\{([^}]+)\}(.*)$/ #match ${ncs.log.dir}
        prefix = $1 or &amp;quot;&amp;quot;; matched = $2; suffix = $3 or &amp;quot;&amp;quot;
        #puts &amp;quot;matched key: #{matched}&amp;quot;
        if not @properties.key?(matched)
            puts &amp;quot;matched key not exists: #{matched}&amp;quot;
            break
        end
        #matched key exits
        #puts &amp;quot;#{matched}=&amp;quot;+ @properties.fetch(matched)
        @properties.store(key, prefix+@properties.fetch(matched)+suffix)
        val = @properties.fetch(key)
    end

    while(val =~ /^(.*)(\$ENV\{[^}]+\})(.*)$/) #match $ENV{HOME}
        prefix = $1 or &amp;quot;&amp;quot;; matched = $2; suffix = $3 or &amp;quot;&amp;quot;
        matched = self._escapeenv(matched)
        #puts &amp;quot;matched env value:#{matched}&amp;quot;
        #puts &amp;quot;prefix=#{prefix}, matched=#{matched}, suffix=#{suffix}&amp;quot;
        @properties.store(key, prefix+matched+suffix)
        val = @properties.fetch(key)
    end
    #puts &amp;quot;#{key}=#{@properties[key]}&amp;quot;
    return val;
end

def get(key, default=&amp;#39;&amp;#39;)
    if(@properties.key?(key)): return @properties.fetch(key) end
    if(!default.nil?): return default end
end

def getint(key, default=0)
    self.get(key,default).to_i
end
def getfloat(key, default=0.0)
    self.get(key,default).to_f
end

alias getlong getint
alias getdouble getfloat

def getboolean(key)
    return true if self.getint(key, 0) &amp;gt; 0
    return false
end

def set(key,value)
    @properties.store(key,value)
end

def size
    @properties.size
end

def merge(props_to_be_merged, override=false)
    props_to_be_merged.each do |k,v|
        next if k.strip.empty?
        next if @properties.key?(k) and !override
        @properties.store(k, v.strip)
    end
    self
end

def import_files(override=false)
    import = self.get(&amp;quot;ncs.import&amp;quot;)
    if defined?(import) and not import.empty?
        puts &amp;quot;found import properties: #{import}&amp;quot;
        import = self._escapeprop(&amp;quot;ncs.import&amp;quot;,import)
        if not import.nil? and File.exist?(import)
            return self.merge(Properties.new.load(import,false).to_hash, override)
        end
    end
    self
end

def to_hash
    @properties
end
def keys
    @properties.keys
end
def values
    @properties.values
end
def dump
    keys = @properties.keys.sort
    keys.each do |key|
        val = self.get(key)
        puts &amp;quot;#{key}=#{val}&amp;quot;
    end
end
protected :_escapeprop,:_escapeenv,:_escapeprops
</code></pre>

<p>end</p>

<p></pre>
<br>其实还写了一版python的，也一并贴上来对比一下
<br><pre name="code"></p>

<h1>!/usr/bin/env python</h1>

<p>from ncs.core.component import Component
from ncs.exceptions import *</p>

<p>import sys
import os
import re
import logging</p>

<p>class PropertiesNotExist(Exception):
    def <strong>init</strong>(self, properties_file):
        self.properties_file = properties_file</p>

<pre><code>def __str__(self):
    return repr("properties file {0} not exist!".format(self.properties_file)) 
</code></pre>

<p>class PropertiesNotLoad(Exception):
    def <strong>init</strong>(self, properties_file):
        self.properties_file = properties_file</p>

<pre><code>def __str__(self):
    return repr("properties file {0} is not loaded!".format(self.properties_file)) 
</code></pre>

<p>class Properties(Component):
    """
    This is a python portion for java Properties file
    """</p>

<pre><code>def __init__(self):
    Component.__init__(self, 'ncs.core.properties.Properties', ['load','get','set','search'])
    self.properties_file = ''
    self.raw_properties = {}
    self.properties = {}
    self.logger = logging.getLogger(self.__class__.__name__)

def load(self, resource):
    if not os.path.exists(resource):
        self.logger.error("{0} not exists".format(resource))
        raise PropertiesNotExist(resource)

    if not os.path.isfile(resource):
        self.logger.error("{0} is not a file!".format(resource))
        raise PropertiesNotLoad(resource)

    self.properties_file = resource
    self.raw_properties = self.properties = self._parse(resource)
    #check if there is import properties or file
    import_file = self.get("ncs.import", self.get("import"))
    if import_file: 
        import_file = self._unescape_property(import_file)
        if not os.path.exists(import_file):
            self.logger.warn("import file {0} not exists".format(import_file))
            self.logger.warn("ignored import file {0}".format(import_file))
        if self.isdebugon(): print("import properties file: {0}".format(import_file)) 
        self.import_from_file(import_file)
    self._unescape_properties()
    return self.properties

def _parse(self, resource):
    props = dict()
    fp = open(resource, 'r')
    (k,v) = ('','')
    is_multi_line = False
    for line in fp.readlines():
        line = line.strip()
         #space line or commentted line will be ignored
        if len(line) == 0 or line.startswith('#'):
            continue
        #end with character(\), multi-line start line
        if not is_multi_line and line.endswith('\\'):
            is_multi_line = True
            #remove the end character(\) and split with character(=)
            (k,v) = line.replace('\\','').split('=', 1)
            continue
        if is_multi_line:
            #not end with character(\), multi-line end line
            if not line.endswith('\\'):
                v = v + ' ' + line
                props[k.strip()] = v.strip()
                k = v = ''
                is_multi_line = False
            #multi-line
            else:
                v = v + ' ' + line.replace('\\','')
            continue
        #normail line(key=value)
        (k,v) = line.replace('\\','').split('=', 1)
        if len(k.strip()) == 0:
            continue
        props[k.strip()] = v.strip()
        (k,v) = ('','')
    return props

def _unescape_property(self, value):
    #white space
    if len(value.strip()) == 0: return

    #match ${ncs.log.dir}
    extract_vars = lambda s: [v[1] for v in re.findall(r'^(.*)\${([^}]+)}(.*)$', s)]
    while extract_vars(value):
        for var in extract_vars(value):
            if self.isdebugon(): print("matched key: {0}".format(var))
            if not self.properties.has_key(var):
                print("[warn] matched key not exists: {0}".format(var))
                break
            #matched key exits
            val = self.properties.get(var)
            if self.isdebugon(): print("{0} = {1}".format(var, val))
            value = value.replace('${'+var+'}', val)


    #match $ENV{HOME}
    extract_envs = lambda s: [e[1] for e in re.findall(r'^(.*)\$ENV{([^}]+)}(.*)$', s)]
    while extract_envs(value):
        for env in extract_envs(value):
            if self.isdebugon(): print("matched environ: {0} = {1}".format(env, os.getenv(env,'')))
            value = value.replace('$ENV{'+env+'}', os.getenv(env,''))

    return value

def _unescape_properties(self):
    for (key,value) in self.properties.items():
        self.properties[key] = self._unescape_property(value)

def get(self, key, default=None):
    return self.properties.get(key, default)
def getint(self, key, default=0):
    int(self.get(key,default))
def getlong(self, key, default=0):
    long(self.get(key,default))
def getfloat(self, key, default=0.0):
    float(self.get(key,default))
def getboolean(self, key, default=False):
    value = self.get(key)
    if value: 
        return True
    return default or False
def getrange(self, key):
    result = []
    value = self.get(key)
    if value:
        for val in value.split(','):
            #val as range
            if '-' in val:
                (start,end) = val.split('-', 1)
                result.extend(range(int(start),int(end)+1))
            else:
                result.append(int(val))
    return result

def set(self, key, value=None):
    self.properties[key] = value

def search(self, keywords):
    props = {}
    for (key,value) in self.properties.items():
        if keywords in key:
            props[key] = value
    return props

def size(self):
    return len(self.properties.items())

def dump(self):
    for key in sorted(self.properties.keys()): print("{0} = {1}".format(key,self.properties.get(key)))

def import_properties(self, properties, override=False):
    for (key,value) in properties.items():
        if self.properties.has_key(key) and not override: continue 
        self.properties[key] = value

def import_from_file(self, resource, override=False):
    properties = self._parse(resource)
    self.import_properties(properties, override)
</code></pre>

<p></pre></p>

<pre><code>      &lt;br&gt;&lt;br&gt;
      &lt;span style="color:red"&gt;
        &lt;a href="http://liumaodou.iteye.com/blog/1087844#comments" style="color:red"&gt;已有 &lt;strong&gt;0&lt;/strong&gt; 人发表留言，猛击-&amp;gt;&amp;gt;&lt;strong&gt;这里&lt;/strong&gt;&amp;lt;&amp;lt;-参与讨论&lt;/a&gt;
      &lt;/span&gt;
      &lt;br&gt;&lt;br&gt;&lt;br&gt;
</code></pre>

<p><span style="color:#e28822">ITeye推荐</span>
<br></p>

<ul><li><a href="http://www.iteye.com/clicks/433"><span style="color:red;font-weight:bold">—软件人才免语言低担保 赴美带薪读研！— </span></a></li></ul>


<p><br><br><br></p>

</div>


            <div class="footer">
              <div class="contact">
                <p>
                  Your Name<br />
                  What You Are<br />
                  your@email.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/yourusername/">github.com/yourusername</a><br />
                  <a href="http://twitter.com/yourusername/">twitter.com/yourusername</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

    </body>
</html>
