<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Ajax实现无刷新任务进度条</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/">Your New Jekyll Site</a></h1>
              <a class="extra" href="/">home</a>
            </div>

                <h2>Ajax实现无刷新任务进度条</h2>
<p class="meta">15 Jan 2011</p>

<div class="post">
<h2>Ajax实现无刷新任务进度条</h2>

<h3>by Leo Young</h3>

<h3>at 2011-01-15 10:22:00</h3>

<h3>original <a href="http://www.cnblogs.com/yangleiWPF/archive/2011/01/15/1936126.html">http://www.cnblogs.com/yangleiWPF/archive/2011/01/15/1936126.html</a></h3>

<p><p>前段时间参考了别人写的<a href="http://www.cnblogs.com/lovecherry/archive/2005/04/10/135090.html">一篇关于</a>在服务器端用session保存状态，客户端用js实时刷新页面的方法获取后台线程运行的当前任务量百分比如下图：</p>
<p><img src="http://pic002.cnblogs.com/images/2011/49091/2011011509432616.png"></p>
<p>上面方法优点在于session保存的线程运算类对象页面刷新后方便获得运算对象</p>
<p>而用<span size="2" style="font-size:12px">Session["work"]=w<span style="font-size:14px">可能因为很多原因而丢失</span></span></p>
<p>用window.setTimeout('location.href=location.href',1000)刷新，但<span size="2" style="font-size:14px">在页面元素多的情况下页面不断刷新很有可能进度条一直不能显示</span></p>
<p> </p>
<p>下面是在上面的基础上去掉了用session保存线程类而是用在线程类中用静态变量保存当前任务量百分比此方法将带来线程同步问题、使用Ajax实现进度条局部刷新</p>
<p>效果如下面：</p>
<p><img src="http://pic002.cnblogs.com/images/2011/49091/2011011509504719.png"></p>
<p> 前台用Timer控件实时局部刷新。</p>
<div style="width:1441px;height:292px"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif"><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif"><span>前台代码</span>
<div>
<pre><div><span style="color:#008080"> 1</span> <span style="color:#000000">&lt;</span><span style="color:#000000">head runat</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">server</span><span style="color:#800000">"</span><span style="color:#000000">&gt;</span><span style="color:#000000"><br></span><span style="color:#008080"> 2</span> <span style="color:#000000">    </span><span style="color:#000000">&lt;</span><span style="color:#000000">title</span><span style="color:#000000">&gt;&lt;/</span><span style="color:#000000">title</span><span style="color:#000000">&gt;</span><span style="color:#000000"><br></span><span style="color:#008080"> 3</span> <span style="color:#000000">    </span><span style="color:#000000">&lt;</span><span style="color:#000000">style type</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">text/css</span><span style="color:#800000">"</span><span style="color:#000000">&gt;</span><span style="color:#000000"><br></span><span style="color:#008080"> 4</span> <span style="color:#000000">        .lblTxtCenter<br></span><span style="color:#008080"> 5</span> <span style="color:#000000">        {<br></span><span style="color:#008080"> 6</span> <span style="color:#000000">            text</span><span style="color:#000000">-</span><span style="color:#000000">align: center;<br></span><span style="color:#008080"> 7</span> <span style="color:#000000">        }<br></span><span style="color:#008080"> 8</span> <span style="color:#000000">    </span><span style="color:#000000">&lt;/</span><span style="color:#000000">style</span><span style="color:#000000">&gt;</span><span style="color:#000000"><br></span><span style="color:#008080"> 9</span> <span style="color:#000000"> </span><span style="color:#000000">&lt;/</span><span style="color:#000000">head</span><span style="color:#000000">&gt;</span><span style="color:#000000"><br></span><span style="color:#008080">10</span> <span style="color:#000000"> </span><span style="color:#000000">&lt;</span><span style="color:#000000">body</span><span style="color:#000000">&gt;</span><span style="color:#000000"><br></span><span style="color:#008080">11</span> <span style="color:#000000">    </span><span style="color:#000000">&lt;</span><span style="color:#000000">form id</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">form1</span><span style="color:#800000">"</span><span style="color:#000000"> runat</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">server</span><span style="color:#800000">"</span><span style="color:#000000">&gt;</span><span style="color:#000000"><br></span><span style="color:#008080">12</span> <span style="color:#000000">    </span><span style="color:#000000">&lt;</span><span style="color:#000000">div</span><span style="color:#000000">&gt;</span><span style="color:#000000"><br></span><span style="color:#008080">1</span></div><div><span style="color:#008080">3</span> <span style="color:#000000">        </span><span style="color:#000000">&lt;</span><span style="color:#000000">asp:ScriptManager ID</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">ScriptManager1</span><span style="color:#800000">"</span><span style="color:#000000"> runat</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">server</span><span style="color:#800000">"</span><span style="color:#000000">&gt;</span><span style="color:#000000"><br></span><span style="color:#008080">14</span> <span style="color:#000000">        </span><span style="color:#000000">&lt;/</span><span style="color:#000000">asp:ScriptManager</span><span style="color:#000000">&gt;</span><span style="color:#000000"><br></span><span style="color:#008080">15</span> <span style="color:#000000">        </span><span style="color:#000000">&lt;</span><span style="color:#000000">asp:UpdatePanel ID</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">UpdatePanel1</span><span style="color:#800000">"</span><span style="color:#000000"> runat</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">server</span><span style="color:#800000">"</span><span style="color:#000000">&gt;</span><span style="color:#000000"><br></span><span style="color:#008080">16</span> <span style="color:#000000">            </span><span style="color:#000000">&lt;</span><span style="color:#000000">ContentTemplate</span><span style="color:#000000">&gt;</span><span style="color:#000000"><br></span><span style="color:#008080">17</span> <span style="color:#000000">                </span><span style="color:#000000">&lt;</span><span style="color:#000000">div style</span><span style="color:#000000">=</span><span style="color:#800000">'</span><span style="color:#800000">width: 200px; background-color: Silver; height: 20px;</span><span style="color:#800000">'</span><span style="color:#000000">&gt;</span><span style="color:#000000"><br></span><span style="color:#008080">18</span> <span style="color:#000000">                    </span><span style="color:#000000">&lt;</span><span style="color:#000000">asp:Label runat</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">server</span><span style="color:#800000">"</span><span style="color:#000000"> ID</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">lbl</span><span style="color:#800000">"</span><span style="color:#000000"> CssClass</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">lblTxtCenter</span><span style="color:#800000">"</span><span style="color:#000000">&gt;&lt;/</span><span style="color:#000000">asp:Label</span><span style="color:#000000">&gt;&lt;/</span><span style="color:#000000">div</span><span style="color:#000000">&gt;</span><span style="color:#000000"><br></span><span style="color:#008080">19</span> <span style="color:#000000">                </span><span style="color:#000000">&lt;</span><span style="color:#000000">asp:Timer ID</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">Timer1</span><span style="color:#800000">"</span><span style="color:#000000"> runat</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">server</span><span style="color:#800000">"</span><span style="color:#000000"> Interval</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">1000</span><span style="color:#800000">"</span><span style="color:#000000"> OnTick</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">Timer1_Tick</span><span style="color:#800000">"</span><span style="color:#000000"> Enabled</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">false</span><span style="color:#800000">"</span><span style="color:#000000">&gt;</span><span style="color:#000000"><br></span><span style="color:#008080">20</span> <span style="color:#000000">                </span><span style="color:#000000">&lt;/</span><span style="color:#000000">asp:Timer</span><span style="color:#000000">&gt;</span><span style="color:#000000"><br></span><span style="color:#008080">21</span> <span style="color:#000000">                </span><span style="color:#000000">&lt;</span><span style="color:#000000">br </span><span style="color:#000000">/&gt;</span><span style="color:#000000"><br></span><span style="color:#008080">22</span> <span style="color:#000000">                </span><span style="color:#000000">&lt;</span><span style="color:#000000">asp:Button ID</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">Button1</span><span style="color:#800000">"</span><span style="color:#000000"> runat</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">server</span><span style="color:#800000">"</span><span style="color:#000000"> Text</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">开始运算</span><span style="color:#800000">"</span><span style="color:#000000"> OnClick</span><span style="color:#000000">=</span><span style="color:#800000">"</span><span style="color:#800000">Button1_Click</span><span style="color:#800000">"</span><span style="color:#000000"> </span><span style="color:#000000">/&gt;</span><span style="color:#000000"><br></span><span style="color:#008080">23</span> <span style="color:#000000">            </span><span style="color:#000000">&lt;/</span><span style="color:#000000">ContentTemplate</span><span style="color:#000000">&gt;</span><span style="color:#000000"><br></span><span style="color:#008080">24</span> <span style="color:#000000">        </span><span style="color:#000000">&lt;/</span><span style="color:#000000">asp:UpdatePanel</span><span style="color:#000000">&gt;</span><span style="color:#000000"><br></span><span style="color:#008080">25</span> <span style="color:#000000">    </span><span style="color:#000000">&lt;/</span><span style="color:#000000">div</span><span style="color:#000000">&gt;</span><span style="color:#000000"><br></span><span style="color:#008080">26</span> <span style="color:#000000">    </span><span style="color:#000000">&lt;/</span><span style="color:#000000">form</span><span style="color:#000000">&gt;</span><span style="color:#000000"><br></span><span style="color:#008080">27</span> <span style="color:#000000"> </span><span style="color:#000000">&lt;/</span><span style="color:#000000">body</span><span style="color:#000000">&gt;</span></div></pre>
</div>
</div>
<p> </p>
<p> </p>
<div style="width:1432px;height:507px"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif"><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif"><span>后台代码</span>
<div>
<pre><div><span style="color:#008080"> 1</span> <span style="color:#000000"> </span><span style="color:#0000ff">protected</span><span style="color:#000000"> </span><span style="color:#0000ff">void</span><span style="color:#000000"> Button1_Click(</span><span style="color:#0000ff">object</span><span style="color:#000000"> sender, EventArgs e)<br></span><span style="color:#008080"> 2</span> <span style="color:#000000">    {<br></span><span style="color:#008080"> 3</span> <span style="color:#000000">        </span><span style="color:#008000">//</span><span style="color:#008000">线程计算类</span><span style="color:#008000"><br></span><span style="color:#008080"> 4</span> <span style="color:#008000"> </span><span style="color:#000000">        ThreadClass cl </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#0000ff">new</span><span style="color:#000000"> ThreadClass();<br></span><span style="color:#008080"> 5</span> <span style="color:#000000">        cl.begin();<br></span><span style="color:#008080"> 6</span> <span style="color:#000000">        Timer1.Enabled </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#0000ff">true</span><span style="color:#000000">;<br></span><span style="color:#008080"> 7</span> <span style="color:#000000">    }<br></span><span style="color:#008080"> 8</span> <span style="color:#000000">    </span><span style="color:#0000ff">protected</span><span style="color:#000000"> </span><span style="color:#0000ff">void</span><span style="color:#000000"> Timer1_Tick(</span><span style="color:#0000ff">object</span><span style="color:#000000"> sender, EventArgs e)<br></span><span style="color:#008080"> 9</span> <span style="color:#000000">    {<br></span><span style="color:#008080">10</span> <span style="color:#000000"><br></span><span style="color:#008080">11</span> <span style="color:#000000">        </span><span style="color:#0000ff">if</span><span style="color:#000000"> (ThreadClass.present </span><span style="color:#000000">&lt;=</span><span style="color:#000000"> </span><span style="color:#800080">100</span><span style="color:#000000">)<br></span><span style="color:#008080">12</span> <span style="color:#000000">        {<br></span><span style="color:#008080">13</span> <span style="color:#000000">            Button1.Enabled </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#0000ff">false</span><span style="color:#000000">;<br></span><span style="color:#008080">14</span> <span style="color:#000000">            lbl.Text </span><span style="color:#000000">=</span><span style="color:#000000"> ThreadClass.present.ToString() </span><span style="color:#000000">+</span><span style="color:#000000"> </span><span style="color:#800000">"</span><span style="color:#800000">%</span><span style="color:#800000">"</span><span style="color:#000000">;<br></span><span style="color:#008080">15</span> <span style="color:#000000">            lbl.BackColor </span><span style="color:#000000">=</span><span style="color:#000000"> System.Drawing.Color.Red;<br></span><span style="color:#008080">16</span> <span style="color:#000000">            lbl.Width </span><span style="color:#000000">=</span><span style="color:#000000"> ThreadClass.present </span><span style="color:#000000">*</span><span style="color:#000000"> </span><span style="color:#800080">2</span><span style="color:#000000">;<br></span><span style="color:#008080">17</span> <span style="color:#000000">        }<br></span><span style="color:#008080">18</span> <span style="color:#000000">        </span><span style="color:#0000ff">if</span><span style="color:#000000"> (ThreadClass.present </span><span style="color:#000000">==</span><span style="color:#000000"> </span><span style="color:#800080">100</span><span style="color:#000000">)<br></span><span style="color:#008080">19</span> <span style="color:#000000">        {<br></span><span style="color:#008080">20</span> <span style="color:#000000">            ThreadClass.present </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#800080">0</span><span style="color:#000000">;<br></span><span style="color:#008080">21</span> <span style="color:#000000">            Button1.Enabled </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#0000ff">true</span><span style="color:#000000">;<br></span><span style="color:#008080">22</span> <span style="color:#000000">            Timer1.Enabled </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#0000ff">false</span><span style="color:#000000">;<br></span><span style="color:#008080">23</span> <span style="color:#000000">        }<br></span><span style="color:#008080">24</span> <span style="color:#000000">    }</span></div></pre>
</div>
</div>
<p> </p>
<p> </p>
<div style="width:1441px;height:537px"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif"><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif"><span>线程类</span>
<div>
<pre><div><span style="color:#008080"> 1</span> <span style="color:#0000ff">public</span><span style="color:#000000"> </span><span style="color:#0000ff">class</span><span style="color:#000000"> ThreadClass<br></span><span style="color:#008080"> 2</span> <span style="color:#000000">{<br></span><span style="color:#008080"> 3</span> <span style="color:#000000">    </span><span style="color:#0000ff">public</span><span style="color:#000000"> </span><span style="color:#0000ff">static</span><span style="color:#000000"> </span><span style="color:#0000ff">int</span><span style="color:#000000"> present;<br></span><span style="color:#008080"> 4</span> <span style="color:#000000">    </span><span style="color:#0000ff">public</span><span style="color:#000000"> ThreadClass()<br></span><span style="color:#008080"> 5</span> <span style="color:#000000">    {<br></span><span style="color:#008080"> 6</span> <span style="color:#000000">        <br></span><span style="color:#008080"> 7</span> <span style="color:#000000">    }<br></span><span style="color:#008080"> 8</span> <span style="color:#000000">    </span><span style="color:#0000ff">public</span><span style="color:#000000"> </span><span style="color:#0000ff">void</span><span style="color:#000000"> begin()<br></span><span style="color:#008080"> 9</span> <span style="color:#000000">    {<br></span><span style="color:#008080">10</span> <span style="color:#000000">        </span><span style="color:#0000ff">if</span><span style="color:#000000"> (present </span><span style="color:#000000">==</span><span style="color:#000000"> </span><span style="color:#800080">0</span><span style="color:#000000">)<br></span><span style="color:#008080">11</span> <span style="color:#000000">        {<br></span><span style="color:#008080">12</span> <span style="color:#000000">            </span><span style="color:#0000ff">lock</span><span style="color:#000000"> (</span><span style="color:#0000ff">this</span><span style="color:#000000">)<br></span><span style="color:#008080">13</span> <span style="color:#000000">            {<br></span><span style="color:#008080">14</span> <span style="color:#000000">                Thread tr </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#0000ff">new</span><span style="color:#000000"> Thread(</span><span style="color:#0000ff">new</span><span style="color:#000000"> ThreadStart(() </span><span style="color:#000000">=&gt;</span><span style="color:#000000"><br></span><span style="color:#008080">15</span> <span style="color:#000000">                {<br></span><span style="color:#008080">16</span> <span style="color:#000000">                    </span><span style="color:#0000ff">for</span><span style="color:#000000"> (</span><span style="color:#0000ff">int</span><span style="color:#000000"> i </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#800080">0</span><span style="color:#000000">; i </span><span style="color:#000000">&lt;=</span><span style="color:#000000"> </span><span style="color:#800080">1000</span><span style="color:#000000">; i</span><span style="color:#000000">++</span><span style="color:#000000">)<br></span><span style="color:#008080">17</span> <span style="color:#000000">                    {<br></span><span style="color:#008080">18</span> <span style="color:#000000">                        present </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#800080">100</span><span style="color:#000000"> </span><span style="color:#000000">*</span><span style="color:#000000"> i </span><span style="color:#000000">/</span><span style="color:#000000"> </span><span style="color:#800080">1000</span><span style="color:#000000">;</span><span style="color:#008000">//</span><span style="color:#008000">计算已完成的百分比  </span><span style="color:#008000"><br></span><span style="color:#008080">19</span> <span style="color:#008000"> </span><span style="color:#000000">                        Thread.Sleep(</span><span style="color:#800080">10</span><span style="color:#000000">);<br></span><span style="color:#008080">20</span> <span style="color:#000000">                    }<br></span><span style="color:#008080">21</span> <span style="color:#000000">                }));<br></span><span style="color:#008080">22</span> <span style="color:#000000">                tr.IsBackground </span><span style="color:#000000">=</span><span style="color:#000000"> </span><span style="color:#0000ff">true</span><span style="color:#000000">;<br></span><span style="color:#008080">23</span> <span style="color:#000000">                tr.Start();<br></span><span style="color:#008080">24</span> <span style="color:#000000">            }<br></span><span style="color:#008080">25</span> <span style="color:#000000">        }<br></span><span style="color:#008080">26</span> <span style="color:#000000">    }<br></span><span style="color:#008080">27</span> <span style="color:#000000">}</span></div></pre>
</div>
</div>
<p> </p>
<p> </p>
<p> </p><img src="http://www.cnblogs.com/yangleiWPF/aggbug/1936126.html?type=1" width="1" height="1" alt=""><p>作者: <a href="http://www.cnblogs.com/yangleiWPF/">Leo Young</a> 发表于 2011-01-15 10:22 <a href="http://www.cnblogs.com/yangleiWPF/archive/2011/01/15/1936126.html">原文链接</a></p><p>评论: 5　<a href="http://www.cnblogs.com/yangleiWPF/archive/2011/01/15/1936126.html#pagedcomment">查看评论</a>　<a href="http://www.cnblogs.com/yangleiWPF/archive/2011/01/15/1936126.html#commentform">发表评论</a></p><hr><p>最新新闻：<br>· <a href="http://news.cnblogs.com/n/88395/">愤怒的小鸟如何赢得世界</a><span style="color:gray">(2011-01-15 11:49)</span><br>· <a href="http://news.cnblogs.com/n/88394/">Firefox 4 Beta 9发布</a><span style="color:gray">(2011-01-15 10:59)</span><br>· <a href="http://news.cnblogs.com/n/88393/">纽约的地下科学家：让科学变潮</a><span style="color:gray">(2011-01-15 10:44)</span><br>· <a href="http://news.cnblogs.com/n/88392/">长春幻日奇观“3个太阳”同现天空</a><span style="color:gray">(2011-01-15 10:33)</span><br>· <a href="http://news.cnblogs.com/n/88391/">Google Apps重大调整：不再允许定期宕机维护</a><span style="color:gray">(2011-01-15 10:31)</span><br></p><p>编辑推荐：<a href="http://www.cnblogs.com/JeffreyZhao/archive/2011/01/14/be-clear-with-language-spec-and-platform-implementation-dotnet-cross-platform.html">分清“语言/规范”以及“平台/实现”，以及跨平台.NET开发</a><br></p><p>网站导航：<a href="http://www.cnblogs.com">博客园首页</a>  <a href="http://home.cnblogs.com/">我的园子</a>  <a href="http://news.cnblogs.com">新闻</a>  <a href="http://home.cnblogs.com/ing/">闪存</a>  <a href="http://home.cnblogs.com/group/">小组</a>  <a href="http://space.cnblogs.com/q/">博问</a>  <a href="http://kb.cnblogs.com">知识库</a></p></p>


</div>


            <div class="footer">
              <div class="contact">
                <p>
                  Your Name<br />
                  What You Are<br />
                  your@email.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/yourusername/">github.com/yourusername</a><br />
                  <a href="http://twitter.com/yourusername/">twitter.com/yourusername</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

    </body>
</html>
